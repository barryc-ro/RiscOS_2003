#!/bin/sh
#
# Baseline Server Support Software Installation
# $Id$
#
# Copyright (C) Pace Micro Technology plc. 2000
# All rights reserved
#

# The program which will perform the installation.
INSTALL=install

# Path to the inetd configuration file
INETDCONF=/etc/inetd.conf

# Where binaries are installed, and the TFTP root
# directory.  You should not alter these.
BINDIR=/usr/local/bin
TFTPBOOT=/tftpboot

# The name of the TFTP server configuration file and
# the Solaris autostart file.
CONFIG=mtftpd.conf
RCFILE=mtftpd.sh

# Install with owner UID and group GID, using the modes
# specified for files/directories as appropriate
IUID=bin
IGID=bin
FILEMODE=644
PROGMODE=755
DIRMODE=2755

# Create backups of existing configuration files if necessary
if [ -r $TFTPBOOT/etc/$CONFIG ]; then
 mv -f $TFTPBOOT/etc/$CONFIG $TFTPBOOT/etc/$CONFIG.old
 echo Old configuration file renamed as $TFTPBOOT/etc/$CONFIG.old
fi

# Create the TFTP base directory if necessary and install
# the configuration file in it.
$INSTALL -u $IUID -g $IGID -m $DIRMODE -d $TFTPBOOT
$INSTALL -u $IUID -g $IGID -m $DIRMODE -d $TFTPBOOT/etc
$INSTALL -u $IUID -g $IGID -m $FILEMODE -c $TFTPBOOT/etc $CONFIG

# Ensure that the binary directory is present
$INSTALL -u $IUID -g $IGID -m $DIRMODE -d $BINDIR

# Now install the perl scripts and the compiled binaries
$INSTALL -u $IUID -g $IGID -m $PROGMODE -c $BINDIR blconf
$INSTALL -u $IUID -g $IGID -m $PROGMODE -c $BINDIR blbuild
$INSTALL -u $IUID -g $IGID -m $PROGMODE -c $BINDIR modgen
$INSTALL -u $IUID -g $IGID -m $PROGMODE -c $BINDIR modsqz
$INSTALL -u $IUID -g $IGID -m $PROGMODE -c $BINDIR mtftpd
$INSTALL -u $IUID -g $IGID -m $PROGMODE -c $BINDIR unmodsqz

# Now install the autostart script into the Solaris autoboot
# script so that the server starts when run level 3 is entered
# (multi-user with networking)
#
if [ "`uname -s`" = "Linux" ];
then
  $INSTALL -u $IUID -g $IGID -m $PROGMODE $RCFILE /etc/rc3.d
else
  $INSTALL -u $IUID -g $IGID -m $PROGMODE -c /etc/init.d $RCFILE
fi

# Set up init links
test -r /etc/rc3.d/S94mtftpd && rm -f /etc/rc3.d/S94mtftpd
test -r /etc/rc0.d/K04mtftpd && rm -f /etc/rc3.d/K04mtftpd
ln -s /etc/init.d/$RCFILE /etc/rc3.d/S94mtftpd
ln -s /etc/init.d/$RCFILE /etc/rc0.d/K04mtftpd

# Set up the link for the configuration file.
echo Creating softlink for configuration file.
test -r /etc/$CONFIG && rm -f /etc/$CONFIG
ln -s $TFTPBOOT/etc/$CONFIG /etc/$CONFIG

TFTP=`grep '^tftp' $INETDCONF`
if [ "$TFTP" <> "" ]; then
  cp $INETDCONF $INETDCONF.pace && \
  sed 's/^tftp/\#Disabled by Pace baseline server software installation script\
\#tftp/' <$INETDCONF.pace >$INETDCONF && \
  echo Built-in TFTP service disabled - old $INETDCONF stored as $INETDCONF.pace
fi


