/* Copyright (c) 1996 by Oracle Corporation. All Rights Reserved.
 *
 * srvinstall.c - win32 service installation program
 *
 * MODIFIED
 * syen    02/20/96 - Creation.
 */

#include <windows.h>
#include <stdio.h>


static void ErrorHandler(char *s, int err)
{
  char errmsg[128];
  
  if (!FormatMessage(FORMAT_MESSAGE_FROM_SYSTEM, NULL, err, 0x0409,
                     errmsg, sizeof(errmsg), NULL))
    sprintf(errmsg, "GetLastError() = %d", err);
  printf("%s", errmsg);
  exit (err);
}

void main(int argc, char **argv)
{
  SC_HANDLE newService, scm;
  char depends[80];

  if (argc < 3 || argc > 4)
  {
    printf("usage: svcinstall svc_name svc_executable [svc_dependency]\n");
    return;
  }

  scm = OpenSCManager(0, 0, SC_MANAGER_CREATE_SERVICE);
  if (!scm)
    ErrorHandler("In OpenScManager", GetLastError());

  if (argc == 4)
  {
    int end = strlen(argv[3]);

    strcpy(depends, argv[3]);
    depends[end+1] = '\0';
    depends[end+2] = '\0';
  }
  else
    depends[0] = '\0';

  /* install the new service */
  newService = CreateService(scm, argv[1], argv[1], 
                             SERVICE_ALL_ACCESS,
                             SERVICE_WIN32_OWN_PROCESS,
                             SERVICE_DEMAND_START,
                             SERVICE_ERROR_NORMAL,
                             argv[2],              /* c:\winnt\xxx.exe */
                             0, 0, depends, 0, 0);
  if (!newService)
    ErrorHandler("In CreateService", GetLastError());
  else
    printf("Service installed\n");

  /* clean up */
  CloseServiceHandle(newService);
  CloseServiceHandle(scm);
}

