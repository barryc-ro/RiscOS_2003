/* Copyright (c) 1996 by Oracle Corporation. All Rights Reserved.
 *
 * svcremove.c - win32 service remove program
 *
 * MODIFIED
 * syen    02/20/96 - Creation.
 */

#include <windows.h>
#include <stdio.h>

static void ErrorHandler(char *s, int err)
{
  char errmsg[128];
  
  if (!FormatMessage(FORMAT_MESSAGE_FROM_SYSTEM, NULL, err, 0x0409,
                     errmsg, sizeof(errmsg), NULL))
    sprintf(errmsg, "GetLastError() = %d", err);
  printf("%s", errmsg);
  exit (err);
}

void main(int argc, char **argv)
{
  SC_HANDLE service, scm;
  SERVICE_STATUS status;

  if (argc != 2)
  {
    printf("usage: svcremove service_name\n");
    return;
  }

  scm = OpenSCManager(0, 0, SC_MANAGER_CREATE_SERVICE);
  if (!scm)
    ErrorHandler("In OpenScManager", GetLastError());

  /* install the new service */
  service = OpenService(scm, argv[1], SERVICE_ALL_ACCESS | DELETE);
                           
  if (!service)
    ErrorHandler("In OpenService", GetLastError());
  
  /* stop the service if necessary */
  if (!QueryServiceStatus(service, &status))
    ErrorHandler("In QueryServiceStatus", GetLastError());

  if (status.dwCurrentState == SERVICE_RUNNING)
  {
    printf("please stop the service before removing it\n");
    goto cleanup;
  }

  if (DeleteService(service))
    printf("Service removed\n");
  else
    ErrorHandler("In DeleteService", GetLastError());

  /* clean up */
cleanup:
  CloseServiceHandle(service);
  CloseServiceHandle(scm);
}
