/**************************************
 Sink.h
	
descibes standard decoder class.

In this case the MPEGTrans Module

© Acorn Computers Ltd

History:

Date      Who     Description of change
===========================================
31/7/98    AR      File created

**************************************/
#ifndef _Sink_H_
#define _Sink_H_

#include "Error.h"

//#ifdef DEBUG
//#define OUTPUT_FILE
//#endif

class  Bitstream_buffer_descriptor{
  
  public:	// this structure is defined by the MPEG modules.
  
  Bitstream_buffer_descriptor	*link; 
  				// set to zero as we are passing one at a time
  int	free_routine;           // callback address
  int	free_workspace;		
  char	*buffer_start_address;	// as returned in get_block
  int	buffer_length;		// >= datagram,  < block
  int	packets;		// set to zero on call to full buffers
  
  Bitstream_buffer_descriptor(void);
  ~Bitstream_buffer_descriptor(void);
};

/*
It is debatable as to whether the next block should exist in the
header or the methods file.  These are C constructs used in talking
to the MPEGControl/Trans Module.  These structures were taken from
an existing VSP module.
*/
//SWI Numbers
#define MPEGControl_FullBuffers  0x492c1
#define MPEGControl_SetSpeed	 0x492c3
#define MPEGControl_ResetStream  0x492c5
#define MPEGControl_MuteSound    0x492c6
#define MPEGControl_Stats        0x492c9

//Stats Tag Numbers
#define MPEGControl_Stats_BytesRx 0x0000
#define MPEGControl_Stats_NPT     0x0009

//MPEGControl defined tokens
#define ENDOFTAGS -1		// end of stats tagtype array for readstats
 	// ResetStream stuff
#define VIDEODATA 1      	// video data present in new stream
#define AUDIODATA 1 << 1 	// audio data present in new stream
 	// MuteSound stuff
#define SOUNDOFF  0x0
#define SOUNDON   0x1

//MPEGControl defined structures
#define DefaultBufferSize 20	// this is the opening buffer size
#define MPEGClockSpeed 	  90000 // represents a 90 kHz clock

typedef struct StatsRtn_S{
   int Tag;
   int DataLength; 
   int Data;    		// varying array of statistical information
} StatBuffer;

typedef int tagtype;

/****************************************************************************/

class Sink: public Error
{
  /*
  This is primerily a method class but in effect firewalls
  however it does contain a unique MPEGHandle as is given by
  the MPEGTrans module.  This should contain objects such as
  start stream etc.  Though this handle is passed through the 
  SWI interface.
  */
  private:
  int MPEGHandle;
  StatBuffer *readstats(tagtype tag, int *BufferSize);	// Null on error
  StatBuffer *readstats(tagtype *tags, int *BufferSize);	
  				// allocates StatBuffer or increases to 
  				// accomodate stats
  public:
  Sink(int Handle);
  ~Sink(void);
  
  int FullBuffer(Bitstream_buffer_descriptor *buffer);	
  				// sends a buffer to the MPEG player
  int DropBuffers(void);
  
  int GetHandle(void);		// returns a copy of the handle
  int ReadNPT(int *time);	// sets the current time since start of play
  int CheckEOS(void);		// returns boolean
  int OpenStream(void);	  	// play, should really be constructor
  int CloseStream(void);	// stop, should be destructor
  int SetPosition(int time);	// jump to time absolute
  int SetSpeed(int speed);	// prime the decoder to handle the new speed
};

#endif
