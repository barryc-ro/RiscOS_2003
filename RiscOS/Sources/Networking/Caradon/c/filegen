#include <ctype.h>
#include <stdio.h>
#include <string.h>

#include "defs.h"
/* #include "inlines.h" */
#include "screen.h"
#include "smartcard.h"
#include "swis.h"

#include "Sockets/in.h"

ErrorPtr err;

#ifdef MODEM
extern char *enternnpc, *proceed, *proceedc;
#else
extern char *enternpc;
#endif

extern BOOL redial;

extern void osmodfree(char *);
extern char *osmodget(int);
extern char *cmos_number(void);
extern int  ncregenq(char *, void *, int);
extern void oscli(char *);

typedef struct
{
  unsigned int cntrl;
  char *string;
  void *next;
} script_list;

BOOL CreateFiles(carddata *scard)
{
  FILE *out;
  int scstatus;
#ifdef MODEM
  char buffer[512], dns2[80];
  int big, byte;
  struct in_addr ina, inb;
#endif

  _swix(NCRegistry_Status, _OUT(0), &scstatus);
  if ((scstatus & 0x05) == 0) /* No Card or not valid */
  {
    if ((screen_size.x >> screen_eig.x) >= 1024)
    {
      NewPage("file:/WWWRoot:InsertCVB");
    }
    else if ((screen_size.x >> screen_eig.x) >= 800)
    {
      NewPage("file:/WWWRoot:InsertCB");
    }
    else
    {
      NewPage("file:/WWWRoot:InsertC");
    }
    return(FALSE);
  }
 if ((scstatus & 0x10) != 0) /* Card Locked */
  {
    NewPage("file:/WWWRoot:EnterC");
    return(FALSE);
  }
  if (_swix(OS_File, _IN(0) | _IN(1) | _IN(4), 8, "<Wimp$ScrapDir>", 75))
    return(FALSE);
  if (_swix(OS_File, _IN(0) | _IN(1) | _IN(4), 8, "<Wimp$ScrapDir>.Sennen", 75))
    return(FALSE);
#ifdef MODEM
  if (_swix(OS_File, _IN(0) | _IN(1) | _IN(4), 8, "<Wimp$ScrapDir>.Sennen.Files", 75))
    return(FALSE);
  if (_swix(OS_File, _IN(0) | _IN(1) | _IN(4), 8, "<Wimp$ScrapDir>.Sennen.Files.PPP", 75))
    return(FALSE);

  ncregenq("LOGIN_ID", scard->loginid, 40);
  ncregenq("LOGIN_SECRET", scard->loginsecret, 40);

  if (!redial)
  {
    ncregenq("DNS_PRIMARY", &ina.s_addr, 16);
    ncregenq("DNS_BACKUP", &inb.s_addr, 16);
    if (inb.s_addr == 0)
      inb.s_addr = ina.s_addr;
    strcpy(dns2, inet_ntoa(inb));
    sprintf(buffer, "Set Inet$Resolvers %s %s", inet_ntoa(ina), dns2);
    oscli(buffer);
    ncregenq("ISP_DOMAIN", dns2, 80);
    sprintf(buffer, "Set Inet$LocalDomain %s", dns2);
    oscli(buffer);
    strcpy(dns2, scard->loginid);
    {
      char *c = dns2;
  
      while(*c)
      {
        if (!isalnum(*c) && *c != '_')
          *c = '_';
        c++;
      }
    }
    sprintf(buffer, "Set Inet$HostName %s", dns2);
    oscli(buffer);
    _swix(OS_Module, _IN(0) | _IN(1), 3, "Resolver");
  }
  if (out = fopen("<Wimp$ScrapDir>.Sennen.Files.PPP.Options", "w"), out)
  {
    fprintf(out, "ModemCard:0\n115200\nname %s\nnoipdefault\n", scard->loginid);
    if (ncregenq("STATIC_IP", &ina.s_addr, 16), ina.s_addr)
      fprintf(out, "%s:\n", inet_ntoa(ina));
    fprintf(out, "defaultroute\nmodem\ncrtscts\n");
    fprintf(out, "asyncmap 0\nmtu 296\nmru 296\n");
    _swix(OS_Byte, _IN(0) | _IN(1) | _OUT(2), 161, 0xA2, &byte);
    if (byte & 0x3F)
      fprintf(out, "idle-disconnect %d\n", (byte & 0x3F) * 60);
    fclose(out);
  }
  else
  {
    return(FALSE);
  }
  if (out = fopen("<Wimp$ScrapDir>.Sennen.Files.Script", "w"), out)
  {
    char *scrbuff;
    script_list *list;

    big = ncregenq("SEND_EXPECT", buffer, 0);
    if (scrbuff = osmodget(big + 10), scrbuff == NULL)
    {
      fclose(out);
      return(FALSE);
    }

    ncregenq("SEND_EXPECT", scrbuff, big + 10);
    for (list = (script_list *) scrbuff; list != NULL; list = list->next)
    {
      if ((list->cntrl & 0xFF) < 3)
        fprintf(out, "%s\n", list->string ? list->string : "");
    }
    osmodfree(scrbuff);

    fclose(out);
  }
  else
  {
    return(FALSE);
  }
  if (out = fopen("<Wimp$ScrapDir>.Sennen.Files.PPP.PAPSecrets", "w"), out)
  {
    fprintf(out, "%s * %s\n", scard->loginid, scard->loginsecret); 
    fclose(out);
  }
  else
  {
    return(FALSE);
  }
  if (out = fopen("<Wimp$ScrapDir>.Sennen.Files.PPP.CHAPSecret", "w"), out)
  {
    fprintf(out, "%s * %s\n", scard->loginid, scard->loginsecret); 
    fclose(out);
  }
  else
  {
    return(FALSE);
  }
  if (out = fopen("<Wimp$ScrapDir>.Sennen.EnterNNPC", "w"), out)
  {
    ncregenq("PSTN_NUM", scard->pstnnum, 40);
    fprintf(out, enternnpc, scard->pstnnum, scard->loginid, scard->loginsecret);
    fclose(out);
    _swix(OS_File, _IN(0) | _IN(1) | _IN(2), 18, "<Wimp$ScrapDir>.Sennen.EnterNNPC", 0xFAF);
  }
  else
  {
    return(FALSE);
  }
  if (out = fopen("<Wimp$ScrapDir>.Sennen.Proceed", "w"), out)
  {
    fprintf(out, proceed, scard->loginid);
    fclose(out);
    _swix(OS_File, _IN(0) | _IN(1) | _IN(2), 18, "<Wimp$ScrapDir>.Sennen.Proceed", 0xFAF);
  }
  else
  {
    return(FALSE);
  }
  if (out = fopen("<Wimp$ScrapDir>.Sennen.ProceedC", "w"), out)
  {
    fprintf(out, proceedc, scard->loginid);
    fclose(out);
    _swix(OS_File, _IN(0) | _IN(1) | _IN(2), 18, "<Wimp$ScrapDir>.Sennen.ProceedC", 0xFAF);
  }
  else
  {
    return(FALSE);
  }
#else
#if FALSE
  ncregenq("DNS_PRIMARY", &ina.s_addr, 16);
  ncregenq("DNS_BACKUP", &inb.s_addr, 16);
  strcpy(dns2, inet_ntoa(inb));
  sprintf(buffer, "Set Inet$Resolvers %s %s", inet_ntoa(ina), dns2);
  oscli(buffer);
#endif
  ncregenq("LOGIN_ID", scard->loginid, 40);
  ncregenq("LOGIN_SECRET", scard->loginsecret, 40);

  if (out = fopen("<Wimp$ScrapDir>.Sennen.EnterNPC", "w"), out)
  {
    ncregenq("PSTN_NUM", scard->pstnnum, 40);
    fprintf(out, enternpc, scard->loginid, scard->loginsecret);
    fclose(out);
    _swix(OS_File, _IN(0) | _IN(1) | _IN(2), 18, "<Wimp$ScrapDir>.Sennen.EnterNPC", 0xFAF);
  }
  else
  {
    return(FALSE);
  }
#endif
  return(TRUE);
}
