#include <ctype.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "defs.h"
#include "smartcard.h"
#include "swis.h"

#include "sys/types.h"
#include "netinet/in.h"
#include "arpa/inet.h"

ErrorPtr err;

extern BOOL redial;
extern BOOL silent;

extern void osmodfree(char *);
extern char *osmodget(int);
extern char *cmos_number(void);
extern int  MAM_Enq(char *, void *, int);
extern void oscli(char *);

typedef struct
{
  unsigned int cntrl;
  char *string;
  void *next;
} script_list;

char *quote(char *in, char *out)
{
  char c;
  int inl = 0, outl = 0;

  do
  {
    c = in[inl];

    switch (c)
    {
    case '<':
      inl++;
      out[outl++] = '&';
      out[outl++] = 'l';
      out[outl++] = 't';
      out[outl++] = ';';
      break;

    case '>':
      inl++;
      out[outl++] = '&';
      out[outl++] = 'g';
      out[outl++] = 't';
      out[outl++] = ';';
      break;

    case '&':
      inl++;
      out[outl++] = '&';
      out[outl++] = 'a';
      out[outl++] = 'm';
      out[outl++] = 'p';
      out[outl++] = ';';
      break;

    case '"':
      inl++;
      out[outl++] = '&';
      out[outl++] = 'q';
      out[outl++] = 'u';
      out[outl++] = 'o';
      out[outl++] = 't';
      out[outl++] = ';';
      break;

    default:
      out[outl++] = in[inl++];
      break;
    }
  } while (c);
  
  return(out);
}

BOOL CreateFiles(carddata *scard)
{
  BOOL exitstat = FALSE;
  FILE *out;
  int scstatus, length;
  char *ht_id = NULL, *ht_pw = NULL;
  char buffer[512], dns2[80], *ht_num = NULL; 
  int big, byte;
  struct in_addr ina, inb;

#if FALSE
  _swix(NCRegistry_Status, _OUT(0), &scstatus);
  if ((scstatus & 0x05) == 0) /* No Card or not valid */
  {
    goto genexit;
  }
 if ((scstatus & 0x10) != 0) /* Card Locked */
  {
    goto genexit;
  }
#endif
  if (_swix(OS_File, _INR(0, 1) | _IN(4), 8, "<Wimp$ScrapDir>", 75))
    goto genexit;
  if (_swix(OS_File, _INR(0, 1) | _IN(4), 8, "<Wimp$ScrapDir>.NCDialler", 75))
    goto genexit;
  if (_swix(OS_File, _INR(0, 1) | _IN(4), 8, "<Wimp$ScrapDir>.NCDialler.Files", 75))
    goto genexit;
  if (_swix(OS_File, _INR(0, 1) | _IN(4), 8, "<Wimp$ScrapDir>.NCDialler.Files.PPP", 75))
    goto genexit;

  if (scard->loginid)
    free(scard->loginid);
  length = MAM_Enq("LOGIN_ID", scard->loginid, 0);
  if (!silent)
    fprintf(stderr, "loginid length %d\n", length);
  scard->loginid = malloc(length + 4);
  if (length == 0 || scard->loginid == NULL)
  {
    goto genexit;
  }
  MAM_Enq("LOGIN_ID", scard->loginid, length + 2);
  ht_id = malloc(3 * length + 4);
  if (ht_id == NULL)
  {
    goto genexit;
  }
  quote(scard->loginid, ht_id);
  if (!silent)
    fprintf(stderr, "loginid %s\n", ht_id);

  if (scard->loginsecret)
    free(scard->loginsecret);
  length = MAM_Enq("LOGIN_SECRET", scard->loginsecret, 0);
  if (!silent)
    fprintf(stderr, "loginsecret length %d\n", length);
  scard->loginsecret = malloc(length + 4);
  if (length == 0 || scard->loginsecret == NULL)
  {
    goto genexit;
  }
  MAM_Enq("LOGIN_SECRET", scard->loginsecret, length + 2);
  ht_pw = malloc(3 * length + 4);
  if (ht_pw == NULL)
  {
    goto genexit;
  }
  quote(scard->loginsecret, ht_pw);
  if (!silent)
    fprintf(stderr, "loginsecret %s\n", ht_pw);

  if (scard->pstnnum)
    free(scard->pstnnum);
  length = MAM_Enq("PSTN_NUM", scard->pstnnum, 0);
  if (!silent)
    fprintf(stderr, "pstnnum length %d\n", length);
  scard->pstnnum = malloc(length + 4);
  if (length == 0 || scard->pstnnum == NULL)
  {
    goto genexit;
  }
  MAM_Enq("PSTN_NUM", scard->pstnnum, length + 2);
  ht_num = malloc(3 * length + 4);
  if (ht_num == NULL)
  {
    goto genexit;
  }
  quote(scard->pstnnum, ht_num);
  if (!silent)
    fprintf(stderr, "pstnnum %s\n", ht_num);
#if FALSE
  if (!redial)
  {
    MAM_Enq("DNS_PRIMARY", &ina.s_addr, 16);
    MAM_Enq("DNS_BACKUP", &inb.s_addr, 16);
    if (inb.s_addr == 0)
      inb.s_addr = ina.s_addr;
    strcpy(dns2, inet_ntoa(inb));
    sprintf(buffer, "Set Inet$Resolvers %s %s", inet_ntoa(ina), dns2);
    oscli(buffer);
    MAM_Enq("ISP_DOMAIN", dns2, 80);
    sprintf(buffer, "Set Inet$LocalDomain %s", dns2);
    oscli(buffer);
    strcpy(dns2, scard->loginid);
    {
      char *c = dns2;
  
      while(*c)
      {
        if (!isalnum(*c) && *c != '_')
          *c = '_';
        c++;
      }
    }
    sprintf(buffer, "Set Inet$HostName %s", dns2);
    oscli(buffer);
    oscli("ResolverConfig");
  }
#endif  
  if (out = fopen("<Wimp$ScrapDir>.NCDialler.Files.PPP.Options", "w"), out)
  {
    fprintf(out, "ModemCard:0\n115200\nname %s\nnoipdefault\n", scard->loginid);
    if (MAM_Enq("STATIC_IP", &ina.s_addr, 16), ina.s_addr)
      fprintf(out, "%s:\n", inet_ntoa(ina));
    fprintf(out, "defaultroute\nmodem\ncrtscts\n");
    fprintf(out, "asyncmap 0\nmtu 296\nmru 296\n");
    _swix(OS_Byte, _IN(0) | _IN(1) | _OUT(2), 161, 0xA2, &byte);
    if (byte & 0x3F)
      fprintf(out, "idle-disconnect %d\n", (byte & 0x3F) * 60);
    fclose(out);
  }
  else
  {
    goto genexit;
  }
  if (out = fopen("<Wimp$ScrapDir>.NCDialler.Files.Script", "w"), out)
  {
    char *scrbuff;
    script_list *list;

    big = MAM_Enq("SEND_EXPECT", buffer, 0);
    if (big > 0)
    {
      if (scrbuff = osmodget(big + 10), scrbuff == NULL)
      {
        fclose(out);
        goto genexit;
      }
  
      MAM_Enq("SEND_EXPECT", scrbuff, big + 10);
      for (list = (script_list *) scrbuff; list != NULL; list = list->next)
      {
        if ((list->cntrl & 0xFF) < 3)
          fprintf(out, "%s\n", list->string ? list->string : "");
      }
      osmodfree(scrbuff);
    }
    fclose(out);
  }
  else
  {
    exitstat = FALSE;
    goto genexit;
  }
  if (out = fopen("<Wimp$ScrapDir>.NCDialler.Files.PPP.PAPSecrets", "w"), out)
  {
    fprintf(out, "%s * %s\n", scard->loginid, scard->loginsecret); 
    fclose(out);
  }
  else
  {
    goto genexit;
  }
  if (out = fopen("<Wimp$ScrapDir>.NCDialler.Files.PPP.CHAPSecret", "w"), out)
  {
    fprintf(out, "%s * %s\n", scard->loginid, scard->loginsecret); 
    fclose(out);
  }
  else
  {
    goto genexit;
  }
  exitstat = TRUE;

genexit:
  if (ht_id)
    free(ht_id);
  if (ht_pw)
    free(ht_pw);
  if (ht_num)
    free(ht_num);

  return(exitstat);
}
