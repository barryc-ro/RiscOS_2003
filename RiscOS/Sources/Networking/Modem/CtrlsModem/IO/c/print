/****************************************************************************
/
/   Copyright 1988, 1989, 1990, 1991, 1992, 1993, 1994.  All Rights 
/   Reserved by: 
/   RSA 
/   7701 Six Forks Road 
/   Suite 120 
/   Raleigh, NC  27615 
/   (919) 846-7171 
/
/   This document contains material confidential to RSA. Its contents 
/   must not be revealed, used or disclosed to anyone or company without 
/   written permission by RSA. The information contained herein is solely 
/   for the use of RSA. 
/
/   File:                print.c
/
/   Module Version: 
/
/   Function: 
/
/   Product: 
/
/   -----------------------------------------------------------
/   -                       Modifications                     -
/   -----------------------------------------------------------
/
/   Author & Date:     RSA 
/   Description: 
/   Reason: 
/
****************************************************************************/

/* Some general functions */
#include "sys_def.h"

/* Local Prototypes */
void TraceInit(void);
void PrintIt(unsigned char *);
void outchar(unsigned char);



#define UARTBASE     0x000B0000L
#define DLL_REG      (UARTBASE + 0x00 )
#define DLM_REG      (UARTBASE + 0x01 )
#define THR_REG      (UARTBASE + 0x00 )
#define FCR_REG      (UARTBASE + 0x02 )
#define LCR_REG      (UARTBASE + 0x03 )
#define MCR_REG      (UARTBASE + 0x04 )
#define LSR_REG      (UARTBASE + 0x05 )
#define XMTR_EMPTY   0x20

#define B19200       0x0C
#define B38400       0x06
#define B57600       0x04
#define B115200      0x02
#define BAUD_RATE    B38400

void TraceInit(void)
{
   *(ubyte *)LCR_REG |= 0x80;          /* Enable DLAB */
   *(ubyte *)DLM_REG = 0;
   *(ubyte *)DLL_REG = BAUD_RATE;
   *(ubyte *)LCR_REG &= ~0x80;         /* Disable DLAB */

   *(ubyte *)LCR_REG = 0x03;           /* Set to 8-N-1               */
   *(ubyte *)FCR_REG = 0x00;           /* Disable FIFO and Flush     */
   *(ubyte *)MCR_REG = 0x07;           /* Set OUT1 + RTS + DTR -> ON */

   PrintIt( (ubyte *)"Trace Initialized!" );
}

void PrintIt( unsigned char *str )
{
   while( *str != NULL )
   {
      outchar( *str );
      str++;
   }
}

void outchar( unsigned char data )
{
   volatile ubyte lsr_reg; /* Stop optimizer */

#if 0
   return; /* turn OFF trace */
#endif

   /* Musket DUART is memory mapped @ 0xB0000 */

   /* Write data into UART TX Register (THR) */
   *(ubyte *)UARTBASE = data;

   /*
      Read UART Line Status Register (LSR) waiting
      for Xmitr to empty .
   */
   while( 1 )
   {
       lsr_reg = *(ubyte *)LSR_REG;
       if( lsr_reg & XMTR_EMPTY )
           break;
   }
}

