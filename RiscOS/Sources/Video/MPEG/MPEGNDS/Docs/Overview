
Use cases:

  * Module initialisation:
    Claim and initialise workspace
    Send MPEG NDS initialise service call

  * Module finalisation
    Send MPEG NDS finalise service call
    Deregister all handlers
    Release any/all handler buffers
    Free workspace

  * Module service call
    -> Service_MPEGControlStarting
       Sub-reason MPEGControl init:
         Release any/all handler buffers
         Claim and initialise buffer for descriptor handler
         Link buffer in at head of buffer list
         Register a descriptor handler with MPEG control
       Sub-reason MPEGControl final:
         Release any/all handler buffers

  * Verifier calls SWI MPEGNDS_SetCASID
    MPEG NDS converts CAS ID into an AND and an EOR mask for the ?descriptor? handler
    Both masks are stored in the module workspace
    Deregister all handlers
    Release any/all handler buffers
    Claim and initialise buffer for descriptor handler
    Link buffer in at head of buffer list
    Register a descriptor handler with MPEG control


Routines:

* Deregister stream:
  Given buffer, deregister payload, program element and descriptor handlers
  as appropriate.

* Tidy stream:
  Deregister stream;
  Delink buffer from linked list;
  Free buffer.

* Deregister all:
  Traverse buffer list:
    Deregister stream.

* Tidy all:
  Traverse buffer:
    Tidy stream.


Verifier calls CASID SWI to register a CA_system_ID.
MPEG NDS converts it into an AND and an EOR mask for handler (stores in workspace).

Verifier registers the handler functions with MPEG NDS.

MPEG NDS records info from base of SVC stack for calling C functions.

Do we only register handlers when a stream opens?

MPEG NDS registers as a Descriptor Handler to get the ECM PID.

 - what buffer size is required for Descriptor Handler?

If we get an OpenStream event from the Descriptor Handler and the CASID has not yet
been set, MPEG NDS returns an error to deactivate the handler on this stream.

Once we've got an ECM PID, we can register as a Program Element Handler.

 - what buffer size is required for Program Element Handler?

Once we've accumulated one complete ECM and passed it on to the Verifier, we can
register as a Payload Handler.

 - what buffer size is required for Payload Handler?

Every time data comes in on a certain handler, we append it onto our buffer.

When the buffer is full (or we have all of the data), we send it on to the
Verifier and reset the buffer to empty.

When a stream closes, we deregister the handlers?

--

Buffer format:

 0   Control stream handle
 4   Prev pointer (null if this is head item)
 8   Next pointer (null if this is tail item)
 12  Descriptor handler buffer offset (from base of it's buffer)
 16  Descriptor handler buffer
 20  Program element handler buffer offset (from base of it's buffer)
 24  Program element handler buffer
 28  Payload handler buffer offset (from base of it's buffer)
 32  Buffers...
  .  <- descriptor handler buffer
  .
  .  <- program element handler buffer
  .
  .  <- payload handler buffer
  .
 = ? bytes

If the buffer offsets are -1, this indicates that the corresponding
handler has not been registered with MPEGControl yet.

