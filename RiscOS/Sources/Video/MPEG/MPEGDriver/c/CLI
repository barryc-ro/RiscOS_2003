/******	CLI.c **************************************************************

Project:	STB-400
Component:	MPEGDriver
This file:	Command line interface

Copyright 1999 Pace Micro Technology plc. All rights reserved.

This material is the confidential trade secret and proprietary information
of Pace Micro Technology plc. It may not be reproduced, used, sold, or
transferred to any third party without the prior written consent of
Pace Micro Technology plc.

History:
Date		Who	Change
----------------------------------------------------------------------------
17/09/1999	BJGA	Created
08/11/1999	BJGA	Added Read3520() and Write3520()
22/11/1999	BJGA	Implemented a basic version of VideoInfo
07/12/1999	BJGA	Added audio stats to *VideoInfo

***************************************************************************/

/************/
/* Includes */
/************/

#include <stdio.h>
#include <stdbool.h>
#include "kernel.h"
#include "swis.h"

#include "MPEG/MPEG2cCard.h"

#include "CLI.h"
#include "Defs.h"
#include "Mess.h"
#include "Module.h"
#include "Types.h"

/*****************/
/* Private types */
/*****************/

/**********************/
/* Private prototypes */
/**********************/

static void static_OutputAVData (a_v_state_t *av);

/********************/
/* Public variables */
/********************/

/*********************/
/* Private variables */
/*********************/

/*********************/
/* Private constants */
/*********************/

#ifndef ErrorNumber_Syntax
#define ErrorNumber_Syntax 0xDC
#endif

/********************/
/* Public functions */
/********************/

/******	CLI_VideoInfo() ****************************************************

Purpose:	Handles *VideoInfo
Out:		Pointer to error block

***************************************************************************/

_kernel_oserror *CLI_VideoInfo (void)
{
  _kernel_oserror *e = NULL;
  printf ("Video:\n");
  static_OutputAVData (&Stream.video);
  printf ("Audio:\n");
  static_OutputAVData (&Stream.audio);
  return e;
}

/******	CLI_Read3520() *****************************************************

Purpose:	Handles *Read3520
In:		Argument string
Out:		Pointer to error block

***************************************************************************/

_kernel_oserror *CLI_Read3520 (const char *arg_string)
{
  _kernel_oserror *e = NULL;
  bool video = false;
  unsigned char reg = 0;
  unsigned char value = 0;
  switch (*arg_string)
  {
    case 'V':
    case 'v':
      video = true;
      break;
    case 'A':
    case 'a':
      video = false;
      break;
    default:
      e = Mess_GenerateError ("SMPDR35", ErrorNumber_Syntax, 0);
      break;
  }
  if (!e)
  {
    while (*++arg_string == ' ');
    e = _swix (OS_ReadUnsigned, _INR(0,1)|_OUTR(1,2), 16, arg_string, &arg_string, &reg);
  }
  if (!e)
  {
    value = * (volatile unsigned char *) (
        MPEG_Base_Address +
        (video ? Offset_MPEG_Video_Registers : Offset_MPEG_Audio_Registers) +
        (reg << MPEG_Register_Address_Shift)
        );
    printf ("%02X\n", value);
  }
  return e;
}

/******	CLI_Write3520() ****************************************************

Purpose:	Handles *Write3520
In:		Argument string
Out:		Pointer to error block

***************************************************************************/

_kernel_oserror *CLI_Write3520 (const char *arg_string)
{
  _kernel_oserror *e = NULL;
  bool video = false;
  unsigned char reg = 0;
  unsigned char value = 0;
  switch (*arg_string)
  {
    case 'V':
    case 'v':
      video = true;
      break;
    case 'A':
    case 'a':
      video = false;
      break;
    default:
      e = Mess_GenerateError ("SMPDW35", ErrorNumber_Syntax, 0);
      break;
  }
  if (!e)
  {
    while (*++arg_string == ' ');
    e = _swix (OS_ReadUnsigned, _INR(0,1)|_OUTR(1,2), 16, arg_string, &arg_string, &reg);
  }
  if (!e)
  {
    arg_string--;
    while (*++arg_string == ' ');
    e = _swix (OS_ReadUnsigned, _INR(0,1)|_OUTR(1,2), 16, arg_string, &arg_string, &value);
  }
  if (!e)
  {
    * (volatile unsigned char *) (
        MPEG_Base_Address +
        (video ? Offset_MPEG_Video_Registers : Offset_MPEG_Audio_Registers) +
        (reg << MPEG_Register_Address_Shift)
        ) = value;
  }
  return e;
}

/*********************/
/* Private functions */
/*********************/

/******	static_OutputAVData() **********************************************

Purpose:	Prints out *VideoInfo information pertaining to either
		Stream.video or Stream.audio
In:		Pointer to Stream.video or Stream.audio

***************************************************************************/

static void static_OutputAVData (a_v_state_t *av)
{
  printf ("                       Since open  Since reset\n");
  printf ("Bytes received:        %10d   %10d\n", av->since_open.amount_received, av->since_reset.amount_received);
  printf ("Bytes sent to 3520:    %10d   %10d\n", av->since_open.amount_sent, av->since_reset.amount_sent);
  printf ("Slows/repeats:         %10d   %10d\n", av->since_open.slows, av->since_reset.slows);
  printf ("Fasts/skips:           %10d   %10d\n", av->since_open.fasts, av->since_reset.fasts);
  printf ("Stalls:                %10d   %10d\n", av->since_open.stalls, av->since_reset.stalls);
  printf ("Underruns:             %10d   %10d\n", av->since_open.underruns, av->since_reset.underruns);
  printf ("Picture decode errors: %10d   %10d\n", av->since_open.picture_decode_errors, av->since_reset.picture_decode_errors);
  printf ("Severe errors:         %10d   %10d\n", av->since_open.severe_errors, av->since_reset.severe_errors);
  printf ("Pipeline errors:       %10d   %10d\n", av->since_open.pipeline_errors, av->since_reset.pipeline_errors);  
}
