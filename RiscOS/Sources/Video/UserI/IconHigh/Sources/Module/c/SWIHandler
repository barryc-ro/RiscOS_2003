#include "Desk.Error2.h"

#include "MemCheck.MemCheck.h"

#include "DrawHL.h"
#include "Header.h"
#include "^.Globals.h"
#include "^.Emulation.h"



_kernel_oserror *SWIHandler(int swi_no, _kernel_swi_regs *r, void *pw)
	{
	MemCheck_RegisterMiscBlock( r, sizeof( _kernel_swi_regs));
	
	//Desk_Error2_Init_JumpSig();
	
	Desk_Error2_Try	{
		if ( swi_no == IconHigh_DefaultEmulation - IconHigh_00)	{
			if ( r->r[0] && 1)	{	// r1 contains new settings
			if ( r->r[0] & (~1))	Desk_Error2_HandleTextf( "Unrecognised flags passed to IconHigh_DefaultEmulation in r0 - 0x%08x", r->r[0]);
				IconHigh_globals.newemulation.value	= r->r[1];
				}
			r->r[1] = IconHigh_globals.newemulation.value;
			}
		else if ( swi_no == IconHigh_GetDirection - IconHigh_00)	{
			if ( r->r[0] != 0)	Desk_Error2_HandleTextf( "Unrecognised flags passed to IconHigh_GetDirection in r0 - 0x%08x", r->r[0]);
			r->r[1] = IconHigh_globals.lastmovement.x;
			r->r[2] = IconHigh_globals.lastmovement.y;
			r->r[3] = IconHigh_globals.currentemulation;
			}
		else if ( swi_no == IconHigh_Start - IconHigh_00)	{
			if ( r->r[0] & (~1))	Desk_Error2_HandleTextf( "Unrecognised flags passed to IconHigh_Start in r0 - 0x%08x", r->r[0]);
			//EmulationStart( r, pw);
			EmulationPointerStart( (r->r[0] & 1) ? IconHigh_newemulation_default_POINTER : IconHigh_newemulation_default_HIGHLIGHTING, pw);
			}
		else if ( swi_no == IconHigh_Stop - IconHigh_00)	{
			if ( r->r[0] & (~0))	Desk_Error2_HandleTextf( "Unrecognised flags passed to IconHigh_Stop in r0 - 0x%08x", r->r[0]);
			EmulationPointerStop( pw);
			}
		else if ( swi_no == IconHigh_Redrawer - IconHigh_00)	{
			DrawHighlight( r, pw);
			}
		else	Desk_Error2_HandleTextf( "Unrecognised SWI number %i passed to " Module_Title ".", swi_no + IconHigh_00);
		}
	Desk_Error2_Catch	{
		MemCheck_UnRegisterMiscBlock( r);
		return Desk_Error2_ConvertToOS2();
		}
	Desk_Error2_EndCatch
	
	MemCheck_UnRegisterMiscBlock( r);
	return NULL;
	}
