#include "swis.h"
#include "kernel.h"

#include "Desk.Debug.h"
#include "Desk.Error.h"

#include "Emulation.h"

#include "Toggle.h"
#include "CMHGHead.h"


_kernel_oserror*	ToggleHandler2_handler( _kernel_swi_regs* r, void* pw)
	{
	Desk_Debug_Printf( Desk_error_PLACE "ToggleHandler2_handler called\n");
	if ( IconHigh_globals.currentemulation==IconHigh_newemulation_default_NONE)	{
		//EmulationPointerStart( IconHigh_newemulation_default_POINTER, pw);
		EmulationStartAuto( NULL, pw);
		}
	else	EmulationPointerStop( pw);
	return NULL;
	Desk_UNUSED( r);
	}


_kernel_oserror*	ToggleHandler_handler( _kernel_swi_regs* r, void* pw)
	{
	if ( r->r[0]==11 && r->r[1]==1)	{	// key down
		if ( r->r[2]==0x0e)	{	// Key is Scroll lock
			_swix( OS_AddCallBack, _INR(0,1), ToggleHandler2, pw);
			}
		}
	return NULL;
	}

void	ToggleInit( void* pw)
	{
	_swix( OS_Byte, _INR(0,1), 14, 11);
	_swix( OS_Claim, _INR(0,2), 0x10, ToggleHandler, pw);
	}

void	ToggleFinal( void* pw)
	{
	_swix( OS_Release, _INR(0,2), 0x10, ToggleHandler, pw);
	_swix( OS_Byte, _INR(0,1), 13, 11);
	_swix( OS_RemoveCallBack, _INR(0,1), ToggleHandler2, pw);
	}
