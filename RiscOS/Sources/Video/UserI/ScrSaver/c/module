/* > module.c
 *
 *      RISC OS module related code.
 */

/* From CLib */
#include <stdio.h>
#include <stdlib.h>
#include "kernel.h"

#include "module.h"

int poll_word;

#define OS_Module             0x1e
#define TaskModule_StartTask  0x4d301
#define OS_ReadVarVal         0x23

static void blank_screen(void)
{
  _kernel_swi_regs r;
  char cmd[256];
  
  poll_word = 0;             /* Set value of Poll Word to 0 */
  
  sprintf(cmd, "Run <ScrSaver$Path>!Run %d", (int) &poll_word);
  r.r[0] = (int) cmd;
  r.r[1] = 0;
  _kernel_swi(TaskModule_StartTask, &r, &r);  /* Run Basic App */
}

/*------------------------------------------------------------------------------
 * module_initialise
 *
 *      Module initialisation entry point.
 */
_kernel_oserror *
module_initialise( char *cmd_tail, int podule_base, void *pw )
{
  return 0;

  NOT_USED( cmd_tail );
  NOT_USED( podule_base );
  NOT_USED( pw );
}

/*------------------------------------------------------------------------------
 * module_service
 *
 *      Module service call entry point.
 */
void
module_service( int service_no, _kernel_swi_regs *r, void *pw )
{
  _kernel_swi_regs rv;
  char path[]="ScrSaver$Path";
  
  if ( service_no == Service_ScreenBlanking )
  {
    /* Check if ScrSaver$Path is set. If not, don't claim this call */
    rv.r[0]=(int)path;
    rv.r[1]=0;
    rv.r[2]=-1;
    rv.r[3]=0;
    rv.r[4]=0;
    _kernel_swi(OS_ReadVarVal, &rv, &rv);
    
    if (rv.r[2]<0)
    {
      blank_screen();
      r->r[1]=0;                /* Claim service call */
    }
  }

  if ( service_no == Service_ScreenRestored )
  {
    poll_word = 1;         /* Set value of Poll Word to 1 */
  }
       
  NOT_USED( pw );
}
