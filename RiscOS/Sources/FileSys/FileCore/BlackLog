***************************************************************************
*                                                                         *
*  Project: RiscOS                                                        *
*                                                                         *
*  Module:  FileCore                                                      *
*                                                                         *
*  Created: Wed 24-Oct-90      By: Ran Mokady                             *
*                                                                         *
*  First version: 2.04                                                    *
*                                                                         *
*    Copyright:    (C) 1990, Acorn Computers Ltd., Cambridge, England.    *
*                                                                         *
***************************************************************************

Purpose:
========

Filing system support for ADFS like filing systems.

***************************************************************************


Change Log:
===========


---------------------------------------------------------------------------

Version: 2.04 Wed 24-Oct-90        Ran Mokady                    

 *  Fixes up to this point - see Asm.Fixes for details

---------------------------------------------------------------------------

Version: 2.05 Fri 01-Mar-91        Jonathan Roach                

 *  Fix FileCore to make use of Hdr: constants where they're defined.
 *  FileCore extended to support FSControl CanonicaliseDiscAndPath and ResolveWildcard.
 *  FileCore DiscOp 9, CachedReadSectors added.
 *  FileCore_DiscardReadSectorsCache added.
 *  TickerEntry fixed to process TickerState properly
 *  Fix it so that floppies are treated like winnies and vice versa
 *  Add File_DiscOp 9 CachedReadSecsOp - caches the read sectors (see doc.SWIChanges)
 *  Add FileCore_DiscardReadSectorsCache
 *  Add FileCore_DiscFormat (see MultiFS documentation for outline)
 *  Add FileCore_LayoutStructure (see MultiFS documentation for outline)
 *  Add response to Service_IdentifyFormat
 *  Add response to Service_DisplayFormatHelp
 *  Add response to Service_EnumerateFormats
 *  Add response to Service_IdentifyDisc
 *  Enable unidentified/Non-FileCore discs to be opened as files
 *  Disc mounting completely rewritten for disc identification
 *  Enable DiscOps on non-FileCore discs
 *  Fix FileCore_DescribeDisc to put the real disc number on the root dir address.

---------------------------------------------------------------------------

Version: 2.06 Sat 02-Mar-91        Jonathan Roach                

 *  Fix UnLinkByDisc/Drive to handle uncertain discs. The symptoms of this
        bug where the occasional Broken Directory errors - which, in fact,
        indicated a trashed DirCache, and not a Broken directory on the
        disc.

---------------------------------------------------------------------------

Version: 2.07 Mon 11-Mar-91        Jonathan Roach                


 *  Fix UnLinkByDisc/Drive to only dismount Data discs after unlinking -
this was in before, but had a bug in it. Symptoms of bug: when doing a
SaveCreate to floppy the floppy root directory got written to the hard disc
root directory. How: SaveCreate started a FindDisc whilst BufDir was valid -
the FindDisc Unlinked the old disc from the drive and thus dismounted it
invalidating BufDir. However, CritBufDir was pointing to the hard disc's
root directory and SaveCreate continued assuming BufDir was still valid.
Eventually the modified dir was written out using the CritBufDir address
which wasn't modified to be the correct value due to BufDir being corrupted.

 *  Fix InitZoneObj to return the *correct* end of map bits offset for the
given zone. InitZoneObj returns the information to start a walk through the
fragment list for a given zone. One of the parameters returned is the end
offset. It used to return the beginning of the next zone as the end offset,
which was wrong as it took no account of ZoneSpare - the indicator of how
many junk bits there are on the end of each map block.

---------------------------------------------------------------------------

Version: 2.08 Mon 11-Mar-91        Jonathan Roach                

 *  Fix BeforeAlster/ReadFsMap to lock the correct controller while doing
this. Symptom: address exception when accessing a floppy on a configured
winnies 0 system.

---------------------------------------------------------------------------

Version: 2.09 Fri 15-Mar-91        Jonathan Roach                

 *  Fix/extend FileCore_LayoutStructure to handle hard disc-like formats.
 *  Fix defectspace to have enough room for floppy defect lists.
 *  Remove *noURD, *NoLib, *NoDir and *Title, these being made redundent.
 *  Add F-format to list of formats supplied.
 *  Add handling of format-parameter hangover. This feature holds some of
        the fields from a WrtTrkOp (format a track) in readiness for the
        mount after format which is assumed to be going to lay out a disc
        structure. Any non-verify op cancels the stored values. Whilst the
        last op was a WrtTrkOp the disc will automatically mount and remain
        unchanged with the format parameters and will be forced to be a data
        disc. Dismount cancels this.

---------------------------------------------------------------------------

Version: 2.10 Mon 18-Mar-91        Jonathan Roach                

 *  This version is a minor cockup with the version control system.

---------------------------------------------------------------------------

Version: 2.11 Mon 18-Mar-91        Jonathan Roach                

 *  Fix Floppy/WinnieOpDone to preserve r2 as the PRM says they should.
 *  Fix FileCore_LayoutStructure to round up the boot block object's size correctly.
 *  Fix *Verify to use ZoneSpare correctly.
 *  Fix CanonicaliseSpecialAndDisc to correctly terminate at 10 chars
 *  Fix IdentifyDisc on E format floppies with a non-0 boot option to work.

---------------------------------------------------------------------------

Version: 2.12 Thu 28-Mar-91        Jonathan Roach                

 *  Fix CachedReadSecsOp to handle SectorSize, Heads or SecsPerTrk being 0 (uses values of 10, 1 and 1)
 *  Fix Mount to copy DiscSize for old filing systems which don't support hard disc mounting.
 *  Remove (now redundent) handling of ReadCSDName, ReadDiscName and ReadLibName
 *  Fix DoOsFunBootup to IdentifyCurrentDisc for the disc to boot.
 *  Fix fsentry_func to allow reentrance on CanonicaliseSpecialAndDisc
 *  Fix CanonicaliseSpecialAndDisc to use FindDiscByName rather than FullLookup for safety of reentrance
 *  Fix IdentifyCurrentDisc to use FileSwitch to get the current disc.
 *  A a subsequence of the above these *-commands/interfaces now work properly with the new FileSwitch:
        checkmap, compact, dismount, free, map, verify, fsfunc_Opt.
 *  Enable reentrance on fsfile_Load and fsfile_ReadInfo.
 *  Add support for fsfile_readblocksize.
 *  Fix bug whereby defects at the end of fragments were incorrectly
handled: If the defect was in a free fragment which was the last fragment in
a zone and it was within one MinMapObj of the end then there was a stiff up.
 *  Add support for:
        fsfunc_DefectList
        fsfunc_AddDefect
        fsfunc_ReadBootOption
        fsfunc_WriteBootOption
        fsfunc_UsedSpaceMap
 *  Optimise F format parameters - for reliability and speed across machines
 *  Internationlised

---------------------------------------------------------------------------

Version: 2.13 Fri 12-Apr-91        Jonathan Roach                

 *  Fix SWI entries to be not very 'inside' FileCore, ie allowing entrance
even if any interlocks are set or if there's a locked disc. This enables
DiscOp to be externally entered whilst doing an IdentifyDisc.
 *  Fix Identification of FileCore discs to SWI DiscOp rather than branching
to the internal routine RetryDriveOp.

---------------------------------------------------------------------------

Version: 2.14 Sun 21-Apr-91        Jonathan Roach                

 *  Insert ChkKernelVersion in init sequence.

---------------------------------------------------------------------------

Version: 2.15 Tue 30-Apr-91        Jonathan Roach                

 *  If *Backup if Same Disc situation then returns to ask for disc again
        rather than bombing out.
 *  Escape when waiting for a user response now acknowledged and returned as
        and error.
 *  Wait for key pressed after checkmap gave good answer no longer takes place
 *  Fix UpCalling to return a correct media type ('disc' for example).
 *  Separate the message handling code into a different source file.
 *  Get *Free to UpCall through to FileSwitch for the information.
 *  Fix Light entries (eg DiscOp) to allow reentrance to a level of 4.
 *  Fix error generation to give error numbers of the form &0001ffee, not &0000ffee
 *  Use FileSwitch NameDisc interface for *NameDisc, and add support for the
        lower level version
 *  Fix OSFile_WriteInfo on a disc's root object to stamp the disc with a
        new disc id.
 *  Fix matching of a new disc with an old record to set NeedNewIdFlag to
        ensure a different machine sees a different Id when the disc gets
        updated.
 *  Add call to FSControl_StampImage_NextUpdate on identifying an old
        non-FileCore disc.
 *  Add support for fsargs_ImageStampIs.
 *  Prevent non-auto-errors from error in vetting SWI
 *  Fix SWI dispatch code to only resolve r8-WP style SWIs if its one
        listed, not if its not one listed. This aids robustness.

---------------------------------------------------------------------------

Version: 2.16 Sun 05-May-91        Jonathan Roach                

 *  Fix identification sequence to strcmp disc name rather than memcmp the
        discname field.
 *  Fix DiscOp to complain about FileCore in use if locked disc mismatches
        DiscOp disc.
 *  Lighten up some of the File and Func entries to enable
        FSControl_StampImage to work better.
 *  Make writes to disc images non-background to avoid data lost on disc
        image files.

---------------------------------------------------------------------------

Version: 2.17 Wed 15-May-91        Jonathan Roach                

 *  Fix handling of Service_IdentifyDisc to not corrupt r7
 *  Add support for FSEntry_func 33 (ObjectAtOffset)
 *  Add support for FileSwitch Truncate bit.
 *  Fix bug whereby a reference to a bad drive (single drive character)
        caused a please insert disc 'N' rather than returning a bad drive
        error.
 *  Remove Kludges and implement support for removable winnies and winnies
        which support mount properly.

---------------------------------------------------------------------------

Version: 2.18 Wed 12-Jun-91        Jonathan Roach                

 *  Fix bug whereby fsfunc_ResolveWildcard returned FileCore error rather
        than the actual error generated.
 *  Fix bug whereby fsfunc_ResolveWildcard returned NotFoundErr rather than
        r2=-1 when the directory wasn't found which contained the wildcard
        which wanted resolving.
 *  Change text of 'File Core error' to 'FileCore error'
 *  Fix *Mount to explicitly do *Dir :<disc>.$, *Lib :<disc>.$.Library, *NoURD
 *  Fix bug whereby when a file is closed which has been truncated to 0
        length, then its buffers are released, free.
 *  Fix the 'foo' 'blah' bug. This bug was characterised by a program which
        openned a file, wrote 'blah' to it, closed it, openned it, read it,
        printed the result, truncated it, closed it, openned a file, wrote
        'blah' to it, closed it, openned it, read it, printed the result,
        truncated it, closed it then repeated. The expected output was
        'blah', 'foo', 'blah', ...., but sometimes 'blah', 'blah', ... would
        come out. The actual bug was that when a file was closed and
        and truncated, the internal Fcb didn't have its buffers junked.
        These buffers were incorrectly picked up later as the contents of
        the file - hence the problem.
 *  Fix bug whereby when a file was closed and converted to a shared object
        the Fcb didn't follow it. Consequence was buffers were held up
        attached to Fcbs which shouldn't have been.
 *  Fix bug in responding to FSArgs_ImageStampIs.
 *  Get FileCore_FreeSpace to indirect through FSControl_ReadFreeSpace.
 *  Tidy up menu text of formats.
 *  Fix *free to handle non-:-prefixed disc specifiers.

---------------------------------------------------------------------------

Version: 2.19 Fri 14-Jun-91        Jonathan Roach                

 *  Fix PutBytesEntry to trash any buffers on a image disc. This prevents
inconsistencies creeping into the buffer cache.
 *  Fix silly mistake which broke FileCore_DiscOp.

---------------------------------------------------------------------------

Version: 2.20 Mon 17-Jun-91        Jonathan Roach                

 *  Fix response to Service_DisplayFormatHelp.

---------------------------------------------------------------------------

Version: 2.20 Sun 23-Jun-91        Jonathan Roach                

 *  Fix corrupt to broken in relevant messages.
 *  Fix handling on unidentified discs such that a disc will only be
        remounted if it has changed as indicated by the lower level drivers,
        and a disc will be identified only if needed. This fixes a problem
        in desktop verify whereby after pausing and waiting for the disc
        light to go out then restarting the verify continues with a seek to
        track 0 before each verify - this was a mount happening. Now - and
        this is unfixable in FileCore - two seeks happen - one because the
        disc might have changed as the drive wasn't spinning and disc
        changed and one as the drive was span up in the changed doesn't work
        and the motor was off state.
 *  Fix bug whereby *help format gave address exception.
 *  Remove duff 'feature' whereby if a mount failed the error was propogated
        through all future mounts until the disc might have changed.
 *  Fix bug whereby FSControl_StampImage didn't.
 *  Add section to doc.SwiChanges regarding extention of WrtTrackOp.
 *  When detaching disc from drive ensure drive gets 'LastDiscOpWasFormat'
        cleared.
 *  Issue Service_DiscDismounted on *Dismount and shutdown.
 *  Fix disc identification to cope with 1-zone hard discs with the root
        directory positioned after the boot block.
 *  Fix FileCore_LayoutStructure to be able to layout 1-zone hard discs and
        D format hard discs.
 *  Fix FileCore to respond to FileSwitch informing it of disc name changes
        of MultiFS images FileCore has open.
 *  Fix handling of LastDiscOpWasFormat disc record parameter propogation
        scheme to correctly drop that flag when the disc changes.
 *  Fix dismounting to dismount the disc (bug introduced in
        Service_DiscDismounted code).

---------------------------------------------------------------------------

Version: 2.21 Sat 06-Jul-91        Jonathan Roach                

 *  Fix bug in identifying hard discs whereby the defect list sanity check
        managed to be ignored when identifying a D format hard disc.
 *  Slacken D and L format floppy detection to accept any D or L-like disc
        which claims its disc size is less than or equal to 4 tracks-worth
        over a standard D or L floppy's size. This slackening is to
        accomodate some applications which use sectors beyond the end of the
        recorded disc size as a protection mechanism. An extra 4 tracks is
        allowed to accomodate formats which use more than 80 tracks -
        the number 4 being the number of extra tracks a couple of floppy
        drives which were tried would allow.

---------------------------------------------------------------------------

Version: 2.22 Wed 10-Jul-91        Jonathan Roach                

 *  Fix bug such that error from mount wasn't propogated up properly which
        lead to FileCore trying to use internal structures which hadn't been
        set up properly ending up at an address exception. Short description
        of bug fixed: click on floppy disc icon gives address exception,
        icon disappears and get FileCore in use errors.

---------------------------------------------------------------------------

Version: 2.23 Tue 23-Jul-91        Jonathan Roach                

 *  Fix acceptance of D-format discs to reject those with 0-filled sectors.
 *  Fix bug in hard disc free space evaluations which would give address
        exception on D-format hard discs.
 *  Fix bug in fsfunc_ResolveWildcard to give DirNotFound rather than broken dir.
 *  Filter out 0-byte foreground transfer ops (read/write/verify). Gets
        round bug in ADFS whereby it didn't call FileCore's release FIQ
        routine in this situation. This lead to FIQ claimed and Econet being
        stiffed as a consequence. This happened when stretching a 0-size
        file on a D-format disc where two 0-size transfers were requested to
        move the file from position 0 on the disc to the place where the
        free space had been allocated.
 *  Only look up a disc name for CanonicaliseSpecialAndDisc when the
        supplied name is a drive or wildcarded disc name. This prevents
        unwanted remounts of discs.
 *  Split FileCore50 into InitDieSvc and Commands.
 *  Fix *Backup to handle F and foreign disc formats.

---------------------------------------------------------------------------

Version: 2.24 Wed 24-Jul-91        Jonathan Roach                

 *  Slacken off check of boot parameters to accept hard discs with more than
        0 sectors per track, rather than more than 4. This gets round daft
        parameters put onto SCSI discs.

---------------------------------------------------------------------------

Version: 2.25 Mon 05-Aug-91        Jonathan Roach                

 *  Improve disc identification as follows:
        Don't try to identify a hard disc with a floppy disc format.
        When identifying E floppies ignore sectors per track - copy
                protection schemes can confuse this value.
        Copy sectors per track from E format into internal disc record to
                robistfy against copy protection schemes.
 *  Don't swallow errors from winnie mounts.
 *  Fully identify disc for DiscOps.
 *  Fix response to Service_EnumerateFormats to not trash the list so far.
 *  Return to RiscOS 2.00 Ambiguous disc response to avoid clashes with some
        copy protection schemes.
 *  Ensure disc Id is updated whenever necessary. The following cases were
        not covered in Risc OS 2.00:
        *  Close of a modified file whose size hadn't changed.
        *  Modification of a file (before close).
 *  Trim workspace down.


---------------------------------------------------------------------------

Version: 2.26 Tue 27-Aug-91        Jonathan Roach                

 *  Set fsextra_DoFileInfoForMe.
 *  When stretching a scatter entry, don't do it if its of 0 length.
 *  Fix bug in FSFunc_ResolveWildcard when old directory names weren't
        masked when copied into the buffer.
 *  Fix bug whereby break action got set to &22 by incorrect nesting in
        WriteDir.
 *  Fix set attributes on a disc to handle non-FileCore discs properly.
 *  Fix bug whereby if, during write behind, the low level driver transfered
        exactly 128k bytes and finished after FileCore started looking at
        the background process after it had decided to wait for it to catch
        up so it could stretch it with more buffers then FileCore would fail
        to notice and wait for ever.
 *  Stop scatter list extension except by add new scatter pairs. Extending
        the last pair caused bad headaches for filing systems so this
        feature has been removed.
 *  Fix bug where small files when converted to shared on close didn't keep
        the FcbBufSz up to date with the change. The consequence of this is
        a stiff when the file is next read using GBPBs.
 *  Fix bug where sometimes formatting a disc with defects would fail, but
        appear to succeed. Bug was in FileCore_LayoutStructure's handling of
        the addition of defects.
 *  Fix convert to shared file on close to always update the Fcb, not just
        when there's a move of data to be done to do the conversion.
 *  Fix ReleaseFcbBuffersInRange to wait for active Fcb buffers to be passed
        through the process before moving them into the empty chain. This
        avoids them being moved into the empty chain (and off the Fcb's
        chain) before being moved to, say, the read ahead chain, and so
        being on the read ahead chain, but off any Fcb chain, and thus lost
        to the world.
 *  Support extension to Service_IdentifyDisc which enables a text
        identifier for the disc format to be returned.

---------------------------------------------------------------------------

Version: 2.27 Wed 28-Aug-91        Jonathan Roach                

 *  Fix bug where FileCore could stiff on a write to a foreign disc.
 *  On format track dismount any attached disc.

---------------------------------------------------------------------------

Version: 2.28 Sat 31-Aug-91        Jonathan Roach                

 *  Only cancel LastDiscOpWasFormat on Changed or empty, but not on
        MayBeChanged. Prevents problems during format sequence if disc was
        write protected at the start.
 *  Ignore error from StampImage_NextUpdate issued from WhatDisc. Prevents
        disc not being seen when accessed as a file which isn't FileSwitch's
        image file for that disc.

---------------------------------------------------------------------------

Version: 2.29 Tue 10-Sep-91        Jonathan Roach                

 *  Fixed bug in CachedReadSecs which caused corruption in tight memory
        situations.
 *  Fix bug in PutBytes on foreign floppies where cached read-ahead sectors
        weren't correctly discarded. Caused DOSFS horrible problems!

---------------------------------------------------------------------------

Version: 2.30 Tue 17-Sep-91        Jonathan Roach                

 *  Fixed bug whereby ReadAhead restart failed to notice a lack of available
        buffers until it had shook ADFS's arm and caused the floppy light to
        stay on.
 *  Fix response to Service_IdentifyDisc to make no assumption about which
        incarnation is being used - enables ADFSFiler's current format menu
        box work properly.

---------------------------------------------------------------------------

Version: 2.31 Tue 17-Sep-91        Jonathan Roach                

 *  Fix buffer allocation to not push its luck with RMA and system heap.
        Algorithm claims all but last 2k of largest blocks in these heaps.
        This causes *backup to work, and other parts of the system don't get
        bad headaches when backup goes on.

---------------------------------------------------------------------------

Version: 2.32 Fri 20-Sep-91        Jonathan Roach                

 *  Adjust identify disc to report ADFS 1.6M on hard discs to get ADFSFiler
        menu current format to report sensible value.

---------------------------------------------------------------------------

Version: 2.33 Mon 23-Sep-91        Jonathan Roach                

 *  Fix ReleaseAllFcbBuffersInRange (and, consequently ReleaseAllFcbBuffers)
        to preserve r0 like it was supposed to before it was broken by an
        earlier fix for a different bug. Prevents free space map rot when
        closing files which have been truncated to 0 length - the freed
        space gets freed.

---------------------------------------------------------------------------

Version: 2.34 Thu 31-Oct-91        Jonathan Roach                

 *  Add PreferredDisc code to conteract ambiguous disc name problems.
        Basically CanonicaliseSpecialAndDisc of a drive number prefers the
        found disc, and of a disc name causes no disc to be preferred. When
        FindDiscByName-ing the preferred disc (if present) is checked first
        (no ambiguity possible), then all are checked (ambiguity possible).
 *  Handle case insensitivity in an international fashion.

---------------------------------------------------------------------------

Version: 2.35 Thu 14-Nov-91        Jonathan Roach                

 *  Extend the process scatter buffer to be large enough for the un-merged
        sub-buffers of the file cache. Avoids address exceptions with IDE
        ADFS.
 *  Fix to CachedReadSecsOp in memory-tight situations: avoid sector
        skipping on multi-sector operations, and thus stopping hard discs
        being recognised.

---------------------------------------------------------------------------

Version: 2.36 Tue 21-Jan-92        Jonathan Roach                

 *  Make use of *Format parameter supplied flag in enumformats block to
        support desktop non-interactive *Format.
 *  Fix FSControl_FreeSpaceMap to work on a full D or L format disc (fixes
        backup on these varieties of disc) - change in FileCore60. Problem
        was routine expected 1 or more free space entries, not 0 or more.
 *  Remove check on disc size being < 512M so that large discs with UNIX
        partitions work again (RP-0711).

---------------------------------------------------------------------------

Version: 2.37 Thu 30-Jan-92        Jonathan Roach                

 *  Remove 'Same disc' check from *Backup. Avoids discs from filing systems
        which can't provide a good disc uniqueness cycle number from causing
        embarasment when backing up onto a backup of that disc (ie always
        allow a backup even if the destination looks like the source).
 *  Enable *Backup to work more reliably. Problems were caused by
        uninitialised memory. (Symptom: click Y to perform backup, disc
        spins and that's it, or you get a 'Protected disc' error).

---------------------------------------------------------------------------

Version: 2.38 Thu 12-Mar-92        Jonathan Roach                

 *  Calculate file allocated size on open accurately for RP-0966.
 *  Adjust size of open file after allocation based on actual allocation
        amount, not amount requested RP-0966.

---------------------------------------------------------------------------

Version: 2.39 Wed 18-Mar-92        Jonathan Roach                

 *  Use RMA rather than system heap for file control block allocations.
        Prevents unexpected (and apparently random) No free memory (in heap)
        errors.

---------------------------------------------------------------------------

Version: 2.40 Mon 23-Mar-92        Jonathan Roach                

 *  Remove 1K of junk from workspace.

---------------------------------------------------------------------------

Version: 2.41 Mon 06-Apr-92        Jonathan Roach                

 *  Fix disc map breaking in CloseFileEntry. Problem was release of disc
        space on close wasn't releasing enough due to length of allocated
        space being guessed at rather than using the accurate amount held in
        the file control block.

---------------------------------------------------------------------------

Version: 2.42 Wed 14-Jul-93        Jonathan Roach                

* FileCore_Create error return path sorted out
* Add G format (octal density) to accepted list
* Delete and Checkmap file length calculation takes account of possible
        awkward situations (map rot bug).
* Correct comment in code about error identification within FileCore.
* *Free text format

-------------------------------------------------------------------------

Version: 2.43 Tue 10-Aug-93        ENevill                       

* Extracted * command Help/Syntax messages

---  ------------------------------------------------------------------------

Version: 2.44 Thu 26-Aug-93        Owen Love                     

* Improvement in the wording of the error messages stored in the message
file as part of the Libra project.
---------------------------------------------------------------------------

Version: 2.45 Tue 31-Aug-93        Jonathan Roach                

Swap FS9 and FS10. Fix for MED-00293.

---------------------------------------------------------------------------

Version: 2.46 Wed 15-Sep-93        Jonathan Roach                

* Issue Service_CloseFile for all discs if run out of disc records in the
vain hope a record might be freed by this.
* Bubble back the disc error if that's what caused a disc to identify as
data.

---------------------------------------------------------------------------

Version: 2.47 Wed 22-Sep-93        Jonathan Roach                

Fix discard of read-ahead buffers on image filing system discs. MED-00096
highlighted this problem. Explanation: FileCore keeps 1K buffers, dividing
them into 1, 2 or 4 sub-buffers for 1024, 512 or 256 byte sectors. The
discard routine, invoked when a write to a DOS disc happens, scans the
buffers and discards any which have anything in them which is being written.
The bug was that only the buffer start was being checked which meant that if
the transfer start was on an odd sector the buffer for the transfer start
didn't get discarded. The net result was that next time that sector was read
the old value appeared. This gave broken DOSFS discs frequently.

---------------------------------------------------------------------------

Version: 2.48 Tue 23-Nov-93        Jonathan Roach                

* Fix bugs MED-01053 and MED-00757. Problem was conditional wrong way round
when going back to the file block chain start after a disc write to a floppy
disc.

---------------------------------------------------------------------------

Version: 2.49 Fri 26-Nov-93        Jonathan Roach                

* Remove G format from *Format help
* Allocate Wimp_ClaimFreeMemory properly - don't assume it'll give all when
a little is requested.

---------------------------------------------------------------------------

Version: 2.50 Tue 11-Jan-94        Jonathan Roach                

* No changes, but loads of debugging added.

---------------------------------------------------------------------------

Version: 2.51 Thu 10-Feb-94        Jonathan Roach                

* asm.FileCore20 routine PollChange lines 1584-1586 added. Med-00198:
eventually get a disc error 10 at :0/00000000. The line selects the
controller to interlock and wait to become free before PollChanging on it.
Before the floppy disc controller was waited for all the time. Reasoning
goes as follows: the FlpDCB is used for DiscOps, Mounts and PollChanges. If
two of these try to use it at once there'll be a problem. Although an
earlier bug fix in ADFS seemed to have ensured suitable interlocking I still
don't trust it - so check for bugs in PollChange and interlocking. Lo! this
bug came to light from a code read-through. Admitedly I can't think of a
scenario where this particular bug would cause double use of FlpDCB, but it
still remains a bug and could cause such a problem.
***************************************************************************
                      MEDUSA - RISC OS 3.50 build
***************************************************************************
*                                                                         *
*  Project: Black                                                         *
*                                                                         *
*  Module:  FileCore                                                      *
*                                                                         *
*  Created: Wed 22-Jun-94      By: Aideen McConville                      *
*                                                                         *
*  First version: 2.51                                                    *
*                                                                         *
*    Copyright:    (C) 1994, Acorn Computers Ltd., Cambridge, England.    *
*                                                                         *
***************************************************************************

Purpose:
========



***************************************************************************


Change Log:
===========


---------------------------------------------------------------------------

Version: 2.51 Wed 22-Jun-94        Aideen McConville             

Moved to new source tree.

---------------------------------------------------------------------------

Version: 2.52 Tue 06-Sep-94        Steve Cormie                  

* Fixed MED-00009, previous fix was buggy in that it copied the terminating
  character of the disc name for Service_CloseFile which subsequently failed.
* Fixed MED-03702, embedded text "Unset" was not used.

---------------------------------------------------------------------------

Version: 2.53 Mon 24-Oct-94        sproven                       

* Various changes to break FileCore 512M byte disc limit, partially
  complete - DON'T use this version for ROM builds, unless BigDisc
  is set FALSE.
  

---------------------------------------------------------------------------

Version: 2.54 Thu 27-Oct-94        sproven                       

* Fixed problem with register corruption on IdentifyFileCorHardDisc,
  now works with DOSFS.

---------------------------------------------------------------------------

Version: 2.55 Tue 01-Nov-94        sproven                       

Fixed formatting of 1.6M floppies (s.FormSWIs).  Added DiscSize2
to Disc Record structure (s.FileCore15 s.GenSWIs s.FileCore60
s.FileCore00 s.Commands s.FileCore20 s.Identify).

---------------------------------------------------------------------------

Version: 2.56 Tue 01-Nov-94        Steve Cormie                  

* Added directed comments to Messages file for message tokenisation.
* Moved command help/syntax from Global.Messages to Messages file.

---------------------------------------------------------------------------

Version: 2.57 Mon 07-Nov-94        sproven (Simon Proven)       

Various changes to FileCore80 to allow ADFSBuffers to work on big
discs.


---------------------------------------------------------------------------

Version: 2.58 Thu 10-Nov-94        sproven (Simon Proven)        

Added FileCore_MiscOp 6, OS_FSControl 55, 56, 57 support, FileCore_FreeSpace64,
some extensions to defect list handling code.  Added extended process error
reporting - now disc errors are correctly reported on BigDiscs.  Fixed data
abort on mounting unrecognised floppy.

---------------------------------------------------------------------------

Version: 2.59 Thu 17-Nov-94        sproven                       

Implemented and tested DoCompMoves optimised version.


---------------------------------------------------------------------------

Version: 2.60 Thu 17-Nov-94        sproven                       

Added 64 bit numbering in *Defect

---------------------------------------------------------------------------

Version: 2.61 Fri 18-Nov-94        sproven                       

Fixed bug in floppy format - DoSwiDiscOp & DoSwiSectorDiscOp broken.
Fixed bug in floppy mount - SanityCheckLFormat was setting DiscSize to 0

---------------------------------------------------------------------------

Version: 2.62 Fri 18-Nov-94        Steve Cormie                  

Messages file changed so that menu entries are not tokenised.

---------------------------------------------------------------------------

Version: 2.63 Mon 21-Nov-94        sproven                       

Fixed 64 bit number reading for *Defect - ReadHex64 was
returning after reading first digit, so causing
"Parameters not recognised" error.

---------------------------------------------------------------------------

Version: 2.64 Tue 22-Nov-94        sproven                       

Fix DoDefect and MarkObjectMappedIn so that *BackUp works correctly.


---------------------------------------------------------------------------

Version: 2.65 Thu 01-Dec-94        sproven                       

Fixed hard disc *defect.

---------------------------------------------------------------------------

Version: 2.66 Mon 05-Dec-94        sproven                       

Fixed DoSwiFreeSpace64 to use OS_FSControlReadFreeSpace64.

---------------------------------------------------------------------------

Version: 2.67 Tue 06-Dec-94        sproven                       

Fixed ADFSbuffers so that DiscAdjust is not incorrectly used
to find disc drive number.  In one place (BackGroundFileCacheOp)
had to use test of bit 28 of DiscAdjust which effectively
limits max disc size to 2^28 sectors - not a problem when
max recommended disc size is 4G though.  Files affected:
FileCore80

---------------------------------------------------------------------------

Version: 2.68 Thu 08-Dec-94        sproven                       

Fixed FreeSpace64 - was missing test for this SWI call in the
SWI handler so wasn't handling private word correctly.


---------------------------------------------------------------------------

Version: 2.69 Fri 09-Dec-94        sproven                       

Changed FileCore30 - FindErrBlock now works with extended process
error blocks.

---------------------------------------------------------------------------

Version: 2.70 Fri 09-Dec-94        sproven                       

Added check for Disc address overflow when calling small filing
systems (FileCore15, RetryDriveOp).

---------------------------------------------------------------------------

Version: 2.71 Mon 12-Dec-94        sproven                       

Fixed DoOsFunDefectList64 in FileCore60 (wasn't returning number
of pairs placed into buffer, and was confused over presence of
second defect list).

---------------------------------------------------------------------------

Version: 2.72 Thu 15-Dec-94        sproven                       

Fixed DismountDisc (was incorrectly checking disc size and
generating invalid disc address).  Fixed DoDefect to check
disc address correctly.  Slight optimisations to DoBackup
(removed unecessary - paranoid, even - push/pull pairs).

---------------------------------------------------------------------------

Version: 2.73 Fri 16-Dec-94        sproven                       

Fixed DoMap to work on >4G discs (s.Commands).  Removed
excess push/pull pair in DoVerify (s.Commands).  Fixed
ADFSBuffers problem with D or L format and non-FileCore
discs (eg DOS discs) where DiscAdjust was being calculated
incorrectly (was shifting entire address by sector size,
so shifting disc bits into address bits).  (s.FileCore80)
Removed spurious warning message about BigDisc being
turned on (s.FileCore).

---------------------------------------------------------------------------

Version: 2.74 Mon 19-Dec-94        sproven                       

Fixed IdentifyFormat bug (was returning 'ADF' for all
non-F format discs).  Was register corruption in
IdentifyFileCoreFloppyDisc (s.Identify changed).

---------------------------------------------------------------------------

Version: 2.75 Mon 19-Dec-94        sproven                       

Altered DoSwiDiscOp and DoSwiSectorDiscOp so that
on write operations they check the FSLock status
and if the filing system is locked do not allow
the operation.  The two operations checked are
WriteTrk and WriteSecs. (s.GenSWIs, s.Errors)

Fixed *defect - new, improved (NOT) test for disc
address out of range was corrupting disc address
in the process. (s.Commands)

---------------------------------------------------------------------------

Version: 2.76 Tue 10-Jan-95        sproven                       

Fix for MED-04217, checks Escape in OSFunBootUp (s.FileCore60)

---------------------------------------------------------------------------

Version: 2.77 Thu 12-Jan-95        sproven                       

Fix for MED-04242, LayoutFreeSpaceMap fixed to use correct
disc size. (s.FormSWIs)

---------------------------------------------------------------------------

Version: 2.78 Mon 16-Jan-95        sproven                       

Fix for MED-4345 in s.FormSWIs - changed LayoutFreeSpacMap to
shift disc address for call to MapOutADefect.  Note that
this routine cannot handle defects >512M

Fixed DoMap to work on discs >4G bytes (not yet tested), for
MED-0436.  (s.Commands)

---------------------------------------------------------------------------

Version: 2.79 Thu 26-Jan-95        sproven                       

* Fixed disc mount code to work with ShareSize<>0 (copy ShareSize to disc
  Record correctly and generate root directory disc address correctly).
  (s.Idenitfy)

* Fixed DoSwiDescribeDisc to place DiscSize2 and ShareSize fields in returned
  disc record (s.GenSWIs)

* Fixed GetBytes entry to collect sector properly.  Was using DiscAdjust incorrectly
  to get drive number, now using FcbIndirectDiscAddr.  This should properly fix
  the ADFSBuffers problem which was thought to be fixed by version 2.73. (s.FileCore80)

* Fixed MyCloseFile to attach correct length when converting to a shared object. (s.FileCore70)

* Fixed FindFileFragment, MeasureFileAllocSize and MeasureFileAllocSize_GotMap to support 
  BigShare and added RoundUpShare routine (s.FileCore33)

* Fixed NewClaimFree to support BigShare. (s.FileCore31)

* Added ShareSize to disc record. (s.FileCore00)

---------------------------------------------------------------------------

Version: 2.80 Wed 01-Feb-95        sproven                       

Fixed AddDefect64 not to corrupt R3 on entry.  (s.FileCore60)

---------------------------------------------------------------------------

Version: 2.81 Mon 13-Feb-95        sproven                       

Fixed DoVerify and BeforeAlterFsMap to not call UnLockMap
on Dos Discs.  Modified some Debug6 code to use DLINE
and DREG.

Files changed: Version, s.Commands, s.FileCore40, s.FileCore35

---------------------------------------------------------------------------

Version: 2.82 Wed 15-Feb-95        sproven                       

* Fixed WriteZeroes to not overflow scratch space on large discs - old
  code assumed smaller allocation unit.

* Fixed DoMap to work on >4G discs, was broken in a number of ways.

Files changed: Version, s.Commands, s.FileCore70

---------------------------------------------------------------------------

Version: 2.83 Fri 17-Feb-95        sproven                       

Implemented fix for MED-04138, checks if disc too large for
filing system on mount and if so then refuses to mount.

Changed: s.Identify, s.FileCore00, Version

---------------------------------------------------------------------------

Version: 2.84 Thu 23-Feb-95        sproven                       

Fixed *free to work on discs >4G bytes.

Files changed: s.Commands, Resources.UK.Messages, Version

---------------------------------------------------------------------------

Version: 2.85 Fri 03-Mar-95        sproven                       

Fixed SizeLessDefects64 to work on old map discs with no
defect list (was leaving r0 non-0 on exit).

Fixed *free to work in cases where FS (eg DOSFS) does not
support FSControl 55.

---------------------------------------------------------------------------

Version: 2.86 Sun 12-Mar-95        sproven                       

* Made defect list handling test for >512M disc using BigFlag
  rather than DiscSize and DiscSize2.

* Robustified UnlockMap so that if called incorrectly then does
  not attempt to UnlockDrive on Drive &FF (causes directory
  cache corruption and sometimes crashes machine).

* Changed sector size assumption on unrecognised boot block
  from 1024 bytes to 512 bytes to get Mac discs to work.

* Added debug code to DrvRecPtr and DiscRecPtr to catch cases
  where illegal pointers were generated.

* Finally fixed *Verify properly.  Original fix was attempt to
  stop UnlockMap call for DOS floppies.  But fix was broken,
  because:
  
  * It caused the new code to call UnlockMap TWICE for D, E and
    F discs (bad move).
  
  * The original code was incorrectly calling UnlockMap for D.
  
  Now the code correctly only calls UnlockMap if the disc is
  a FileCore disc.

Changed: s.FileCore60, s.FileCore35, s.FileCore20, s.FileCore00,
         s.DebugOpts, s.Commands

---------------------------------------------------------------------------

Version: 2.87 Tue 14-Mar-95        sproven                       

Implemented fix for ATAPI data lost problem, in RestartCheck

---------------------------------------------------------------------------

Version: 2.88 Wed 15-Mar-95        sproven                       

Changed BigDiscSupport bit to bit 9 as bit 2 turns out
to mean something under RISC OS 2.

---------------------------------------------------------------------------

Version: 2.89 Wed 15-Mar-95        sproven                       

Fixed the new MiscOp SWI entry not to call Parent_Misc
if operation not supported by low-level filing system.

---------------------------------------------------------------------------

Version: 2.90 Thu 30-Mar-95        sproven                       

MED-05198: Fixed 2G files so that files of &7FFFFFFF can't be
extended to &80000000.  Option is controlled
by the TwoGigFix label.

Changes: s.FileCore70, s.DebugOpts

---------------------------------------------------------------------------

Version: 2.91 Tue 04-Apr-95        Aideen McConville             

Changes: s.Errors, Resources.UK.Messages

Part of change meant for 2.90 above.

---------------------------------------------------------------------------

Version: 2.92 Thu 13-Apr-95        sproven                       

Fixed MacFS problem - MountDiscOnDrive was not clearing
the ShareSize field before attempting to identify the
disc.

