   10
   20The workspace for SharedSound represents the workspace for one driver
   30activity with a number of associated streams and handlers.
   40The same code could be used with another instantiation to control the
   50activity via another output driver.
   60
   70
   80DEFPROCSetStart
   90LOCAL er$
  100er$="Set"
  110PRINT "PROCSet"
  120
  130swiBase%=&4B440
  140Overflow_Flag=1<<28
  150Zero_Flag=1<<30
  160Iflag%=&08000000
  170SVC_Mode%=3
  180
  190Sound_LinearHandler%=&40145
  200XSound_LinearHandler%=&60145
  210Sound_Mode%=&40144
  220Sound_SampleRate%=&40146
  230
  240REM Sound flags
  250
  260soundFlag_Mix%=1
  270soundFlag_Period%=1<<8
  280soundFlag_Log%=1<<9
  290
  300REM --------- Handler table stuff
  310
  320handler_Address%=0
  330handler_Parameter%=4
  340handler_Flags%=8
  350handler_SampleFrequency%=12
  360handler_Volume%=16
  370handler_Type%=20
  380handler_Fraction%=24
  390handler_VolumeScaled%=28
  400handler_Name%=32
  410
  420  handlerNameLen%=32
  430  handlerTableLen%=handler_Name%+handlerNameLen%
  440
  450handlerMax%=10  :REM  Maximum number of handlers
  460
  470handlerType_Immediate%=0
  480handlerType_CallBack%=1
  490handlerType_Process%=2
  500
  510handlerType_Default%=handlerType_Immediate%
  520
  530REM ---------- Driver table stuff
  540
  550d%=0
  560driver_Address%      =d%:d%+=4
  570driver_Parameter%    =d%:d%+=4
  580driver_Flags%        =d%:d%+=4
  590driver_Volume%       =d%:d%+=4
  600driver_VolumeScaled% =d%:d%+=4
  610driver_Name%         =d%:d%+=4
  620
  630driverTableLen%=d%
  640
  650driverMax%=1  :REM Maximum number of drivers
  660
  670REM Call entries in table
  680
  690A%=0
  700driverEntry_Install%    =A%:A%+=4
  710driverEntry_Remove%     =A%:A%+=4
  720driverEntry_Fill%       =A%:A%+=4
  730driverEntry_SampleRate% =A%:A%+=4
  740driverEntry_Volume%     =A%:A%+=4
  750driverEntry_Mixer%      =A%:A%+=4
  760
  770driverEntryLen%=A%
  780
  790
  800REM --------- Workspace variable offsets
  810
  820A%=0
  830work_memSize%=A%:A%+=4        :REM Current memory size
  840work_privateWord%=A%:A%+=4    :REM R12 module private word pointer
  850work_currentDriver%=A%:A%+=4  :REM Driver = 1,2 or External, 0 = none
  860work_SoundPause%=A%:A%+=4     :REM Pause flag for handler fill code
  870work_SoundActive%=A%:A%+=4    :REM Flag set by handler fill code when active
  880work_SampleFrequency%=A%:A%+=4:REM Current sample frequency
  890work_SamplePeriod%=A%:A%+=4   :REM Current sample period
  900
  910work_ImmediateHandlers%=A%:A%+=4 :REM Bit map of immediate handlers
  920work_CallBackHandlers%=A%:A%+=4 :REM Bit map of call back handlers
  930work_ProcessHandlers%=A%:A%+=4  :REM Bit map of process handlers
  940
  950work_ControlWord%=A%:A%+=4    :REM Control word for Replay
  960A%+=4
  970
  980work_DriverEntryTable%=A%:A%+=driverEntryLen%
  990
 1000work_handlerTable%=A%:A%+=(handlerTableLen%*handlerMax%)
 1010work_driverTable%=A%:A%+=(driverTableLen%*driverMax%)
 1020
 1030
 1040
 1050REM Call back stuff
 1060
 1070work_callBack_Active%              =A%:A%+=4
 1080work_callBack_Count%               =A%:A%+=4
 1090work_CallBack_BufferFullCount%     =A%:A%+=4
 1100work_CallBack_CurrentSoundBuffer%  =A%:A%+=4
 1110work_CallBack_CurrentOutBuffer%    =A%:A%+=4
 1120work_CallBack_BufferSize%          =A%:A%+=4
 1130work_CallBack_Flags%               =A%:A%+=4
 1140work_CallBack_SampleFrequency%     =A%:A%+=4
 1150work_CallBack_SamplePeriod%        =A%:A%+=4
 1160work_CallBack_numCallBackBuffers%  =A%:A%+=4
 1170
 1180IF doCBAI% THEN
 1190   work_CBAIActive%                   =A%:A%+=4
 1200   work_PollWord%                     =A%:A%+=4
 1210ENDIF
 1220
 1230defaultNumCallBackBuffers%=2:REM Was 4
 1240callBackBufferLen%=416*4
 1250
 1260
 1270IF doLog% THEN
 1280
 1290REM Log stuff
 1300
 1310logBits%=13
 1320
 1330work_Log_Handler%=A%:A%+=4
 1340work_Log_Parameter%=A%:A%+=4
 1350work_Log_OldConfigure%=A%:A%+=4*5  :REM The five parameters for Sound_Configure
 1360work_Log_OldLeft%=A%:A%+=4
 1370work_Log_OldRight%=A%:A%+=4
 1380work_Log_ChanTable%=A%:A%+=16
 1390work_OldLogFill%=A%:A%+=4
 1400
 1410work_Log_16BitBuffer%=A% :REM This will be the start of the buffer if required
 1420Log16BitBufferSize%=4000
 1430A%+=Log16BitBufferSize%
 1440
 1450ENDIF
 1460
 1470work_CallBack_Buffer%=A%:A%+=(callBackBufferLen%*defaultNumCallBackBuffers%)
 1480
 1490memoryStart%=A%
 1500
 1510
 1520REM ---------
 1530
 1540
 1550
 1560
 1570ENDPROC
