
The workspace for SharedSound represents the workspace for one driver
activity with a number of associated streams and handlers.
The same code could be used with another instantiation to control the
activity via another output driver.


DEFPROCSetStart
LOCAL er$
er$="Set"
PRINT "PROCSet"

swiBase%=&4B440
Overflow_Flag=1<<28
Zero_Flag=1<<30
Iflag%=&08000000
SVC_Mode%=3

Sound_LinearHandler%=&40145
XSound_LinearHandler%=&60145
Sound_Mode%=&40144
Sound_SampleRate%=&40146

REM Sound flags

soundFlag_Mix%=1
soundFlag_Period%=1<<8
soundFlag_Log%=1<<9

REM --------- Handler table stuff

handler_Address%=0
handler_Parameter%=4
handler_Flags%=8
handler_SampleFrequency%=12
handler_Volume%=16
handler_Type%=20
handler_Fraction%=24
handler_VolumeScaled%=28
handler_Name%=32

  handlerNameLen%=32
  handlerTableLen%=handler_Name%+handlerNameLen%

handlerMax%=10  :REM  Maximum number of handlers

handlerType_Immediate%=0
handlerType_CallBack%=1
handlerType_Process%=2

handlerType_Default%=handlerType_Immediate%

REM ---------- Driver table stuff

d%=0
driver_Address%      =d%:d%+=4
driver_Parameter%    =d%:d%+=4
driver_Flags%        =d%:d%+=4
driver_Volume%       =d%:d%+=4
driver_VolumeScaled% =d%:d%+=4
driver_Name%         =d%:d%+=4

driverTableLen%=d%

driverMax%=1  :REM Maximum number of drivers

REM Call entries in table

A%=0
driverEntry_Install%    =A%:A%+=4
driverEntry_Remove%     =A%:A%+=4
driverEntry_Fill%       =A%:A%+=4
driverEntry_SampleRate% =A%:A%+=4
driverEntry_Volume%     =A%:A%+=4
driverEntry_Mixer%      =A%:A%+=4

driverEntryLen%=A%


REM --------- Workspace variable offsets

A%=0
work_memSize%=A%:A%+=4        :REM Current memory size
work_privateWord%=A%:A%+=4    :REM R12 module private word pointer
work_currentDriver%=A%:A%+=4  :REM Driver = 1,2 or External, 0 = none
work_SoundPause%=A%:A%+=4     :REM Pause flag for handler fill code
work_SoundActive%=A%:A%+=4    :REM Flag set by handler fill code when active
work_SampleFrequency%=A%:A%+=4:REM Current sample frequency
work_SamplePeriod%=A%:A%+=4   :REM Current sample period

work_ImmediateHandlers%=A%:A%+=4 :REM Bit map of immediate handlers
work_CallBackHandlers%=A%:A%+=4 :REM Bit map of call back handlers
work_ProcessHandlers%=A%:A%+=4  :REM Bit map of process handlers

work_ControlWord%=A%:A%+=4    :REM Control word for Replay
A%+=4

work_DriverEntryTable%=A%:A%+=driverEntryLen%

work_handlerTable%=A%:A%+=(handlerTableLen%*handlerMax%)
work_driverTable%=A%:A%+=(driverTableLen%*driverMax%)



REM Call back stuff

work_callBack_Active%              =A%:A%+=4
work_callBack_Count%               =A%:A%+=4
work_CallBack_BufferFullCount%     =A%:A%+=4
work_CallBack_CurrentSoundBuffer%  =A%:A%+=4
work_CallBack_CurrentOutBuffer%    =A%:A%+=4
work_CallBack_BufferSize%          =A%:A%+=4
work_CallBack_Flags%               =A%:A%+=4
work_CallBack_SampleFrequency%     =A%:A%+=4
work_CallBack_SamplePeriod%        =A%:A%+=4
work_CallBack_numCallBackBuffers%  =A%:A%+=4

IF doCBAI% THEN
   work_CBAIActive%                   =A%:A%+=4
   work_PollWord%                     =A%:A%+=4
ENDIF

defaultNumCallBackBuffers%=2:REM Was 4
callBackBufferLen%=416*4


IF doLog% THEN

REM Log stuff

logBits%=13

work_Log_Handler%=A%:A%+=4
work_Log_Parameter%=A%:A%+=4
work_Log_OldConfigure%=A%:A%+=4*5  :REM The five parameters for Sound_Configure
work_Log_OldLeft%=A%:A%+=4
work_Log_OldRight%=A%:A%+=4
work_Log_ChanTable%=A%:A%+=16
work_OldLogFill%=A%:A%+=4

work_Log_16BitBuffer%=A% :REM This will be the start of the buffer if required
Log16BitBufferSize%=4000
A%+=Log16BitBufferSize%

ENDIF

work_CallBack_Buffer%=A%:A%+=(callBackBufferLen%*defaultNumCallBackBuffers%)

memoryStart%=A%


REM ---------




ENDPROC
