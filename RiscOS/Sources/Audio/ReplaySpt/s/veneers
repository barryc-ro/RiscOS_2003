; > veneers.s

; © SJ Middleton, 1995

		GET	os:hdr.macros
		GET	hdr:soundfile

		AREA	|Veneers$$CODE|,CODE,READONLY

; r0 = in
; r1 = out
; r2 = nbytes
; r3 = soundfile_format
; [sp, #0] -> used out

; extern os_error *call_to16_handler(const void *in, void *out, int nbytes, soundfile_format *fmt)

		EXPORT	call_to16_handler
call_to16_handler
		STMFD	sp!, {r1-r12,lr}

    	    	LDR 	r12, [r3, #SoundFile_Format_handler_r12]

		ClrV
		MOVS	lr, pc
		LDR	pc, [r3, #SoundFile_Format_to16_handler]
		MOVVC	r0, #0

    	    	LDR 	r3, [sp, #4*13]	; address of out variable
    	    	CMP 	r3, #0
    	    	LDRNE 	r2, [sp, #0]	; original out value
    	    	SUBNE 	r1, r1, r2  	; n bytes written out
    	    	STRNE 	r1, [r3]

		LDMFD	sp!, {r1-r12,pc}^

		END

eof veneers.s
