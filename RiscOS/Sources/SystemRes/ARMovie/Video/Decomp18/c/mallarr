#include <stdlib.h> /* for size_t*/
#include "dy_malloc.h"

#undef TESET
#ifdef TEST

#include <stdio.h>

int fa[2][3][4][5];
int ****ga;
#endif

int **get2array(int d1,int d2)
{
  int i,c,d;
  int *z;
  int **array;

  c=0;
#ifdef TEST
  array=malloc((size_t)(
                    d1*sizeof(int***)+
                    d1*d2*sizeof(int**)+
		   )
	  );
#else
  array=dy_malloc((size_t)(
                    d1*sizeof(int***)+
                    d1*d2*sizeof(int**)
		   )
	  );
#endif
  if(array==NULL)
   return array;
   z=(int *)array+d1;
  c=0;
  d=d2;
  for(i=0;i<d1;i++)
   {
     array[i]=(int*)(z+c*d);
#ifdef TEST
        printf("g[%d] adr %x = %x \n",i,(int)&array[i],(int)array[i]);
#endif
     c++;
    }

 return array;
}

int ****get4array(int d1,int d2,int d3,int d4)
{
  int i,j,k,c,d;
  int *z;
  int ****array;

  c=0;
#ifdef TEST
  array=malloc((size_t)(
                    d1*sizeof(int***)+
                    d1*d2*sizeof(int**)+
                    d1*d2*d3*sizeof(int*)+
		    d1*d2*d3*d4*sizeof(int)
		   )
	  );
#else
  array=dy_malloc((size_t)(
                    d1*sizeof(int***)+
                    d1*d2*sizeof(int**)+
                    d1*d2*d3*sizeof(int*)+
		    d1*d2*d3*d4*sizeof(int)
		   )
	  );
#endif
  if(array==NULL)
   return array;
   z=(int *)array+d1;
  c=0;
  d=d2;
  for(i=0;i<d1;i++)
   {
     array[i]=(int***)(z+c*d);
#ifdef TEST
        printf("g[%d] adr %x = %x \n",i,(int)&array[i],(int)array[i]);
#endif
     c++;
    }
  d=d3;
  c=0;
  z+=d1*d2;
  for(i=0;i<d1;i++)
   for(j=0;j<d2;j++)
    {
     array[i][j]=(int**)(z+c*d);
#ifdef TEST
        printf("g[%d][%d] adr %x = %x \n",i,j,(int)&array[i][j],(int)array[i][j]);
#endif
     c++;
     }
  d=d4;
  z+=d1*d2*d3;
  c=0;
  for(i=0;i<d1;i++)
   for(j=0;j<d2;j++)
    for(k=0;k<d3;k++)
     {
        array[i][j][k]=(int*)(z+c*d);
#ifdef TEST
        printf("g[%d][%d][%d] adr %x = %x \n",i,j,k,(int)&array[i][j][k],(int)array[i][j][k]);
#endif
        c++;
      }

 return array;
}


#ifdef TEST
int main(argc,argv)
int argc;
char *argv[];
{
  int i,j,k,l,c=0;
  for(l=0;l<2;l++)
   for(k=0;k<3;k++)
    for(j=0;j<4;j++)
     for(i=0;i<5;i++)
      {
       c++;
       fa[l][k][j][i]=c;
      }
  ga=get4array(2,3,4,5);
  if(ga==NULL)
   {
     printf("malloc failed\n");
     exit(1);
   }

  for(i=0;i<2;i++)
   for(j=0;j<3;j++)
    for(k=0;k<3;k++)
     for(l=0;l<5;l++)
      {
        ga[i][j][k][l]=fa[i][j][k][l];
        printf("g[%d][%d][%d][%d] adr %x = %d \n",i,j,k,l,(int)&ga[i][j][k][l],ga[i][j][k][l]);

      }

}
#endif
