;blatasm.s

	AREA	|Test$$Code|,CODE,READONLY

	EXPORT	blatinit
	EXPORT	blatshut
	EXPORT	blatdecomp
	EXPORT	blatCdecomp
	EXPORT	fetchinit
	EXPORT	fetchshut
	EXPORT	fetchfetch
	EXPORT	fetchrelbuff

parm	DCB	"PARM"
shut	DCB	"SHUT"

blatinit
	stmfd	r13!,{r1-r12,lr}	;This is too many, but I can't be bothered to change it.
	mov	r4,r2
	ldr	r2,parm
	add	r4,r4,#4
	mov     r14,pc		;store link
	mov	pc,r4		;call init here.
	movvc	r0,#0
	ldmfd	r13!,{r1-r12,r15}^

blatshut
	stmfd	r13!,{r4-r12,lr}	;This is too many, but I can't be bothered to change it.
	mov	r4,r2
	ldr	r2,shut

	add	r4,r4,#4
	mov     r14,pc		;store link
	mov	pc,r4		;call init here.
	movvc	r0,#0

	ldmfd	r13!,{r4-r12,r15}^


blatdecomp
	stmfd	r13!,{r4-r12,lr}

	add	r3,r3,#8
	mov	r4,pc		;store link
	mov	pc,r3		;call decomp here

	ldmfd	r13!,{r4-r12,r15}^

blatCdecomp
	stmfd	r13!,{r4-r12,lr}

	add	r3,r3,#8
	mov	r14,pc		;store link
	mov	pc,r3		;call decomp here

	ldmfd	r13!,{r4-r12,r15}^

fetchinit
	stmfd	r13!,{r4-r12,lr}
	ldr	r4,[r13,#40]
	ldr	r5,[r13,#44]
	mov	r14,pc
	mov	pc,r5
	ldmfd	r13!,{r4-r12,pc}^

fetchshut
	stmfd	r13!,{r4-r12,lr}
	add	r0,r0,#4
	mov	r14,pc
	mov	pc,r0
	ldmfd	r13!,{r4-r12,pc}^
fetchfetch
	stmfd	r13!,{r4-r12,lr}
	add	r3,r3,#8
	mov	r14,pc
	mov	pc,r3
	teq 	r2,#0
	strne	r1,[r2]
	ldmfd	r13!,{r4-r12,pc}^
fetchrelbuff
	stmfd	r13!,{r4-r12,lr}
	add	r2,r2,#12
	mov	r14,pc
	mov	pc,r2
	ldmfd	r13!,{r4-r12,pc}^



	END
