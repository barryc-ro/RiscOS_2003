# Makefile for Boot
#
# ***********************************
# ***    C h a n g e   L i s t    ***
# ***********************************
# Date           Name   Description
# ----           ----   -----------
# 15th Nov 1994  JRC    Black Boot edifice created
# 21st Nov 1994  AMcC   Added ResetBoot
# 29th Nov 1994  AMcC   Made separate rule for installing Configure dir (Monitors etc)
#                       Now installs required Monitors by name
#  5th Jan 1995  AMcC   VProtect modsqz'd
#  9th Jan 1995  JRC    Squeeze LoadCMOS, SafeLogon, ClrMonitor
# 30th Jan 1995  AMcC   Corrected access permissions (files in Choices mustn't be locked)
#                       Extracted common bits into separate rules
# 30th Jan 1995  AMcC   ResetBoot - install phase depends on install_Configure
#                                 - install its own !Run file (not the common one)
# 13th Feb 1995  AMcC   ResetBoot - don't install_Configure
# 27th Mar 1995  AMcC   Removed AKF70 from install_configure rule
#

#
# Program specific options:
#
#COMPONENT = ...
#   This must be set on the command line to one of Boot, ShareBoot,
#   ArmBoot, ResetBoot. Case is important. INSTDIR must also set, as usual.
APP        = !${COMPONENT}
RDIR       = ${COMPONENT}
LDIR       = ${RDIR}.${LOCALE}
INSTDIR    = ${INSTDIR}.${APP}
RESOURCES  = ${INSTDIR}.Resources

VPATH = @ <Support$Dir>

#
# Generic options:
#
MKDIR   = cdir
AS      = objasm
ATTR    = -attr
CC      = cc
CMHG    = cmhg
CP      = copy
LD      = link
RM      = remove
SQUEEZE = squeeze
WIPE    = -wipe

AFLAGS  = ${THROWBACK} -depend !Depend -nocache -stamp -quit
CFLAGS  = ${THROWBACK} -c -depend !Depend -fafh ${INCLUDES} ${DFLAGS} -wp
CPFLAGS = ~cfr~v
SQFLAGS = -f
WFLAGS  = ~c~vr

#
# Libraries
#
CLIB      = CLib:o.Stubs
OSLIB     = OSLib:o.OSLib
ROMSTUBS  = RISC_OSLib:o.ROMStubs
ABSSYM    = RISC_OSLib:o.AbsSym
WRAPPER   = RISC_OSLib:s.ModuleWrap

LIBSD     = ${RLIB} ${CLIB}

#
# Include files
#
INCLUDES  = -IOS:,Support:

FILES = \
   Library.AddApp \
   Library.AppSize \
   Utils.BootVars \
   Library.Do \
   Library.IfThere \
   Library.LoadCMOS \
   Library.SafeLogon \
   RO350Hook.Boot.PreDesk.MemFix \
   Utils.FreePool \
   Utils.VProtect \
   ClrMonitor

#
# Rule patterns
#
.SUFFIXES: .oz .od .asm .o .Source .c
.c.o:;    ${CC} ${CFLAGS} -ff -o $@ $<
.c.oz:;   ${CC} ${CFLAGS} -ff -zM -zps1 -o $@ $<
.c.od:;   ${CC} ${CFLAGS} -DTRACE=1 -g -o $@ $<
.asm.o:;  ${AS} ${AFLAGS} $< $@
.asm.od:; ${AS} ${AFLAGS} -g $< $@

#
# Main rules:
#
all: ${FILES}
        @echo ${COMPONENT}: Application built (Disc)

install: set_access install_${COMPONENT}
   @echo ${COMPONENT}: installed (Disc)

install_Boot: install_Configure install_appfiles ${FILES}
   ${MKDIR}                                     ${INSTDIR}.Choices
   ${CP} RO360Hook.Boot                         ${INSTDIR}.Choices.Boot ${CPFLAGS}
   ${CP} RO360Hook.Desktop                      ${INSTDIR}.Choices.Boot.Desktop ${CPFLAGS}
   ${CP} RO360Hook.PreDesktop                   ${INSTDIR}.Choices.Boot.PreDesktop ${CPFLAGS}
   ${CP} Utils                                  ${INSTDIR}.Utils ${CPFLAGS}
   ${MKDIR}                                     ${INSTDIR}.Library
   @Echo Deleting superfluous files ...
   ${WIPE} ${INSTDIR}.Utils.NetBye ${WFLAGS}

install_ArmBoot: install_Configure install_appfiles ${FILES}
   ${MKDIR}                                     ${INSTDIR}.Choices
   ${CP} RO360Hook.Boot                         ${INSTDIR}.Choices.Boot ${CPFLAGS}
   ${CP} RO360Hook.DesktopBye                   ${INSTDIR}.Choices.Boot.Desktop ${CPFLAGS}
   ${CP} RO360Hook.PreDesktop                   ${INSTDIR}.Choices.Boot.PreDesktop ${CPFLAGS}
   ${CP} Library                                ${INSTDIR}.Library ${CPFLAGS}
   ${CP} Utils                                  ${INSTDIR}.Utils ${CPFLAGS}
   | RO2 machines need unmodsqz'd VProtect
   ${CP} rm.VProtect                            ${INSTDIR}.Utils.VProtect ${CPFLAGS}
   ${MKDIR}                                     ${INSTDIR}.Utils.RO200Hook
   ${CP} RO200Hook.Boot                         ${INSTDIR}.Utils.RO200Hook.Boot ${CPFLAGS}
   ${CP} RO200Hook.DesktopBye                   ${INSTDIR}.Utils.RO200Hook.Boot.Desktop ${CPFLAGS}
   ${CP} RO200Hook.PreDesktop                   ${INSTDIR}.Utils.RO200Hook.Boot.PreDesktop ${CPFLAGS}
   ${MKDIR}                                     ${INSTDIR}.Utils.RO310Hook
   ${CP} RO310Hook.Boot                         ${INSTDIR}.Utils.RO310Hook.Boot ${CPFLAGS}
   ${CP} RO310Hook.DesktopBye                   ${INSTDIR}.Utils.RO310Hook.Boot.Desktop ${CPFLAGS}
   ${CP} RO310Hook.PreDesktop                   ${INSTDIR}.Utils.RO310Hook.Boot.PreDesktop ${CPFLAGS}
   ${MKDIR}                                     ${INSTDIR}.Utils.RO350Hook
   ${CP} RO350Hook.Boot                         ${INSTDIR}.Utils.RO350Hook.Boot ${CPFLAGS}
   ${CP} RO350Hook.DesktopBye                   ${INSTDIR}.Utils.RO350Hook.Boot.Desktop ${CPFLAGS}
   ${CP} RO350Hook.PreDesktop                   ${INSTDIR}.Utils.RO350Hook.Boot.PreDesktop ${CPFLAGS}
   @Echo Deleting superfluous files ...
   ${WIPE}                                      ${INSTDIR}.Choices.Boot.PreDesk.SetUpNet ${WFLAGS}

install_ShareBoot: install_Configure install_appfiles ${FILES}
   ${MKDIR}                                     ${INSTDIR}.Choices
   ${CP} RO360Hook.Boot                         ${INSTDIR}.Choices.Boot ${CPFLAGS}
   ${CP} RO360Hook.Desktop                      ${INSTDIR}.Choices.Boot.Desktop ${CPFLAGS}
   ${CP} RO360Hook.PreDesktop                   ${INSTDIR}.Choices.Boot.PreDesktop ${CPFLAGS}
   ${CP} Library                                ${INSTDIR}.Library ${CPFLAGS}
   ${CP} Utils                                  ${INSTDIR}.Utils ${CPFLAGS}
   ${MKDIR}                                     ${INSTDIR}.Utils.RO310Hook
   ${CP} RO310Hook.Boot                         ${INSTDIR}.Utils.RO310Hook.Boot ${CPFLAGS}
   ${CP} RO310Hook.Desktop                      ${INSTDIR}.Utils.RO310Hook.Boot.Desktop ${CPFLAGS}
   ${CP} RO310Hook.PreDesktop                   ${INSTDIR}.Utils.RO310Hook.Boot.PreDesktop ${CPFLAGS}
   ${MKDIR}                                     ${INSTDIR}.Utils.RO350Hook
   ${CP} RO350Hook.Boot                         ${INSTDIR}.Utils.RO350Hook.Boot ${CPFLAGS}
   ${CP} RO350Hook.Desktop                      ${INSTDIR}.Utils.RO350Hook.Boot.Desktop ${CPFLAGS}
   ${CP} RO350Hook.PreDesktop                   ${INSTDIR}.Utils.RO350Hook.Boot.PreDesktop ${CPFLAGS}
   @Echo Deleting superfluous files ...
   ${WIPE}                                      ${INSTDIR}.Choices.Boot.PreDesk.SetUpNet ${WFLAGS}
   ${WIPE}                                      ${INSTDIR}.Utils.NetBye ${WFLAGS}

install_ResetBoot:
   ${MKDIR}                                     ${INSTDIR}
   ${CP} ${RDIR}.!Help                          ${INSTDIR}.!Help ${CPFLAGS}
   ${ATTR} -ol +ow                              ${INSTDIR}.!HelpText
   Kitten Version ${LDIR}.!HelpText           > ${INSTDIR}.!HelpText
   ${CP} ${LDIR}.!Run                           ${INSTDIR}.!Run ${CPFLAGS}
   ${CP} ${RDIR}.!RunImage                      ${INSTDIR}.!RunImage ${CPFLAGS}
   ${CP} ${LDIR}.!Sprites                       ${INSTDIR}.!Sprites ${CPFLAGS}
   ${CP} ${LDIR}.!Sprites22                     ${INSTDIR}.!Sprites22 ${CPFLAGS}
   ${CP} ${LDIR}.Messages                       ${INSTDIR}.Messages ${CPFLAGS}
   ${MKDIR}                                     ${INSTDIR}.Choices
   ${CP} RO360Hook.Boot                         ${INSTDIR}.Choices.Boot ${CPFLAGS}
   ${CP} RO360Hook.Desktop                      ${INSTDIR}.Choices.Boot.Desktop ${CPFLAGS}
   ${CP} RO360Hook.PreDesktop                   ${INSTDIR}.Choices.Boot.PreDesktop ${CPFLAGS}

install_appfiles:
   ${MKDIR}                                     ${INSTDIR}
   ${CP} ${LDIR}.!Boot                          ${INSTDIR}.!Boot ${CPFLAGS}
   ${ATTR} -ol +ow                              ${INSTDIR}.!Help
   Kitten Version ${LDIR}.!Help               > ${INSTDIR}.!Help
   ${CP} Source.!Run                            ${INSTDIR}.!Run ${CPFLAGS}
   ${CP} ${RDIR}.!Sprites                       ${INSTDIR}.!Sprites ${CPFLAGS}
   ${CP} ${RDIR}.!Sprites22                     ${INSTDIR}.!Sprites22 ${CPFLAGS}

install_Configure:
   ${MKDIR}                               ${INSTDIR}
   ${MKDIR}                               ${INSTDIR}.Choices
   ${MKDIR}                               ${INSTDIR}.Choices.Boot
   ${MKDIR}                               ${RESOURCES}
   ${MKDIR}                               ${RESOURCES}.Configure
   ${MKDIR}                               ${RESOURCES}.Configure.Monitors
   ${MKDIR}                               ${RESOURCES}.Configure.Monitors.Acorn
   ${CP} ClrMonitor                       ${RESOURCES}.Configure.ClrMonitor ${CPFLAGS}
   ${CP} Configure.2DTools                ${RESOURCES}.Configure.2DTools    ${CPFLAGS}
   ${CP} Configure.FontChange             ${RESOURCES}.Configure.FontChange ${CPFLAGS}
   ${CP} Configure.Monitors.Acorn.AKF50   ${RESOURCES}.Configure.Monitors.Acorn.AKF50 ${CPFLAGS}
   ${CP} Configure.Monitors.Acorn.AKF52   ${RESOURCES}.Configure.Monitors.Acorn.AKF52 ${CPFLAGS}
   ${CP} Configure.Monitors.Acorn.AKF53   ${RESOURCES}.Configure.Monitors.Acorn.AKF53 ${CPFLAGS}
   ${CP} Configure.Monitors.Acorn.AKF60   ${RESOURCES}.Configure.Monitors.Acorn.AKF60 ${CPFLAGS}
   ${CP} Configure.Monitors.Acorn.AKF85   ${RESOURCES}.Configure.Monitors.Acorn.AKF85 ${CPFLAGS}
   ${CP} Configure.Textures               ${RESOURCES}.Configure.Textures  ${CPFLAGS}

set_access:
   ${ATTR} -directories +wr ${INSTDIR}
   ${ATTR} -files +ol +or -ow +wr -ww ${INSTDIR}
   ${ATTR} -files -ol +ow ${INSTDIR}.Choices

clean:
   ${WIPE} Library.AddApp ${WFLAGS}
   ${WIPE} Library.AppSize ${WFLAGS}
   ${WIPE} Utils.BootVars ${WFLAGS}
   ${WIPE} Source.BootVars.o.main ${WFLAGS}
   ${WIPE} Source.BootVars.o.x ${WFLAGS}
   ${WIPE} Source.BootVars.o.socket ${WFLAGS}
   ${WIPE} Library.Do ${WFLAGS}
   ${WIPE} Library.IfThere ${WFLAGS}
   ${WIPE} Library.LoadCMOS ${WFLAGS}
   ${WIPE} Source.LoadCMOS.o.main ${WFLAGS}
   ${WIPE} Source.LoadCMOS.o.x ${WFLAGS}
   ${WIPE} Library.SafeLogon ${WFLAGS}
   ${WIPE} Source.SafeLogon.o.main ${WFLAGS}
   ${WIPE} ClrMonitor ${WFLAGS}
   ${WIPE} Source.ClrMonitor.o.main ${WFLAGS}
   ${WIPE} Utils.FreePool ${WFLAGS}
   ${WIPE} Utils.VProtect ${WFLAGS}
   ${WIPE} RO350Hook.Boot.PreDesk.MemFix ${WFLAGS}
   @echo ${COMPONENT}: cleaned

clean_all:
   -Destroy Library.AddApp Library.AppSize Utils.BootVars \
         Source.BootVars.o.main Source.BootVars.o.x Source.BootVars.o.socket Library.Do \
         Library.IfThere Library.LoadCMOS Source.LoadCMOS.o.main \
         Source.LoadCMOS.o.x Library.SafeLogon Source.SafeLogon.o.main \
         ClrMonitor Source.ClrMonitor.o.main Utils.FreePool Utils.VProtect \
         RO350Hook.Boot.PreDesk.MemFix
   ${ATTR} -ol ${INSTDIR}
   ${WIPE} ${INSTDIR} ${WFLAGS}
#
# Static dependencies:
#
Source.BootVars.o.main: Source.BootVars.c.main
   cc410 ${CFLAGS} -D__swi -ff -o Source.BootVars.o.main Source.BootVars.c.main

Library.AddApp: Source.AddApp.Source.AddApp
   AAsm ${AFLAGS} Source.AddApp.Source.AddApp Library.AddApp -stamp -quit
   SetType Library.AddApp Utility

Library.AppSize: Source.AppSize.Source.AppSize
   AAsm ${AFLAGS} Source.AppSize.Source.AppSize Library.AppSize -stamp -quit
   SetType Library.AppSize Utility

Utils.BootVars: Source.BootVars.o.main Source.BootVars.o.x Source.BootVars.o.socket
   ${LD} ${LDFLAGS} -o Utils.BootVars Source.BootVars.o.main Source.BootVars.o.x \
         Source.BootVars.o.socket ${OSLIB} CLib:o.ANSILib
   ${SQUEEZE} $@

Library.Do: Source.Do.Source.Do
   AAsm ${AFLAGS} Source.Do.Source.Do Library.Do -stamp -quit
   SetType Library.Do Utility

Library.IfThere: Source.IfThere.Source.IfThere
   AAsm ${AFLAGS} Source.IfThere.Source.IfThere Library.IfThere -stamp -quit
   SetType Library.IfThere Utility

Library.LoadCMOS: Source.LoadCMOS.o.main Source.LoadCMOS.o.x
   ${LD} ${LDFLAGS} -o $@ Source.LoadCMOS.o.main Source.LoadCMOS.o.x ${OSLIB} ${CLIB}
   ${SQUEEZE} $@

Library.SafeLogon: Source.SafeLogon.o.main
   ${LD} ${LDFLAGS} -o $@ Source.SafeLogon.o.main ${OSLIB} ${CLIB}
   ${SQUEEZE} $@

ClrMonitor: Source.ClrMonitor.o.main
   ${LD} ${LDFLAGS} -o $@ Source.ClrMonitor.o.main ${CLIB}
   ${SQUEEZE} $@

Utils.FreePool: Source.FreePool.Source.FreePool
   AAsm ${AFLAGS} Source.FreePool.Source.FreePool Utils.FreePool -stamp -quit
   SetType Utils.FreePool Utility

Utils.VProtect: rm.VProtect
   ModSqz rm.VProtect $@

RO350Hook.Boot.PreDesk.MemFix: Source.MemFix.Source.MemFix
   AAsm ${AFLAGS} Source.MemFix.Source.MemFix RO350Hook.Boot.PreDesk.MemFix -stamp -quit
   SetType RO350Hook.Boot.PreDesk.MemFix Utility

Source.LoadCMOS.o.x: <Support$Dir>.c.x
   ${CC} ${CFLAGS} -ff -o Source.LoadCMOS.o.x <Support$Dir>.c.x

Source.BootVars.o.x: <Support$Dir>.c.x
   ${CC} ${CFLAGS} -ff -o Source.BootVars.o.x <Support$Dir>.c.x

Source.BootVars.o.socket: <Support$Dir>.def.socket
   DefMod -l -o l.socket < <Support$Dir>.def.socket
   LibFile -c -o Source.BootVars.o.socket -via ViaFile
   Wipe l.socket ~C~FR~V

Source.BootVars.h.socket: <Support$Dir>.def.socket
   DefMod -h < <Support$Dir>.def.socket > $@

#---------------------------------------------------------------------------
# Library.AddApp: Hdr:ListOpts
# Dynamic dependencies:
Library.AddApp: Hdr:ListOpts
Library.AddApp: Hdr:Macros
Library.AddApp: Hdr:System
Library.AddApp: Hdr:SWIs
Library.AddApp: Hdr:CPU.Generic26
Library.AddApp: Hdr:IO.GenericIO
Library.AddApp: Hdr:RISCOS
Library.AddApp: Hdr:Proc
Library.AddApp: Hdr:ModHand
Library.AddApp: Hdr:ResourceFS
Library.AppSize: Hdr:ListOpts
Library.AppSize: Hdr:Macros
Library.AppSize: Hdr:System
Library.AppSize: Hdr:SWIs
Library.AppSize: Hdr:CPU.Generic26
Library.AppSize: Hdr:IO.GenericIO
Library.AppSize: Hdr:RISCOS
Library.AppSize: Hdr:Proc
Library.AppSize: Hdr:ModHand
Library.AppSize: Hdr:NDRDebug
Source.BootVars.o.main:	Source.BootVars.c.main
Source.BootVars.o.main:	C:h.swis
Source.BootVars.o.main:	C:h.kernel
Source.BootVars.o.main:	Source.BootVars.h.socket
Source.BootVars.o.main:	OS:h.types
Source.BootVars.o.main:	OS:h.os
Source.BootVars.o.main:	Support:h.trace
Source.BootVars.o.main:	Support:h.x
Source.BootVars.o.main:	OS:h.econet
Source.BootVars.o.main:	OS:h.netfs
Source.BootVars.o.main:	OS:h.macros
Source.BootVars.o.main:	OS:h.os
Source.BootVars.o.main:	OS:h.osbyte
Source.BootVars.o.main:	OS:h.osfscontrol
Source.BootVars.o.main:	OS:h.osmodule
Source.BootVars.o.main:	OS:h.wimpreadsysinfo
Source.BootVars.o.main:	OS:h.wimp
Source.BootVars.o.main:	OS:h.osspriteop
Source.BootVars.o.main:	OS:h.font
Source.BootVars.o.x:	<Support$Dir>.c.x
Source.BootVars.o.x:	C:h.kernel
Source.BootVars.o.x:	OS:h.macros
Source.BootVars.o.x:	OS:h.os
Source.BootVars.o.x:	OS:h.types
Source.BootVars.o.x:	<Support$Dir>.h.x
Library.Do: Hdr:ListOpts
Library.Do: Hdr:Macros
Library.Do: Hdr:System
Library.Do: Hdr:SWIs
Library.Do: Hdr:CPU.Generic26
Library.Do: Hdr:IO.GenericIO
Library.Do: Hdr:RISCOS
Library.IfThere: Hdr:ListOpts
Library.IfThere: Hdr:Macros
Library.IfThere: Hdr:System
Library.IfThere: Hdr:SWIs
Library.IfThere: Hdr:CPU.Generic26
Library.IfThere: Hdr:IO.GenericIO
Library.IfThere: Hdr:RISCOS
Library.IfThere: Hdr:Proc
Library.IfThere: Hdr:ModHand
Library.IfThere: Hdr:ResourceFS
Source.LoadCMOS.o.main:	Source.LoadCMOS.c.main
Source.LoadCMOS.o.main:	OS:h.os
Source.LoadCMOS.o.main:	OS:h.types
Source.LoadCMOS.o.main:	OS:h.osbyte
Source.LoadCMOS.o.main:	OS:h.osfile
Source.LoadCMOS.o.main:	OS:h.osfind
Source.LoadCMOS.o.main:	OS:h.osgbpb
Source.LoadCMOS.o.main:	Support:h.x
Source.LoadCMOS.o.x:	<Support$Dir>.c.x
Source.LoadCMOS.o.x:	C:h.kernel
Source.LoadCMOS.o.x:	OS:h.macros
Source.LoadCMOS.o.x:	OS:h.os
Source.LoadCMOS.o.x:	OS:h.types
Source.LoadCMOS.o.x:	<Support$Dir>.h.x
Source.SafeLogon.o.main:	Source.SafeLogon.c.main
Source.SafeLogon.o.main:	OS:h.econet
Source.SafeLogon.o.main:	OS:h.types
Source.SafeLogon.o.main:	OS:h.os
Source.SafeLogon.o.main:	OS:h.netfs
Source.SafeLogon.o.main:	OS:h.os
Source.SafeLogon.o.main:	OS:h.territory
Source.SafeLogon.o.main:	Support:h.trace
RO350Hook.Boot.PreDesk.MemFix: Hdr:ListOpts
RO350Hook.Boot.PreDesk.MemFix: Hdr:Macros
RO350Hook.Boot.PreDesk.MemFix: Hdr:System
RO350Hook.Boot.PreDesk.MemFix: Hdr:SWIs
RO350Hook.Boot.PreDesk.MemFix: Hdr:CPU.Generic26
RO350Hook.Boot.PreDesk.MemFix: Hdr:IO.GenericIO
RO350Hook.Boot.PreDesk.MemFix: Hdr:RISCOS
Utils.FreePool: OS:Hdr.Macros
Utils.FreePool: OS:Hdr.OS
Utils.FreePool: OS:Hdr.Types
Utils.FreePool: OS:Hdr.Wimp
Utils.FreePool: OS:Hdr.OSSpriteOp
Utils.FreePool: OS:Hdr.Font
Source.ClrMonitor.o.main:	Source.ClrMonitor.c.main
Source.ClrMonitor.o.main:	C:h.swis
Source.ClrMonitor.o.main:	C:h.kernel
