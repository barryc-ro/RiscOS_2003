#include "swis.h"

#include "Desk.LinkList.h"
#include "Desk.DeskMem.h"
#include "Desk.Debug.h"
#include "Desk.Error2.h"
#include "Desk.Str.h"

#include "StartTask.h"
#include "Task.h"



typedef struct	{
	Desk_linklist_header		header;
	const char*			command;
	TaskModule_starttask_callbackfn	fn;
	void*				pw;
	}
	TaskModule_starttask_block;


static void	TaskModule_StartTask_FreeBlock( TaskModule_starttask_block* starttask)
	{
	Desk_DeskMem_Free( (void*) starttask->command);
	Desk_DeskMem_Free( starttask);
	}


void	TaskModule_StartTask_Register( const char* command, TaskModule_starttask_callbackfn fn, void* pw)
	{
	TaskModule_starttask_block*	starttask = Desk_DeskMem_MallocType( TaskModule_starttask_block);
	starttask->command = NULL;
	
	Desk_Debug_Printf( Desk_error_PLACE "TaskModule_StartTask_Register called for command '%s'\n", command);
	
	Desk_Error2_Try	{
		starttask->command	= Desk_strdup( command);
		starttask->fn		= fn;
		starttask->pw		= pw;
		}
	Desk_Error2_Catch	{
		TaskModule_StartTask_FreeBlock( starttask);
		Desk_Error2_ReThrow();
		}
	Desk_Error2_EndCatch
	
	Desk_LinkList_AddToTail( &TaskModule_globalblock.starttasks, &starttask->header);
	
	TaskModule_globalblock.pollword++;
	}


Desk_bool	TaskModule_StartTask_NonZeroPollWordHandler( Desk_event_pollblock* event, void* reference)
	{
	TaskModule_block*		app = (TaskModule_block*) reference;
	TaskModule_starttask_block*	starttask;
	
	Desk_Debug_Printf( Desk_error_PLACE "TaskModule_StartTask_NonZeroPollWordHandler called, pollword=%i\n", app->pollword);
	
	for	(
		starttask = Desk_LinkList_FirstItem( &TaskModule_globalblock.starttasks);
		starttask;
		)
		{
		TaskModule_starttask_block*	next = Desk_LinkList_NextItem( &starttask->header);
		
		Desk_Debug_Printf( Desk_error_PLACE "Calling Wimp_StartTask\n");
		
		if ( starttask->fn)	TaskModule_StartTask_CallStartTaskWithCallback( starttask->command, starttask->fn, starttask->pw);
		else			_swix( Wimp_StartTask, _IN(0), starttask->command);
		
		TaskModule_globalblock.pollword--;
		
		Desk_LinkList_Unlink( &TaskModule_globalblock.starttasks, &starttask->header);
		TaskModule_StartTask_FreeBlock( starttask);
		
		Desk_Debug_Printf( Desk_error_PLACE "Called Wimp_StartTask\n");
		starttask = next;
		}
	
	Desk_Debug_Printf( Desk_error_PLACE "TaskModule_Send_NonZeroPollWordHandler returning\n");
	return Desk_bool_FALSE;
	
	Desk_UNUSED( event);
	}
