#include <stddef.h>
#include "kernel.h"

#include "Desk.Debug.h"
#include "Desk.Event.h"
#include "Desk.DeskMem.h"
#include "Desk.WimpSWIs.h"

#include "ModMalloc.ModMalloc.h"

#include "^.Task.h"
#include "^.Service.h"

#include "StartTask.h"
#include "Send.h"
#include "FRedraw.h"



TaskModule_block	TaskModule_globalblock;


static Desk_bool	QuitHandler( Desk_event_pollblock* event, void* reference)
	{
	TaskModule_block*	app = (TaskModule_block*) reference;
	if ( event->data.message.header.action == Desk_message_QUIT)	{
		app->quit = Desk_bool_TRUE;
		Desk_Debug_Printf( Desk_error_PLACE "QuitHandler detected message_QUIT\n");
		}
	return Desk_bool_FALSE;
	}



Desk_os_error*	TaskModule_Task( const char *args )
	{
	//Desk_DeskMem_SetAllocFunctions( ModMalloc_Malloc, ModMalloc_Realloc, ModMalloc_Calloc, ModMalloc_Free, NULL);
	
	//Desk_Debug_Initialise();
	/*Desk_Debug_SetNestingIndentation( "  ");*/
	Desk_Debug_Printf( Desk_error_PLACE "TaskModule_Task_Initialise called, taskhandle=%i\n", Desk_Event_taskhandle);
	
	Desk_Debug_Printf( Desk_error_PLACE "Current stack chunk is:\n");
	Desk_Debug_PrintMemory( _kernel_current_stack_chunk(), sizeof( _kernel_stack_chunk));
	
	//Desk_Error2_Init_JumpSig();
	
	#ifdef Desk_DEBUG
		{
		void*	p = ModMalloc_Malloc( 32);
		ModMalloc_Free( p);
		}
	#endif
	
	if ( Desk_Event_taskhandle == -1 )	{
		TaskModule_block*	app = &TaskModule_globalblock;
		
		app->quit	= Desk_bool_FALSE;
		
			{
			int	mess[] = { 0};
			Desk_Event_Initialise3( "TaskModule", 310, mess);
			Desk_Debug_Printf( Desk_error_PLACE "Task handle = 0x%x\n", Desk_Event_taskhandle);
			}
		
		Desk_Error2_Try	{
			Desk_Event_Claim( Desk_event_USERMESSAGE, Desk_event_ANY, Desk_event_ANY, QuitHandler, app);
			Desk_Event_Claim( Desk_event_USERMESSAGE, Desk_event_ANY, Desk_event_ANY, TaskModule_Send_MessageHandler, app);
			Desk_Event_Claim( Desk_event_USERMESSAGERECORDED, Desk_event_ANY, Desk_event_ANY, TaskModule_Send_MessageHandler, app);
			Desk_Event_Claim( Desk_event_ACK, Desk_event_ANY, Desk_event_ANY, TaskModule_Send_MessageHandler, app);
			
			Desk_Event_Claim( Desk_event_NONZEROPOLLWORD, Desk_event_ANY, Desk_event_ANY, TaskModule_Send_NonZeroPollWordHandler, app);
			Desk_Event_Claim( Desk_event_NONZEROPOLLWORD, Desk_event_ANY, Desk_event_ANY, TaskModule_Service_NonZeroPollWordHandler, app);
			Desk_Event_Claim( Desk_event_NONZEROPOLLWORD, Desk_event_ANY, Desk_event_ANY, TaskModule_StartTask_NonZeroPollWordHandler, app);
			Desk_Event_Claim( Desk_event_NONZEROPOLLWORD, Desk_event_ANY, Desk_event_ANY, TaskModule_ForceRedraw_NonZeroPollWordHandler, app);
			
			while ( !app->quit)	{
				Desk_Wimp_Poll3( Desk_Event_mask, &Desk_Event_lastevent, &app->pollword);
				Desk_Debug3_Printf( Desk_error_PLACE "Received event %i\n", Desk_Event_lastevent.type);
				Desk_Event_Process( &Desk_Event_lastevent);
				Desk_Debug3_Printf( Desk_error_PLACE "Processed event\n");
				}
			
			Desk_Debug_Printf( Desk_error_PLACE "Calling CloseDown, taskhandle=%i\n", Desk_Event_taskhandle);
			Desk_Event_CloseDown();
			Desk_Debug_Printf( Desk_error_PLACE "Called CloseDown, taskhandle=%i\n", Desk_Event_taskhandle);
			}
		
		Desk_Error2_Catch	{
			Desk_Debug_DescribeError2( &Desk_Error2_globalblock);
			Desk_Event_CloseDown();
			}
		Desk_Error2_EndCatch
		
		}
	
	//ModMalloc_FreeAll();
	return NULL;
	
	Desk_UNUSED( args );
	}


