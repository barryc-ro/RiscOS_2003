/*************************************************************************
Copyright [2000] Pace Micro Technology PLC. All rights reserved.

The copyright in this material is owned by Pace Micro Technology PLC
("Pace"). This material is regarded as highly confidential trade secret
of Pace. It may not be reproduced, used, sold or in any other way exploited
or transferred to any third party without the prior written permission of
Pace.
*************************************************************************/

#include <stdbool.h>
#include "sensor.h"

#include "swis.h"


/***********************************************************************/
/*    SENSOR MEMBER FUNCTIONS. SENSOR IS AN ABSTRACT CLASS            */
/**********************************************************************/

// read the output of the adc and record the data
void sensor::measurement(void)
{
     unsigned int mouse_x_pos, mouse_y_pos;
     unsigned int mouse_buttons;
     PRESSURE_LEVEL touch = LIGHT;

     // for test purposes, the mouse and pointer have been
     // dis-associated. here we will need to determine first
     // what we are supposed to be measuring and then read the actual
     // mouse position and return the appropriate position

     _swix(OS_Mouse, _OUTR(0, 2), &mouse_x_pos, &mouse_y_pos,
                                    &mouse_buttons);

     switch(type)
     {

            case CONFIGURED_FOR_X_MEASUREMENT:
                 measurement_data = mouse_x_pos;
                 break;

            case CONFIGURED_FOR_Y_MEASUREMENT:
                 measurement_data = mouse_y_pos;
                 break;

            case CONFIGURED_FOR_RESISTANCE_MEASUREMENT:
                 measurement_data = 1000;
                 break;

            case CONFIGURED_FOR_PRESSURE_MEASUREMENT:
                 measurement_data = touch;
                 break;

            default:
                 ; // this is an error condition,
                  // might be good idea to attempt recovery

     }

}






/***********************************************************************/
/*    X_SENSOR MEMBER FUNCTIONS                                        */
/***********************************************************************/

x_sensor::x_sensor()
{
     type = CONFIGURED_FOR_X_MEASUREMENT;
}

unsigned int x_sensor::get_x_position(void)
{
     measurement();
     return measurement_data;
}




/***********************************************************************/
/*    Y_SENSOR MEMBER FUNCTIONS                                        */
/***********************************************************************/

y_sensor::y_sensor()
{
     type = CONFIGURED_FOR_Y_MEASUREMENT;
}

unsigned int y_sensor::get_y_position(void)
{
     measurement();
     return measurement_data;
}



/***********************************************************************/
/*    PRESSURE SENSOR MEMBER FUNCTIONS                                 */
/***********************************************************************/

pressure_sensor::pressure_sensor()
{
     type = CONFIGURED_FOR_PRESSURE_MEASUREMENT;
}



// read the pressure level and set it to one of three levels
PRESSURE_LEVEL pressure_sensor::get_pressure_level(void)
{

     PRESSURE_LEVEL  pressure = ZERO;
     measurement();

     if(measurement_data >= vlight_pressure_threshold)
     {
         if(measurement_data < light_pressure_threshold)
         {
            pressure = VLIGHT;
         }

         else if(measurement_data < firm_pressure_threshold)
         {
            pressure = LIGHT;
         }

         else
         {
            pressure = FIRM;
         }
         return VLIGHT;  // simply for test.
                         // when complete will return touch_pressure

     }

     else
     {
         return ZERO;
     }

}




/***********************************************************************/
/*    RESISTANCE MEMBER FUNCTIONS                                      */
/***********************************************************************/

resistance_sensor::resistance_sensor()
{
     type = CONFIGURED_FOR_RESISTANCE_MEASUREMENT;
}


unsigned int resistance_sensor::get_resistance(void)
{
     measurement();
     return measurement_data;
}


