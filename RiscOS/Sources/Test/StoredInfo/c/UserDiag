/* >c.UserDiag

ACORN TEST SOFTWARE (c) Acorn Computers Ltd. 1997

************************* CHANGE LIST *************************************
                                                                        
Vers    Date            Name    Comment                                 
------  ---------       ---     -------------------------------------------
1.00    18 Apr 97       BAR     Initial writing
1.01    28 Apr 97       BAR     Added code to show the Licence information.

Will perform the user diagnostic testing !!!
*/

#include <stdio.h>
#include "kernel.h"
#include "swis.h"

#include "UserDiag.h"
#include "display.h"
#include "support.h"
#include "ROMCheck.h"
#include "DRAMTest.h"
#include "NVRAMTest.h"
#include "FaultCodes.h"
#include "system.h"
#include "Modem.h"
#include "InputTest.h"
#include "Sound.h"
#include "SCardTest.h"
#include "msgs.h"


void user_diag_test(int test_mode)
/* Do the user diagnostic test !! */
/* test_mode tells us we are either USER ot LIFE */
{
        int cycle_count=0;
        int cycle_limit=0;
        int failed_count=0;
        int red_led_state;
        int green_led_state;
        int overall_status=FAILED;
        int i;

        clear_whole_screen();

        /* note the led status for restoring to at the end */
        red_led_state=get_led_state(LED_RED);
        green_led_state=get_led_state(LED_GREEN);
        display_status_led(test_mode,RUNNING);

        /* Display licence information */
        for (i=0; i<=MAX_LICENCE_MSG; i++){
                printf("%s\n",licence_info_msg[i]);
        }
        printf("\n\n");
        printf("%s",general_msg[0]);
        WaitForSpaceBar();
        clear_whole_screen();

        display_mode(test_mode);
        clear_res_store(0);
        if (test_mode==MODE_USER){
                /* user mode set cycle_limit */
                cycle_limit=1;
        }

        do{
                cycle_count++;
                if  (test_mode==MODE_LIFE){
                        /* Life mode - show counter */
                        display_cycle_count(cycle_count,failed_count);
                        clear_output();
                }
                ROM_Checksum();
#if 0
                dram_test(test_mode);
#endif
                nv_ram_checksum();
                FaultCodes();
                system_test();
                Modem_Test(test_mode);
                Input_Test(test_mode);
                sound_test(test_mode);
                smartcard_test();

                failed_count=check_logged_status(failed_count,cycle_count);
                clear_res_store(cycle_count);

        }while (cycle_count!=cycle_limit);

        /* We'll only ever get here if in user mode ! */
        if (failed_count==0){
                overall_status=PASSED;
        }
        /* Set the LED's to reflect the status */
        display_status_led(test_mode,overall_status);

        /* wait for the user to respond */
        wait_for_cont();

        /* restore the led status */
        set_led_state(LED_RED,red_led_state);
        set_led_state(LED_GREEN,green_led_state);

        /* time to exit */
        exit_routines();
}

void exit_routines()
/* Necessary routines needed to exit nicely */
{
        _kernel_swi_regs reg;

        reg.r[0] = -1;
        reg.r[1] = 0;
        reg.r[2] = 0;
        reg.r[3] = 1200;
        reg.r[4] = 1600;
        _kernel_swi(Wimp_ForceRedraw, &reg, &reg);
}
