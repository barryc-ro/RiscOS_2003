#include <stdio.h>
#include <string.h>

#include "kernel.h"
#include "swis.h"


#include "ncma_ncma.h"
#define PROTOTYPES_INTERNAL
#include "ncma_url.h"
#include "ncma_scard.h"


#include "DBUG.h"


int ncma_url_init(void)
{
   if(write_os_var(NCMA_URL_ENV_NAME, NCMA_URL_ENV_VAL, strlen(NCMA_URL_ENV_VAL))<0) return(-1);
   if(write_os_var(NCMA_PATH_ENV_NAME, NCMA_PATH_ENV_VAL, strlen(NCMA_PATH_ENV_VAL))<0) return(-1);
   return(0);
}

int ncma_url_open(char *url)
{
    _kernel_swi_regs r;
    int n;

    n = strlen(url);

    n = n>236?236:n;

    memset(msg_block, 0, 256);

//    *(int *)msg_block = n + 20;
    *(int *)msg_block = 256;
    *(int *)(msg_block + 16) = 0x4af80; /* Message_URL */
    strncpy(msg_block + 20, url, n);

    r.r[0] = 0;
    r.r[1] = (int)msg_block;
    r.r[2] = 0;
    r.r[3] = 0;
    r.r[4] = 0;
    r.r[5] = 0;

    if(_kernel_swi(TaskModule_SendMessage, &r, &r) != NULL) return(-1);
    return(0);
}

char *get_form_field(char *s, char *field)
{
    char *p, *q;

    //if((q = strchr(s, '?'))==NULL) return(NULL);
    if((q = strstr(q, field))==NULL) return(NULL);

    for(;;q++) {
        switch(*q) {
            case '=':
            	 for(p=q; ((*p != '+') && (*p != 0)); p++);
            	 *p = 0;
                 return(++q);
                 break;

            case '+':
            case 0:
            	 return(NULL);
            	 break;

        }
    }
    return(NULL);
}

int reload_browser_files(void)
{
    _kernel_swi_regs r;

    memset(msg_block, 0, 256);

//    *(int *)msg_block = n + 20;
    *(int *)msg_block = 256;
    *(int *)(msg_block + 16) = 0x4af84; /* Message_NCFresco */
    *(int *)(msg_block + 20) = 0;
    *(int *)(msg_block + 24) = 0;

    r.r[0] = 0;
    r.r[1] = (int)msg_block;
    r.r[2] = 0;
    r.r[3] = 0;
    r.r[4] = 0;
    r.r[5] = 0;

    if(_kernel_swi(TaskModule_SendMessage, &r, &r) != NULL) return(-1);
    return(0);
}


int prod_browser_after_standby(void)
{
    write_os_var(CURRENT_USER_ENV_NAME, CURRENT_USER_ENV_VAL, strlen(CURRENT_USER_ENV_VAL));
    reload_browser_files();
    ncma_url_open("file:/ncma:toplevel.html");
    return(0);
}

int ncma_url_scard(void) /* open the URL_INIT on the smartcard */
{
    char buff[128];
    memset(buff, 0, 128);

    if(cache_enquiry("URL_INIT", buff, 128)<0) {
        DBUG_PRINTF(DBUG_LVL_ERROR, "ncma_url_scard: cache enquiry failed for ISP_DOMAIN\n");
        return(-1);
    }

    DBUG_PRINTF(DBUG_LVL_DIAG, "ncma_url_scard: fetching URL \"%s\"\n", buff);

    ncma_url_open(buff);
    return(0);
}

int ncma_url_user(void) /* "start 'Surfing'" URL, as NCI put it */
{
    ncma_url_scard();
    return(0);
}
