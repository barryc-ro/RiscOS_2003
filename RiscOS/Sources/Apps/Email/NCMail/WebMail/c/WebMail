/************************************************************************/
/* File:    WebMail.c                                                   */
/* Purpose:                                                             */
/*                                                                      */
/* Author:  Neil Bingham <mailto:nbingham@acorn.com>                    */
/* History: 0.01  Wed 16th September 1998                               */
/*                Created.                                              */
/************************************************************************/


/* -------------------------------------- LIBRARY IMPORTS --------------------------------------- */
#include "WebMail.h"
#include "States.h"
#include "Inbox.h"
#include "URLOpen.h"
#include "BrowserIF.h"
#include "WimpReg.h"

/* ---------------------------------- PRE-PROCESSOR DIRECTIVES ---------------------------------- */


/* -------------------------------------- GLOBAL VARIABLES -------------------------------------- */

MessagesFD	message_block;

UIStatus	status;

/* ----------------------------------------- FUNCTIONS ------------------------------------------ */

/************************************************************************/
/* ncmui_initialise                                                     */
/*                                                                      */
/* Function performs initialisation of the WebMail UI library.  This    */
/* involves setting up the Messages file descriptor so that WebMail can */
/* use it, and registering wimp messages.                               */
/*                                                                      */
/* Parameters: msg_id - MessageTrans file descriptor.                   */
/*                                                                      */
/* Returns:    TRUE or FALSE.                                           */
/*                                                                      */
/************************************************************************/
uint32 ncmui_initialise(MessagesFD msgs_id, bool line_state)
{
  dprintf(("UI", "WebMail initialised\n"));

  hack_round_linker();

  status.state = State_Inactive;
  status.exit_url = NULL;
  status.netlink = -1;

  /* Store Messages File Descriptor */
  message_block = msgs_id;

  /* Register callback to engine for sending inbox update requests */
  eng_register_prompt(NULL, ncmui_inbox_render_cbf);

  /* Setup line state */
  ncmui_line_state(line_state);

  event_register_message_handler(wimp_MOPENURL, browserif_openurl_msg_handler, 0);

  return(TRUE);
}


/************************************************************************/
/* ncmui_line_state                                                     */
/*                                                                      */
/* Function is called by the engine when the line state changes.        */
/*                                                                      */
/* Parameters: state (1 - Online, 0 - Offline).                         */
/*                                                                      */
/* Returns:    int (FALSE if error ).                                   */
/*                                                                      */
/************************************************************************/
uint32 ncmui_line_state(uint32 state)
{
  if (state <= NetLink_Online)
  {
    dprintf(("UI", "Netlink is: %d (0 is offline)\n", state));
    status.netlink = state;

    /* Now check to see if we are in an Inbox state, and if so update */
    switch(status.state)
    {
      case(State_Inbox):
      case(State_Inbox_Unprocessed):
      {
        inbox_build_screen();
        break;
      }
    }
    return(TRUE);
  }
  return(FALSE);
}


/************************************************************************/
/* ncmui_tidy_output_dir                                                */
/*                                                                      */
/* Function is called by any of the page generation routines to delete  */
/* old template files.                                                  */
/*                                                                      */
/* Parameters: void.                                                    */
/*                                                                      */
/* Returns:    void.                                                    */
/*                                                                      */
/************************************************************************/
void ncmui_tidy_output_dir(void)
{
  dprintf(("UI", "TIDYING OUTPUT DIR\n"));

  /* Delete any Inbox files present */
  if (nb_file_exists(1, Generated_Inbox_Parent, NULL, NULL) == NULL)
  {
    dprintf(("UI", "'Inbox' existed - deleting\n"));
    nb_file_delete(1, Generated_Inbox_Parent, NULL);
  }
  if (nb_file_exists(1, Generated_Inbox_Header, NULL, NULL) == NULL)
  {
    dprintf(("UI", "'Inbox_H' existed - deleting\n"));
    nb_file_delete(1, Generated_Inbox_Header, NULL);
  }
  if (nb_file_exists(1, Generated_Inbox_Listing, NULL, NULL) == NULL)
  {
    dprintf(("UI", "'Inbox_L' existed - deleting\n"));
    nb_file_delete(1, Generated_Inbox_Listing, NULL);
  }

  /* Delete any ReadMsg files present */
  if (nb_file_exists(1, Generated_ReadMsg_Parent, NULL, NULL) == NULL)
  {
    dprintf(("UI", "'Read' existed - deleting\n"));
    nb_file_delete(1, Generated_ReadMsg_Parent, NULL);
  }
  if (nb_file_exists(1, Generated_ReadMsg_Header, NULL, NULL) == NULL)
  {
    dprintf(("UI", "'Read_H' existed - deleting\n"));
    nb_file_delete(1, Generated_ReadMsg_Header, NULL);
  }
  if (nb_file_exists(1, Generated_ReadMsg_Body, NULL, NULL) == NULL)
  {
    dprintf(("UI", "'Read_Body' existed - deleting\n"));
    nb_file_delete(1, Generated_ReadMsg_Body, NULL);
  }

}

/* ============================================================================================== */
/* ===================================== Debugging Functions ==================================== */
/* ============================================================================================== */

/************************************************************************/
/* debug_message_received                                               */
/*                                                                      */
/* Function is called when a Debug link is clicked on.  The current     */
/* status will then be displayed in the default debug stream.           */
/*                                                                      */
/* Parameters: browserif params.                                        */
/*                                                                      */
/* Returns:    true.                                                    */
/*                                                                      */
/************************************************************************/
bool debug_message_received(int num_args, url_param *  arg)
{
  NB_UNUSED(num_args);
  NB_UNUSED(arg);

  ncmui_debug_show_status();
  return(true);
}


/************************************************************************/
/* ncmui_debug_show_status                                              */
/*                                                                      */
/* Function outputs the contents of the status structure to the debug   */
/* library.                                                             */
/*                                                                      */
/* Parameters: void.                                                    */
/*                                                                      */
/* Returns:    void.                                                    */
/*                                                                      */
/************************************************************************/
void ncmui_debug_show_status(void)
{
  dprintf(("UI", "***************************************************\n"));
  dprintf(("UI", "* Current State:       %10d *\n", status.state));
  dprintf(("UI", "* Netlink (0=Offline): %10d *\n", status.netlink));
  dprintf(("UI", "* Exit URL:            %10s *\n", status.exit_url));
  dprintf(("UI", "***************************************************\n"));
}
