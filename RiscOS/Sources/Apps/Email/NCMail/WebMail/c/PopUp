/************************************************************************/
/* File:    PopUp.c                                                     */
/* Purpose: Code relating to popup dialogue boxes.                      */
/*                                                                      */
/* Author:  Neil Bingham <mailto:nbingham@acorn.com>                    */
/* History: 0.01  Mon 05th October 1998                                 */
/*                Created.                                              */
/************************************************************************/


/* -------------------------------------- LIBRARY IMPORTS --------------------------------------- */
#include "PopUp.h"


/* ---------------------------------- PRE-PROCESSOR DIRECTIVES ---------------------------------- */


/* -------------------------------------- GLOBAL VARIABLES -------------------------------------- */


ncmui_cbf_popup	 cbf_ptr;
void		*cbf_hdl;

/* ----------------------------------------- FUNCTIONS ------------------------------------------ */

/************************************************************************/
/* popup_message_received                                               */
/*                                                                      */
/* Function is called when the library receives an ncmail: message from */
/* a PopUp box.                                                         */
/*                                                                      */
/* Parameters: num_args - number of arguments passed in arg.            */
/*             arg      - list of the name= & value= bits from the HTML */
/*                                                                      */
/* Returns:    TRUE.                                                    */
/*                                                                      */
/************************************************************************/
bool popup_message_received(int num_args, url_param *  arg)
{
  uint32	 counter;

  dprintf(("UI", "WE RECEIVED A POPUP URL MESSAGE!!!!\n"));

  for (counter = 0; counter < num_args; counter++)
  {
    dprintf(("UI", "%d: name '%s', value '%s'\n", counter, arg[counter].name, arg[counter].value));
    if (nb_case_insensitive_strcmp(arg[counter].value, PopUp_OK) == 0)
    {
      dprintf(("UI", "User clicked on OK\n"));
      popup_ok_message_received(num_args, arg);
    }
    else if (nb_case_insensitive_strcmp(arg[counter].value, PopUp_Cancel) == 0)
    {
      dprintf(("UI", "User clicked on Cancel\n"));
      popup_cancel_message_received(num_args, arg);
    }
  }
  return(true);
}


/************************************************************************/
/* popup_cancel_message_received                                        */
/*                                                                      */
/* Function is called when someone calls clicks on the Cancel button in */
/* a two-button popup dialogue.  A one-button dialogue, even if the text*/
/* says Cancel will return to the OK function.                          */
/*                                                                      */
/* Parameters:                                                          */
/*                                                                      */
/* Returns:                                                             */
/*                                                                      */
/************************************************************************/
void popup_cancel_message_received(int num_args, url_param *arg)
{

}


/************************************************************************/
/* popup_cancel_message_received                                        */
/*                                                                      */
/* Function is called when someone calls clicks on the OK button in a   */
/* popup dialogue with at least one button.  This function is called for*/
/* button clicks on single button windows even if the text of the button*/
/* is Cancel.                                                           */
/*                                                                      */
/* Parameters:                                                          */
/*                                                                      */
/* Returns:                                                             */
/*                                                                      */
/************************************************************************/
void popup_ok_message_received(int num_args, url_param *arg)
{
  status.ui_locked = true;

  dprintf(("UI", "popup_ok_message_received entered with state: %d\n", status.state));

  switch(status.state)
  {
    case(State_Compose_Failed):
    {
      inbox_build_screen();
      break;
    }
  }

  /* Execute the callback */
  if (cbf_ptr)
  {
    dprintf(("UI", "Executing callback\n"));
    cbf_ptr(true, cbf_hdl);
  }
  cbf_ptr = NULL;
  cbf_hdl = NULL;
}


/* ============================================================================================== */
/* ==================================== POPUP NO BUTTON CODE ==================================== */
/* ============================================================================================== */

/************************************************************************/
/* popup_open_dialogue                                                  */
/*                                                                      */
/* Function is called to open a Popup dialogue with no buttons.         */
/*                                                                      */
/* Parameters:                                                          */
/*                                                                      */
/* Returns:                                                             */
/*                                                                      */
/************************************************************************/
bool popup_open_dialogue(char *text)
{
  dprintf(("UI", "===========================================================================\n"));
  dprintf(("UI", "Popup dialogue opened with:\n"));
  dprintf(("UI", "%s\n", text));
  dprintf(("UI", "===========================================================================\n"));
//  bool		 rc = false;
//
//  rc = parser_parse_file(PageType_PopUp, Template_PopUp, Generated_PopUp, text);
//
//  if (rc == true)
//  {
//    if (browserif_sendurl(Open_PopUp, true) == false)
//    {
//      ncmui_error_display(25);
//      /* We are screwed.  */
//      error_parser_failed();
//    }
//    return(true);
//  }
//  else
//  {
//    ncmui_error_display(24);
//    dprintf(("", "State: %d\n", status.state));
//    error_parser_failed();
//    return(false);
//  }
  return(true);
}


/************************************************************************/
/* popup_close_dialogue                                                 */
/*                                                                      */
/* Function is called to close a 0-button Popup dialogue box.           */
/*                                                                      */
/* Parameters: void.                                                    */
/*                                                                      */
/* Returns:    void.                                                    */
/*                                                                      */
/************************************************************************/
void popup_close_dialogue(void)
{
  dprintf(("UI", "===========================================================================\n"));
  dprintf(("UI", "Popup close dialogue called:\n"));
  dprintf(("UI", "===========================================================================\n"));

}


/* ============================================================================================== */
/* =================================== POPUP ONE BUTTON CODE ==================================== */
/* ============================================================================================== */

/************************************************************************/
/* popup_1_open_dialogue                                                */
/*                                                                      */
/* Function is called to open a Popup dialogue with one button.         */
/*                                                                      */
/* Parameters: text        - message for the user.                      */
/*             button      - text to place on the button.               */
/*             func        - callback to call when button pressed.      */
/*             handle      - void * data to pass through.               */
/*                                                                      */
/* Returns:    true or false.                                           */
/*                                                                      */
/************************************************************************/
bool popup_1_open_dialogue(char *text, char *button, ncmui_cbf_popup func, void *handle)
{
//  PopUpACs	*acs = NULL;
  bool		 rc = false;

  dprintf(("UI", "===========================================================================\n"));
  dprintf(("UI", "Popup 1 dialogue opened with button text '%s' and message::\n", button));
  dprintf(("UI", "'%s'\n", text));
  dprintf(("UI", "void * data is: %s\n", (char *) handle));
  dprintf(("UI", "===========================================================================\n"));

  if ( (cbf_ptr != NULL) || (func == NULL) )
  {
    cbf_ptr = NULL;
    cbf_hdl = NULL;
    return(false);
  }
  else
  {
    /* Assign callback to global pointer */
    cbf_ptr = func;
    cbf_hdl = handle;

    dprintf(("UI", "after storing in global ptr, value is: %s\n", (char *) cbf_hdl));

    /* Setup Active Comment data for passing through parser */
//    acs->text = text;
//    acs->cancel = NULL;
//    acs->ok = button;

    /* Attempt to parse the file */
    rc = parser_parse_file(PageType_PopUp_1, Template_PopUp_1, Generated_PopUp_1, NULL);

    if (rc == true)
    {
      if (browserif_sendurl(Open_PopUp_1, true) == false)
      {
        ncmui_error_display(25);
        /* We are screwed.  */
        error_parser_failed();
      }
      return(true);
    }
    else
    {
      ncmui_error_display(24);
      dprintf(("", "State: %d\n", status.state));
      error_parser_failed();
      return(false);
    }
    return(true);
  }
}

/* ============================================================================================== */
/* ===================================== PAGE BUILDING CODE ===================================== */
/* ============================================================================================== */

/************************************************************************/
/* popup_active_comment_found                                           */
/*                                                                      */
/* Function is called when the UI page type is PopUp & an active comment*/
/* is found in the web page being parsed.                               */
/*                                                                      */
/* Parameters:                                                          */
/*                                                                      */
/* Returns:                                                             */
/*                                                                      */
/************************************************************************/
void popup_active_comment_found(char *comment, FILE *out, void *handle)
{
  dprintf(("UI", "popup_active_comment_found() with:\n"));
//  dprintf(("UI", "  text:   %s\n", acs->text));
//  dprintf(("UI", "  cancel: %s\n", acs->cancel));
//  dprintf(("UI", "  ok:     %s\n", acs->ok));
//  /* Body Text */
//  if (nb_case_insensitive_strcmp(comment, PopUp_AC_Body) == 0)
//  {
//    fprintf(out, "%s\n", acs->text);
//  }
//  /* Cancel Button */
//  else if (nb_case_insensitive_strcmp(comment, PopUp_AC_Cancel) == 0)
//  {
//    fprintf(out, "%s\n", acs->cancel);
//  }
//  /* OK Button */
//  else if (nb_case_insensitive_strcmp(comment, PopUp_AC_OK) == 0)
//  {
//    fprintf(out, "%s\n", acs->ok);
//  }
  /* Not a known tag */
//  else
//  {
//    ncmui_error_display(23);
//#ifdef DEBUGLIB
//    fprintf(out, "<H1>Unknown tag '%s' received</H1><BR>\n", comment);
//#endif
//  }
}
