/*
** Email Engine
** User details
*/

#include "kernel.h"
#include "swis.h"
#include "string.h"

#include "Email/Mailbox/Account.h"
#include "Email/Mailbox/POP3/POP3Account.h"
#include "Email/Mailbox/SendQ/SendQAccount.h"

#include "DebugLib/DebugLib.h"
#ifdef MemCheck_MEMCHECK
  #include "MemCheck:MemCheck.h"
#endif

#include "Email/Common/types.h"
#include "Email/Common/bool.h"

#include "NBLib/NBDefs.h"
/* #include "NBLib/NBLib.h" */

#include "engstr.h"
#include "engfile.h"
#include "engmanager.h"
#include "enginit.h"
#include "engprocess.h"
#include "engcbf.h"
#include "engconnect.h"

char *realname = 0, *emailaddr = 0, *popuser = 0;
char *poppassword = 0, *pophostname = 0, *smtphostname = 0;
bool changepending;

bool SetupStore(void)
{
  
  static char storepath[] = "NCMailStore$Path";
  static char wildcard[] = "NCMailStore:*";
  char *ptr = malloc(strlen(popuser) + 24);
  if (!ptr)
  {
    /* malloc failure - do something */
    dprintf(("Eng", "*** ERROR *** malloc failure in SetupStore\n"));
    return false;
  }

  /* create directory to store user's mail */

  dprintf(("Eng", "About to create directories\n"));
  strcpy(ptr, "<NCMailStore$Dir>.");
  strcat(ptr, popuser);
  CreateDirectory(ptr);
  strcat(ptr, ".");
  regs.r[0] = (int) storepath;
  regs.r[1] = (int) ptr;
  regs.r[2] = strlen(ptr) + 1;
  regs.r[3] = 0;
  regs.r[4] = 0;
  _kernel_swi(OS_SetVarVal,&regs,&regs);
  free(ptr);

  /* unlock and clear out any files from directory if they exist */

  dprintf(("Eng", "Clearing out old files\n"));
  UnlockFile(wildcard);
  regs.r[0] = 27;
  regs.r[1] = (int) wildcard;
  regs.r[3] = 0;
  _kernel_swi(OS_FSControl,&regs,&regs);
  dprintf(("Eng", "Files wiped\n"));

  return true;
}


/*
** CreatePOPAccount() sets up a new POP3 account.
** This is called when NCMail is first entered and the account
** stays valid until the user logs off or goes into standby mode.
*/

bool CreatePOPAccount(void)
{

  ELib_rcode rc;

  if (!SetupStore())
    return false;

  /* create new POP3 account */
  POPaccount = new POP3Account(popuser, poppassword, pophostname, rc);
  if (rc >= 0)
  {
    /* POP3 account created OK */
    popstatus = acctcreated;
    POPaccount->SetConnectionState(online);
  }

  return true;

}


void CreateSMTPAccount(void)
{

  ELib_rcode rc;

  SMTPaccount = new SendQAccount(smtphostname, rc);
  if (rc >= 0)
  {
    /* SMTP account created OK */
    smtpstatus = acctcreated;
    SMTPaccount->SetConnectionState(online);
  }

}


void ReadUserDetails(void)
{

  realname = GetSysVar("Inet$EmailRealName", true);
  emailaddr = GetSysVar("Inet$EmailAddress", true);
  dprintf(("Eng", "Real name = %s, address = %s\n",realname,emailaddr));

  popuser = GetSysVar("Inet$EmailPOP3User", true);
  poppassword = GetSysVar("Inet$EmailPOP3Password", true);
  pophostname = GetSysVar("Inet$EmailPOP3Hostname", true);
  dprintf(("Eng", "POP3 user = %s, password = %s, hostname = %s \n",popuser,poppassword,pophostname));

  smtphostname = GetSysVar("Inet$EmailSMTPHostname", true);
  dprintf(("Eng", "SMTP hostname = %s\n",smtphostname));

}


void NewUser(void)
{

  changepending = false;
  if (popuser)
  {
    /* clear out old user's file store and descriptors */
    dprintf(("Eng", "Clearing out files for user %s\n",popuser));
    if (!SetupStore())
    {
      statusret.code = ENG_NOMEMORY;
      (*callbacklist.statusfunc)(&statusret, callbacklist.statushandle, 0);
      return;
    }

   while (ourmboxin->list)
      DestroyDescriptor(ourmboxin->list, ourmboxin);
    ourmboxin->read = 0;
    ourmboxin->answered = 0;
    ourmboxin->flags = DOWNLOADINCOMPLETE;

    while (ourmboxout->list)
      DestroyDescriptor(ourmboxout->list, ourmboxout);
  }

  if (POPaccount)
  {
    delete POPaccount;
    POPaccount = 0;
  }
  popstatus = acctnonexistent;
  if (SMTPaccount)
  {
    delete SMTPaccount;
    SMTPaccount = 0;
  }
  smtpstatus = acctnonexistent;
  ReadUserDetails();
  if (popuser)
  {
    if (!CreatePOPAccount())
    {
      statusret.code = ENG_NOMEMORY;
      (*callbacklist.statusfunc)(&statusret, callbacklist.statushandle, 0);
    }
    else
      CreateSMTPAccount();
  }
}


void ChangeUser(void)
{

  char *newpopuser, *newpophostname;

  dprintf(("Eng", "Entering ChangeUser()\n"));
  newpopuser = GetSysVar("Inet$EmailPOP3User", true);
  newpophostname = GetSysVar("Inet$EmailPOP3Hostname", true);
  if ((!strcmp(popuser, newpopuser)) && (!strcmp(pophostname, newpophostname)))
  {
    /* user details haven't changed */
    dprintf(("Eng", "User details haven't changed\n"));
  }

  else
  {
    reprocess = false;
    if (popactive)
    {
      /*
      ** Doing a download or something so must stop,
      ** disconnect from server, wash behind the ears,
      ** clean the kitchen sink... Ugh!
      */
      disconnectpending = true;
      changepending = true;
    }
    else
      NewUser();
  }

  free(newpophostname);
  free(newpopuser);

}
