/*
 *  CTS (ctstypes.h)
 *
 * Copyright (C) Element 14 Ltd. 1999
 *
 */
#ifndef ctstypes_h_included
#define ctstypes_h_included

#ifdef __cplusplus
extern "C" {
#endif

/************************************************************************
 *
 * This section of the file declares the types associated with messages
 * being communicated between the plugin and the server
 *
 *
 */

/* The cts_string type is special - it always points to allocated storage
 * which does not need to be freed dynamically.  It will always form part
 * of a larger structure.
 */
typedef char cts_string;

enum {
        /* The maximum size of a CTS message */
        limit_MAX_MESSAGE_LENGTH = 4096,
        /* The maximum number of tag/value pairs in a CTS server message */
        limit_MAX_PARAMS = 32
};

typedef enum {
        cmd__UNKNOWN,   /* An unrecognised command name */
        cmd_START,	/* Start message */
        cmd_OPEN,	/* Card Insert */
        cmd_VERIFY,	/* Password check request */
        cmd_CHANGE,	/* Password change */
        cmd_APDU,	/* ADPU Command/Rrsponse */
        cmd_TEXT,	/* Screen Data */
        cmd_ADPUT,	/* Command + Screen Data */
        cmd_CLOSE,	/* Card Eject Instruction */
        cmd_ERR,	/* error */
        cmd_BASIC,	/* authentication */

        cmd__MAX        /* Used for the array bound definition */
} cts_commands;


typedef enum cts_tags {
        tag__ZERO,

        tag_SERVICE,
        tag_SEQ,
        tag_CMD,
        tag_URL,
        tag_STS,
        tag_PORT,
        tag_APDU,
        tag_MSG,
        tag_KEYID,
        tag_PASSMIN,
        tag_PASSMAX,
        tag_PASSKIND,
        tag_USER,
        tag_PASSWORD,
        tag_OTHER,

        tag__MAX /* Used for the array bound definition */
} cts_tags;

typedef struct {
        cts_tags	tag;
        size_t		minimum_value_length;
        size_t		maximum_value_length;
} cts_tag_characteristics ;

/* This array is indexed by a cts_tags value */
extern const cts_tag_characteristics tag_characteristics[tag__MAX];


typedef struct cts_command_parameter {
        const cts_tag_characteristics	*tag;
        cts_string			*name;
        cts_string			*value;
} cts_command_parameter;

typedef struct {
        cts_commands			command;
        size_t				param_count;
        cts_command_parameter		params[limit_MAX_PARAMS];
        char				message[limit_MAX_MESSAGE_LENGTH+1];
} cts_server_message;


/* Initialise a message structure */
extern cts_server_message *cts_server_message_initialise(void);
extern void cts_server_message_destroy(cts_server_message *);

/************************************************************************
 *
 * This section of the file declares the types associated with messages
 * being communicated between the browser and the plugin.
 *
 *
 */


typedef struct cts_browser_parameter cts_browser_parameter;

struct cts_browser_parameter {
        cts_browser_parameter		*next;
        cts_string			*name;
        cts_string			*value;
        /* the data for name and value follows immediately here */
};

typedef struct {
        size_t				param_count;
        cts_browser_parameter		*param_list;
        cts_string			*command;
        /* the data for the command name follows immediately here */
} cts_browser_message;


/* Initialise a message structure */
extern cts_browser_message *cts_browser_message_initialise(size_t);
/* Finalise a message structure */
extern void cts_browser_message_destroy(cts_browser_message *);

/* Initialise a browser parameter */
extern cts_browser_parameter *cts_browser_parameter_initialise(
	const char *name, size_t name_len,
	const char *value, size_t value_len);
/* Finalise a message parameter */
extern cts_browser_parameter *cts_browser_parameter_destroy(cts_browser_parameter *);

#ifdef __cplusplus
}
#endif

#endif
