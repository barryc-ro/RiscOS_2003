/*
 *  CTS (smartcard.c)
 *
 * Copyright (C) Element 14 Ltd. 1999
 *
 */

#include <stdio.h>
#include "kernel.h"
#include "swis.h"
#include "ctstypes.h"
#include "ctsbrowser.h"
#include "ctsintern.h"
#include "smartcard.h"

#include "SCTransport.h"

#include "DebugLib/DebugLib.h"

/* NOTE: The SWI interface specification for SCTrans was designed by Rich Buckley.
 * Because of this, we have no idea whether errors will be returned in the standard
 * way (V flag set) or not, or whether there is a mixture.  This source files guards
 * against all possibilities.
 */

static int card_handle;
static cts_sc_slot_id slot_id;
static int card_handle_valid = 0;

_kernel_oserror *cts_sc_open(cts_sc_slot_id card_number)
{
        _kernel_oserror *e, *buckleyism;

        e = _swix(SCTransport_Open, _INR(0,1)|_OUT(0), 0, &card_handle, &buckleyism);
        if (buckleyism != 0) e = buckleyism;

	if (e != 0) {
	        slot_id = card_number;
	        card_handle_valid = 1;
	}

        return e;
}

_kernel_oserror *cts_sc_close(void)
{
        _kernel_oserror *e, *buckleyism;

	card_handle_valid = 0;

        e = _swix(SCTransport_Close, _IN(0)|_OUT(0), card_handle, &buckleyism);
        if (buckleyism != 0) e = buckleyism;

        return e;
}

void cts_sc_atexit(void)
{
        if (card_handle_valid) {
	        (void) cts_sc_close();
        }
}
