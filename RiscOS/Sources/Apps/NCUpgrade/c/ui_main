/* ui_main.c */


/* --------------------------- LIBRARY IMPORTS ---------------------------------------- */
#include <time.h>


#include "ui_include.h"
#include "dial.h"
#include "ui_tbox.h"
#include "ui_menu.h"
#include "ui_misc.h"
#include "ui_main.h"
#include "strings.h"
#include "ui_globals.h"

#include "VersionNum"  /* SrcCommit version number file */

/* ---------------------------- GLOBAL VARIABLES -------------------------------------- */

/* Declaration of window & menu handles
 */
ObjectId ui_ISP_WindowHandle, ui_Welcome_WindowHandle, ui_Finished_WindowHandle,
         ui_Error_WindowHandle, ui_ProgInfo_WindowHandle, ui_FTP_WindowHandle,
         ui_Done_WindowHandle, ui_Upgrade_WindowHandle, ui_Abort_WindowHandle,
         ui_Ibar_MenuHandle, ui_Icon_BarHandle, ui_Dialling_WindowHandle,
         ui_Validate_WindowHandle, ui_Error2_WindowHandle;

ObjectId ui_current_window;

static int ui_main_valid_country_codes[8] = {DialCode_USA,
                                             DialCode_Norway,
                                             DialCode_UK,
                                             DialCode_Germany,
                                             DialCode_Sweden,
                                             DialCode_Denmark,
                                             DialCode_Finland,
                                             -1};

MessagesFD  ui_message_block;
IdBlock     ui_event_id_block;   /* declare an event block for use with toolbox initialise */
int         ui_current_wimp;     /* the current version of the wimp we are using */
int         ui_task_id;          /* and our task handle */


/* This array tells toolbox initialise which wimp messages we want to know about */
static int ui_wimp_messages[]  = {
                                  Message_NCKeyboard_Closed,
                                  Wimp_MPreQuit,
                                  Wimp_MQuit
                                 };

/* This array tells toolbox initialise which toolbox events we are interested in.  A value
 * of 0 indicates we want all events.
 */
static int ui_toolbox_events[] = {0};

/* Other local variables */

static engine_callbacks_t engine_callbacks;
static setup_details_t setup_details;

static int ui_main_encountered_error = 0, ui_main_encountered_abort = 0,
           ui_main_encountered_validate = 0;

static int ui_main_engine_busy = 0;

static int new_setup_details = 0;

static char ui_corruption_forced_upgrade = 0;

static clock_t stored_time = 0;

/* --------------------------- FUNCTIONS ------------------------------------------ */


/************************************************************************/
/* ui_main_validate_dialling                                            */
/*                                                                      */
/* Inputs:   none.                                                      */
/* Outputs:  valid - Sets the variable referenced by "valid" to 1 to    */
/*           indicate dialling options are valid, 0 to indicate at      */
/*           least 1 option was invalid.                                */
/* Returns:  Pointer to an error block, or NULL if no error             */
/* Action:   Validates the options in the dialling options screen, if   */
/*           an invalid option is discovered a data validation pop-up   */
/*           is shown with a relevant message for the user.             */
/*                                                                      */
/************************************************************************/
static _kernel_oserror *ui_main_validate_dialling (int *valid)
{
  char *tag = NULL;
  char *tmp = NULL;
  int state;
  _kernel_oserror *er = NULL;

  /* Read the country code */
  er = ui_misc_get_writable_value (ui_Dialling_WindowHandle, dialling_code, &tmp);
  if (er)
  {
    if (tmp)
      free (tmp);
    return er;
  }
  /* Country code is empty */
  if (strlen (tmp) == 0)
    tag = "Validate_Dialling_Empty_Code";
  /* We've got a code, so check if it's one of the allowed values */
  else
  {
    int i = 0;
    int num = atoi (tmp);

    while ((ui_main_valid_country_codes[i] != num) && (ui_main_valid_country_codes[i] != -1))
      i++;

    /* It's not, so set a tag */
    if (ui_main_valid_country_codes[i] == -1)
      tag = "Validate_Dialling_Invalid_Code";
  }
  if (tmp)
    free (tmp);

  /* Read whether an outside line prefix is wanted */
  er = radiobutton_get_state (0, ui_Dialling_WindowHandle, dialling_line_radio_yes, &state,
                              NULL);
  if (er)
    return er;
  if (state == 1)
  {
    /* If it is, ensure they've entered one */
    er = ui_misc_get_writable_value (ui_Dialling_WindowHandle, dialling_line, &tmp);
    if (er)
    {
      if (tmp)
        free (tmp);
      return er;
    }
    /* They haven't, so set a tag */
    if (strlen (tmp) == 0)
      tag = "Validate_Dialling_Empty_Line";
    if (tmp)
    free (tmp);
  }

  /* Read whether a call waiting prefix is wanted */
  er = radiobutton_get_state (0, ui_Dialling_WindowHandle, dialling_waiting_radio_yes, &state,
                              NULL);
  if (er)
    return er;
  if (state == 1)
  {
    /* If it is, ensure they've entered one */
    er = ui_misc_get_writable_value (ui_Dialling_WindowHandle, dialling_waiting, &tmp);
    if (er)
    {
      if (tmp)
        free (tmp);
      return er;
    }
    /* They haven't, so set a tag */
    if (strlen (tmp) == 0)
      tag = "Validate_Dialling_Empty_Waiting";
    if (tmp)
      free (tmp);
  }

  /* If a validation failed ... */
  if (tag != NULL)
  {
    /* Set the validation text */
    er = button_set_value (0, ui_Validate_WindowHandle, validate_text,
                           lookup_message_token (&ui_message_block, tag));
    if (er)
      return er;

    /* And show the validation box */
    ui_main_encountered_validate = 1;
    er = toolbox_show_object (0u, ui_Validate_WindowHandle,
                              Toolbox_ShowObject_Centre, NULL, NULL, NULL);
    if (er)
      return er;

    /* Indicate there was an invalid field */
    *valid = 0;
  }
  else
  {
    /* Indicate all fields were valid */
    *valid = 1;
  }

  return er;
}


/************************************************************************/
/* ui_main_validate_isp                                                 */
/*                                                                      */
/* Inputs:   none.                                                      */
/* Outputs:  valid - Sets the variable referenced by "valid" to 1 to    */
/*           indicate isp options are valid, 0 to indicate at least 1   */
/*           option was invalid.                                        */
/* Returns:  Pointer to an error block, or NULL if no error             */
/* Action:   Validates the options in the ISP options screen, if        */
/*           an invalid option is discovered a data validation pop-up   */
/*           is shown with a relevant message for the user.             */
/*                                                                      */
/************************************************************************/
static _kernel_oserror *ui_main_validate_isp (int *valid)
{
  char *tag = NULL;
  char *tmp;
  _kernel_oserror *er = NULL;

  /* Read the ISP phone number */
  er = ui_misc_get_writable_value (ui_ISP_WindowHandle, isp_phone, &tmp);
  if (er)
  {
    if (tmp)
      free (tmp);
    return er;
  }
  /* If they've not entered one, set a tag */
  if (strlen (tmp) == 0)
    tag = "Validate_ISP_Empty_Phone";
  if (tmp)
    free (tmp);

  /* Read the ISP username */
  er = ui_misc_get_writable_value (ui_ISP_WindowHandle, isp_username, &tmp);
  if (er)
  {
    if (tmp)
      free (tmp);
    return er;
  }
  /* If they've not entered one, set a tag */
  if (strlen (tmp) == 0)
    tag = "Validate_ISP_Empty_Username";
  if (tmp)
    free (tmp);

  /* Read the DNS server field */
  er = ui_misc_get_writable_value (ui_ISP_WindowHandle, isp_dns, &tmp);
  if (er)
  {
    if (tmp)
      free (tmp);
    return er;
  }
  /* If they've not entered one, set a tag */
  if (strlen (tmp) == 0)
    tag = "Validate_ISP_Empty_DNS";
  if (tmp)
    free (tmp);

  /* Read the modem script */
  er = ui_misc_get_writable_value (ui_ISP_WindowHandle, isp_modemscript, &tmp);
  if (er)
  {
    if (tmp)
      free (tmp);
  }
  /* If they've not entered one, set a tag */
  if (strlen (tmp) == 0)
    tag = "Validate_ISP_Empty_ModemScript";
  if (tmp)
    free (tmp);

  /* If a validation failed ... */
  if (tag != NULL)
  {
    /* Set the validation text */
    er = button_set_value (0, ui_Validate_WindowHandle, validate_text,
                           lookup_message_token (&ui_message_block, tag));
    if (er)
      return er;

    /* And show the validation box */
    ui_main_encountered_validate = 1;
    er  = toolbox_show_object (0u, ui_Validate_WindowHandle,
                               Toolbox_ShowObject_Centre, NULL, NULL, NULL);
    if (er)
      return er;

    /* Indicate there was an invalid field */
    *valid = 0;
  }
  else
  {
    /* Indicate all fields were valid */
    *valid = 1;
  }

  return er;
}


/************************************************************************/
/* ui_main_validate_ftp                                                 */
/*                                                                      */
/* Inputs:   none.                                                      */
/* Outputs:  valid - Sets the variable referenced by "valid" to 1 to    */
/*           indicate ftp options are valid, 0 to indicate at least 1   */
/*           option was invalid.                                        */
/* Returns:  Pointer to an error block, or NULL if no error             */
/* Action:   Validates the options in the FTP options screen, if        */
/*           an invalid option is discovered a data validation pop-up   */
/*           is shown with a relevant message for the user.             */
/*                                                                      */
/************************************************************************/
static _kernel_oserror *ui_main_validate_ftp (int *valid)
{
  char *tag = NULL;
  char *tmp;
  _kernel_oserror *er = NULL;

  /* Read the FTP URL */
  er = ui_misc_get_writable_value (ui_FTP_WindowHandle, ftp_url, &tmp);
  if (er)
  {
    if (tmp)
      free (tmp);
    return er;
  }
  /* If they've not entered one, set a tag */
  if (strlen (tmp) == 0)
    tag = "Validate_FTP_Empty_URL";
  else
  {
    /* If it doesn't start "ftp://" set a tag */
    if (strncmp (tmp, "ftp://", strlen ("ftp://")) != 0)
      tag = "Validate_FTP_Invalid_URL";
  }
  if (tmp)
    free (tmp);

  /* Read the FTP username */
  er = ui_misc_get_writable_value (ui_FTP_WindowHandle, ftp_username, &tmp);
  if (er)
  {
    if (tmp)
      free (tmp);
    return er;
  }
  /* If they've not entered one, set a tag */
  if (strlen (tmp) == 0)
    tag = "Validate_FTP_Empty_Username";
  if (tmp)
    free (tmp);

  /* Read the FTP password */
  er = ui_misc_get_writable_value (ui_FTP_WindowHandle, ftp_password, &tmp);
  if (er)
  {
    if (tmp)
      free (tmp);
    return er;
  }
  /* If they've not entered one, set a tag */
  if (strlen (tmp) == 0)
    tag = "Validate_FTP_Empty_Password";
  if (tmp)
    free (tmp);

  /* If a validation failed ... */
  if (tag != NULL)
  {
    /* Set the validation text */
    er = button_set_value (0, ui_Validate_WindowHandle, validate_text,
                           lookup_message_token (&ui_message_block, tag));
    if (er)
      return er;

    /* And show the validation box */
    ui_main_encountered_validate = 1;
    er = toolbox_show_object (0u, ui_Validate_WindowHandle,
                              Toolbox_ShowObject_Centre, NULL, NULL, NULL);
    if (er)
      return er;

    /* Indicate there was an invalid field */
    *valid = 0;
  }
  else
  {
    /* Indicate all fields were valid */
    *valid = 1;
  }

  return er;
}


/************************************************************************/
/* ui_main_show_welcome                                                 */
/*                                                                      */
/* Inputs:   none.                                                      */
/* Outputs:  none.                                                      */
/* Returns:  Pointer to an error block, or NULL if no error             */
/* Action:   Brings up the appropriate welcome screen, according to the */
/*           ui_corruption_forced_upgrade flag.                         */
/*                                                                      */
/************************************************************************/
static _kernel_oserror *ui_main_show_welcome (void)
{
  char *tag;
  _kernel_oserror *er = NULL;

  if (ui_corruption_forced_upgrade)
    tag = "Welcome_Corrupt";
  else
    tag = "Welcome_User";

  er = button_set_value (0, ui_Welcome_WindowHandle, welcome_text,
                         lookup_message_token (&ui_message_block, tag));
  if (er)
    return er;

  ui_current_window = ui_Welcome_WindowHandle;
  er = toolbox_show_object (0u, ui_Welcome_WindowHandle,
                            Toolbox_ShowObject_Centre, NULL, NULL, NULL);

  return er;
}


/************************************************************************/
/* ui_main_send_engine_setup                                            */
/*                                                                      */
/* Inputs:   none.                                                      */
/* Outputs:  none.                                                      */
/* Returns:  Pointer to an error block, or NULL if no error             */
/* Action:   Reads setup details from the setup screens, and calls an   */
/*           engine callback to provide it with the details.            */
/*                                                                      */
/************************************************************************/
static _kernel_oserror *ui_main_send_engine_setup (void)
{
  /* Collect setup info */
  int state;
  char *tmp;
  _kernel_oserror *er = NULL;

  /* Outside line prefix */
  if (setup_details.phone.outside_line_prefix != NULL)
    free (setup_details.phone.outside_line_prefix);
  er = radiobutton_get_state (0, ui_Dialling_WindowHandle, dialling_line_radio_no, &state,
                              NULL);
  if (er)
    return er;
  if (state == 1)
    setup_details.phone.outside_line_prefix = strdup ("");
  else
  {
    er = ui_misc_get_writable_value (ui_Dialling_WindowHandle, dialling_line,
                                     &setup_details.phone.outside_line_prefix);
    if (er)
      return er;
  }

  /* Call waiting prefix */
  if (setup_details.phone.call_waiting_prefix != NULL)
    free (setup_details.phone.call_waiting_prefix);
  er = radiobutton_get_state (0, ui_Dialling_WindowHandle, dialling_waiting_radio_no, &state,
                              NULL);
  if (er)
    return er;
  if (state == 1)
    setup_details.phone.call_waiting_prefix = strdup ("");
  else
  {
    er = ui_misc_get_writable_value (ui_Dialling_WindowHandle, dialling_waiting,
                                     &setup_details.phone.call_waiting_prefix);
    if (er)
      return er;
  }

  /* Wait for dialtone */
  er = radiobutton_get_state (0, ui_Dialling_WindowHandle, dialling_tone_radio_no, &state,
                              NULL);
  if (er)
    return er;
  if (state == 1)
    setup_details.phone.wait_for_dialtone_flag = 0;
  else
    setup_details.phone.wait_for_dialtone_flag = 1;

  /* Country code */
  er = ui_misc_get_writable_value (ui_Dialling_WindowHandle, dialling_code, &tmp);
  if (er)
  {
    if (tmp)
      free (tmp);
    return er;
  }
  setup_details.phone.country_code = atoi (tmp);
  if (tmp)
    free (tmp);

  /* ISP Phone number */
  if (setup_details.isp.phone_number != NULL)
    free (setup_details.isp.phone_number);

  er = ui_misc_get_writable_value (ui_ISP_WindowHandle, isp_phone,
                                   &setup_details.isp.phone_number);
  if (er)
    return er;

  /* ISP User Name */
  if (setup_details.isp.username != NULL)
    free (setup_details.isp.username);
  er = ui_misc_get_writable_value (ui_ISP_WindowHandle, isp_username,
                                   &setup_details.isp.username);
  if (er)
    return er;

  /* ISP Password */
  if (setup_details.isp.password != NULL)
    free (setup_details.isp.password);
  er = ui_misc_get_writable_value (ui_ISP_WindowHandle, isp_password,
                                   &setup_details.isp.password);
  if (er)
    return er;

  /* DNS Server(s) */
  if (setup_details.isp.dns != NULL)
    free (setup_details.isp.dns);
  er = ui_misc_get_writable_value (ui_ISP_WindowHandle, isp_dns,
                                   &setup_details.isp.dns);
  if (er)
    return er;

  /* Modem dial script */
  if (setup_details.isp.modem_script != NULL)
    free (setup_details.isp.modem_script);
  er = ui_misc_get_writable_value (ui_ISP_WindowHandle, isp_modemscript,
                                   &setup_details.isp.modem_script);
  if (er)
    return er;

  /* FTP URL */
  if (setup_details.ftp.url != NULL)
    free (setup_details.ftp.url);
  er = ui_misc_get_writable_value (ui_FTP_WindowHandle, ftp_url,
                                   &setup_details.ftp.url);
  if (er)
    return er;

  /* FTP User Name */
  if (setup_details.ftp.username != NULL)
    free (setup_details.ftp.username);
  er = ui_misc_get_writable_value (ui_FTP_WindowHandle, ftp_username,
                                   &setup_details.ftp.username);
  if (er)
    return er;

  /* FTP Password */
  if (setup_details.ftp.password != NULL)
    free (setup_details.ftp.password);
  er = ui_misc_get_writable_value (ui_FTP_WindowHandle, ftp_password,
                                   &setup_details.ftp.password);
  if (er)
    return er;


  /* Call engine callback to tell the engine to start */
  if (engine_callbacks.start_upgrade != NULL)
    engine_callbacks.start_upgrade (0u, &setup_details);

  return NULL;
}


/************************************************************************/
/* ui_main_abort_handler                                                */
/*                                                                      */
/* Inputs:   ToolboxEventHandler parameters.                            */
/* Outputs:  none                                                       */
/* Returns:  1                                                          */
/* Action:   Function will be called when the user clicks on one of the */
/*           abort buttons in the UI screens (Cancel or Stop in         */
/*           actuality.  Depending on where the click occurred the user */
/*           will be presented with the abort pop-up box with an        */
/*           appropriate message for the screen they were on.           */
/*                                                                      */
/************************************************************************/
static int ui_main_abort_handler (int event_code, ToolboxEvent *event, IdBlock *id_block,
                                  void *handle)
{
  char *tag, *ident;

  IGNORE (event_code); IGNORE (event); IGNORE (handle);

  if ((ui_main_encountered_abort != 0) || (ui_main_encountered_error != 0)
      || (ui_main_encountered_validate != 0))
  {
    dprintf (("", "encountered_abort = %d\n", ui_main_encountered_abort));
    dprintf (("", "encountered_error = %d\n", ui_main_encountered_error));
    dprintf (("", "encountered_validate = %d\n", ui_main_encountered_validate));
    return 1;
  }

  if (id_block->self_id == ui_Upgrade_WindowHandle)
  {
    if (ui_main_engine_busy == 1)
      return 1;

    ident = "stop,stop_sel";
    tag = "Abort_In_Upgrade";
  }
  else
  {
    ident = "restart,restart_sel";
    tag = "Abort_In_Setup";
  }

  toolaction_set_ident (toolaction_SET_IDENT_OFF, ui_Abort_WindowHandle, abort_button1, ident);

  button_set_value (0, ui_Abort_WindowHandle, abort_text,
                    lookup_message_token (&ui_message_block, tag));

  ui_main_encountered_abort = 1;

  toolbox_show_object (0u, ui_Abort_WindowHandle,
                       Toolbox_ShowObject_Centre, NULL, NULL, NULL);

  return 1;
}


/************************************************************************/
/* ui_main_validate_button_handler                                      */
/*                                                                      */
/* Inputs:   ToolboxEventHandler parameters.                            */
/* Outputs:  none                                                       */
/* Returns:  1                                                          */
/* Action:   Function will be called when the user clicks on the OK     */
/*           button in the validate pop-up.  The validate window will   */
/*           be closed allowing the user to fix the incorrect setup     */
/*           field.                                                     */
/*                                                                      */
/************************************************************************/
static int ui_main_validate_button_handler (int event_code, ToolboxEvent *event,
                                            IdBlock *id_block, void *handle)
{
  IGNORE (event_code); IGNORE (event); IGNORE (id_block); IGNORE (handle);

  if (ui_main_encountered_validate != 1)
    return 1;

  ui_main_encountered_validate = 0;

  toolbox_hide_object (0, ui_Validate_WindowHandle);

  return 1;
}


/************************************************************************/
/* ui_main_abort_buttons_handler                                        */
/*                                                                      */
/* Inputs:   ToolboxEventHandler parameters.                            */
/* Outputs:  none                                                       */
/* Returns:  1                                                          */
/* Action:   Function will be called when the user clicks on one of the */
/*           buttons in the abort pop-up.  Depending on the click       */
/*           the user will be returned to the welcome screen, or the    */
/*           user will be returned to the screen where they aborted.    */
/*                                                                      */
/************************************************************************/
static int ui_main_abort_buttons_handler (int event_code, ToolboxEvent *event,
                                          IdBlock *id_block,void *handle)
{
  IGNORE (event); IGNORE (id_block); IGNORE (handle);

  if (ui_main_encountered_abort != 1)
    return 1;

  toolbox_hide_object (0u, ui_Abort_WindowHandle);
  ui_main_encountered_abort = 0;

  /* Stop/cancel */
  if (event_code == abort_button1_event)
  {
    if (engine_callbacks.user_abort != NULL)
      engine_callbacks.user_abort (0u);

    if (ui_current_window == ui_Upgrade_WindowHandle)
    {
      toolaction_set_ident (toolaction_SET_IDENT_OFF, ui_Upgrade_WindowHandle, upgrade_stop,
                            "stop_faded,stop_faded");
      ui_main_engine_busy = 1;
    }
    else
    {
      ui_show_welcome (0u);
    }
  }

  return 1;
}


/************************************************************************/
/* ui_main_error_buttons_handler                                        */
/*                                                                      */
/* Inputs:   ToolboxEventHandler parameters.                            */
/* Outputs:  none                                                       */
/* Returns:  1                                                          */
/* Action:   Function will be called when the user clicks on one of the */
/*           buttons in the error pop-up.  Depending on the click       */
/*           the upgrade will be restarted, the user will return to the */
/*           options screen, or the user will be returned to the        */
/*           screen.                                                    */
/*                                                                      */
/************************************************************************/
static int ui_main_error_buttons_handler (int event_code, ToolboxEvent *event,
                                          IdBlock *id_block, void *handle)
{
  IGNORE (event); IGNORE (id_block); IGNORE (handle);

  if (ui_main_encountered_error != 1)
    return 1;

  if (ui_current_window == ui_Upgrade_WindowHandle)
  {
    toolaction_set_ident (toolaction_SET_IDENT_OFF, ui_Upgrade_WindowHandle, upgrade_stop,
                          "stop_faded,stop_faded");
    ui_main_engine_busy = 1;
  }

  switch (event_code)
  {
    /* Try again */
    case error_button1_event:
      if (ui_current_window == ui_Upgrade_WindowHandle)
      {
        if (engine_callbacks.error_action != NULL)
          engine_callbacks.error_action (0u, Action_TryAgain);
      }
      break;

    /* Options */
    case error_button2_event:
      if (ui_current_window != ui_Upgrade_WindowHandle)
      {
        ui_show_setup (0u);
      }
      else
      {
        if (engine_callbacks.error_action != NULL)
          engine_callbacks.error_action (0u, Action_Options);
      }
      break;

    /* Cancel */
    default:
    case  error_button3_event:
      if (ui_current_window != ui_Upgrade_WindowHandle)
      {
        ui_show_welcome (0u);
      }
      else
      {
        if (engine_callbacks.error_action != NULL)
          engine_callbacks.error_action (0u, Action_Cancel);
      }
      break;
  }

  toolbox_hide_object (0u, ui_Error_WindowHandle);

  ui_main_encountered_error = 0;

  return 1;
}


/************************************************************************/
/* ui_main_error2_button_handler                                        */
/*                                                                      */
/* Inputs:   ToolboxEventHandler parameters.                            */
/* Outputs:  none                                                       */
/* Returns:  1                                                          */
/* Action:   Function will be called when the user clicks on the OK     */
/*           button in the error2 pop-up.  The pop-up is closed.        */
/*                                                                      */
/************************************************************************/
static int ui_main_error2_button_handler (int event_code, ToolboxEvent *event,
                                          IdBlock *id_block, void *handle)
{
  IGNORE (event_code); IGNORE (event); IGNORE (id_block); IGNORE (handle);

  dprintf (("", "here\n"));

/*  if (ui_main_encountered_error != 1)
    return 1; */

  dprintf (("", "here too\n"));

  if (ui_current_window == ui_Upgrade_WindowHandle)
  {
    if (engine_callbacks.error_action != NULL)
      engine_callbacks.error_action (0u, Action_OK);
  }

  toolbox_hide_object (0u, ui_Error2_WindowHandle);

  ui_main_encountered_error = 0;

  /* Call the resume callback */
  if (engine_callbacks.resume != NULL)
    engine_callbacks.resume (0u);

  return 1;
}

/************************************************************************/
/* ui_main_reboot_handler                                               */
/*                                                                      */
/* Inputs:   ToolboxEventHandler parameters.                            */
/* Outputs:  none                                                       */
/* Returns:  1                                                          */
/* Action:   Function will be called when the user clicks on the cancel */
/*           button in the welcome screen.  The return_to_main_os       */
/*           callback is called, which will reboot the machine to the   */
/*           main OS.                                                   */
/*                                                                      */
/************************************************************************/
static int ui_main_reboot_handler (int event_code, ToolboxEvent *event, IdBlock *id_block,
                                   void *handle)
{
  IGNORE (event_code); IGNORE (event); IGNORE (id_block); IGNORE (handle);

  if (engine_callbacks.return_to_main_os != NULL)
    engine_callbacks.return_to_main_os (0);

  return 1;
}


/************************************************************************/
/* ui_main_reset_setup                                                  */
/*                                                                      */
/* Inputs:   none                                                       */
/* Outputs:  none                                                       */
/* Returns:  Pointer to an error block, or NULL if no error             */
/* Action:   Reads the setup details from the options windows, and puts */
/*           the data into the setup_details structure.                 */
/*                                                                      */
/************************************************************************/
static _kernel_oserror  *ui_main_reset_setup (void)
{
  char num[20];
  _kernel_oserror *er = NULL;

  /* Country code */
  sprintf (num, "%d", setup_details.phone.country_code);
  er = writablefield_set_value (0u, ui_Dialling_WindowHandle, dialling_code, num);
  if (er)
    return er;

  /* Outside line prefix */
  if (strlen (setup_details.phone.outside_line_prefix))
  {
    er = radiobutton_set_state (0, ui_Dialling_WindowHandle, dialling_line_radio_no, 0);
    if (er)
      return er;
    er = radiobutton_set_state (0, ui_Dialling_WindowHandle, dialling_line_radio_yes, 1);
    if (er)
      return er;
    er = writablefield_set_value (0u, ui_Dialling_WindowHandle, dialling_line,
                                  setup_details.phone.outside_line_prefix);
    if (er)
      return er;
  }
  else
  {
    er = radiobutton_set_state (0, ui_Dialling_WindowHandle, dialling_line_radio_no, 1);
    if (er)
      return er;
    er = radiobutton_set_state (0, ui_Dialling_WindowHandle, dialling_line_radio_yes, 0);
    if (er)
      return er;
    er = writablefield_set_value (0u, ui_Dialling_WindowHandle, dialling_line, "");
    if (er)
      return er;
  }

  /* Call waiting prefix */
  if (strlen (setup_details.phone.call_waiting_prefix))
  {
    er = radiobutton_set_state (0, ui_Dialling_WindowHandle, dialling_waiting_radio_no, 0);
    if (er)
      return er;
    er = radiobutton_set_state (0, ui_Dialling_WindowHandle, dialling_waiting_radio_yes, 1);
    if (er)
      return er;
    er = writablefield_set_value (0u, ui_Dialling_WindowHandle, dialling_waiting,
                                  setup_details.phone.call_waiting_prefix);
    if (er)
      return er;
  }
  else
  {
    er = radiobutton_set_state (0, ui_Dialling_WindowHandle, dialling_waiting_radio_no, 1);
    if (er)
      return er;
    er = radiobutton_set_state (0, ui_Dialling_WindowHandle, dialling_waiting_radio_yes, 0);
    if (er)
      return er;
    er = writablefield_set_value (0u, ui_Dialling_WindowHandle, dialling_waiting, "");
    if (er)
      return er;
  }

  /* Wait for dialtone */
  if (setup_details.phone.wait_for_dialtone_flag == 1)
  {
    er = radiobutton_set_state (0, ui_Dialling_WindowHandle, dialling_tone_radio_no, 0);
    if (er)
      return er;
    er = radiobutton_set_state (0, ui_Dialling_WindowHandle, dialling_tone_radio_yes, 1);
    if (er)
      return er;
  }
  else
  {
    er = radiobutton_set_state (0, ui_Dialling_WindowHandle, dialling_tone_radio_no, 1);
    if (er)
      return er;
    er = radiobutton_set_state (0, ui_Dialling_WindowHandle, dialling_tone_radio_yes, 0);
    if (er)
      return er;
  }

  /* ISP options */
  er = writablefield_set_value (0u, ui_ISP_WindowHandle, isp_phone,
                                setup_details.isp.phone_number);
  if (er)
    return er;
  er = writablefield_set_value (0u, ui_ISP_WindowHandle, isp_username,
                                setup_details.isp.username);
  if (er)
    return er;
  er = writablefield_set_value (0u, ui_ISP_WindowHandle, isp_password,
                                setup_details.isp.password);
  if (er)
    return er;
  er = writablefield_set_value (0u, ui_ISP_WindowHandle, isp_dns, setup_details.isp.dns);
  if (er)
    return er;
  er = writablefield_set_value (0u, ui_ISP_WindowHandle, isp_modemscript,
                                setup_details.isp.modem_script);
  if (er)
    return er;

  /* FTP Options */
  er = writablefield_set_value (0u, ui_FTP_WindowHandle, ftp_url, setup_details.ftp.url);
  if (er)
    return er;
  er = writablefield_set_value (0u, ui_FTP_WindowHandle, ftp_username,
                                setup_details.ftp.username);
  if (er)
    return er;
  er = writablefield_set_value (0u, ui_FTP_WindowHandle, ftp_password,
                                setup_details.ftp.password);

  return er;
}


static void ui_main_keyboard (unsigned int code)
{
  static int on = 0;

  if (code == 1)
  {
    char var[20];
    _kernel_oserror *er;

    er = _kernel_getenv ("NCKeybd$Running", var, sizeof (var));

    if (er)
    {
      dprintf (("", "NCKeybd$Running not set\n"));
      on = 0;
    }
    else
    {
      dprintf (("", "NCKeybd$Running set..."));
      if (strcmp (var, "TRUE")==0)
      {
        dprintf (("", "to TRUE\n"));
        on = 1;
      }
      else
        dprintf (("", "to \"%s\"\n", var));
    }
  }
  else
  {
    if (on == 0)
    {
      if (stored_time == 0 || (stored_time < (clock () - (CLOCKS_PER_SEC / 2))))
      {
        dprintf (("", "Turn on OSKB\n"));
        _swix (Wimp_StartTask, _IN(0), "nckeyboard -scrolldown 576");
        on = 1;
      }
    }
  }
}


static int ui_main_keyboard_closed_handler (WimpMessage *message, void *handle)
{
  IGNORE (message); IGNORE (handle);

  stored_time = clock ();

  ui_main_keyboard (1u);

  return 1;
}


/************************************************************************/
/* ui_main_default_key_handler                                          */
/*                                                                      */
/* Inputs:   Toolbox event handler inputs                               */
/* Outputs:  none                                                       */
/* Returns:  1                                                          */
/* Action:   Function processes all key presses, and if they are not    */
/*           used by this  program (e.g. F12), then they are ignored,   */
/*           and the WIMP processes them                                */
/*                                                                      */
/************************************************************************/
static int ui_main_default_key_handler (int event_code, WimpPollBlock *event, IdBlock *id_block,
                                        void *handle)
{
  WimpKeyPressedEvent *key_event = (WimpKeyPressedEvent *) event;

  IGNORE (event_code); IGNORE (id_block); IGNORE (handle);

  switch (key_event->key_code)
  {
    case 0x1CB: /* F11 */

      ui_main_keyboard (0u);
      break;

    default:
      wimp_process_key (key_event->key_code);
  }

  return 1;
}


/************************************************************************/
/* ui_main_attach_handlers                                              */
/*                                                                      */
/* Inputs:   ToolboxEventHandler parameters.                            */
/* Outputs:  none                                                       */
/* Returns:  1                                                          */
/* Action:   Function will be called when an object is auto-created     */
/*           This object is then initialised, including event handlers  */
/*           for gadgets in that object.                                */
/*                                                                      */
/************************************************************************/
static int ui_main_attach_handlers (int event_code,ToolboxEvent *event,IdBlock *id_block,
                                    void *handle)
{
  _kernel_oserror *er;
  ToolboxObjectAutoCreatedEvent *created_event=(ToolboxObjectAutoCreatedEvent *) event;

  IGNORE (event_code); IGNORE (id_block); IGNORE (handle);

  /* Isp options window */
  if (strcmp (created_event->template_name, "ISP")==0)
  {
    /* Define handle for ISP options window */
    ui_ISP_WindowHandle = id_block->self_id;

    /*  Setup colours for window components */
    ui_misc_set_writable_colours (ui_ISP_WindowHandle, isp_phone);
    ui_misc_set_writable_colours (ui_ISP_WindowHandle, isp_username);
    ui_misc_set_writable_colours (ui_ISP_WindowHandle, isp_password);
    ui_misc_set_writable_colours (ui_ISP_WindowHandle, isp_dns);
    ui_misc_set_writable_colours (ui_ISP_WindowHandle, isp_modemscript);

    /* Setup fonts for window components */
    ui_misc_set_label_font (ui_ISP_WindowHandle, isp_phone_label);
    ui_misc_set_label_font (ui_ISP_WindowHandle, isp_username_label);
    ui_misc_set_label_font (ui_ISP_WindowHandle, isp_password_label);
    ui_misc_set_label_font (ui_ISP_WindowHandle, isp_dns_label);
    ui_misc_set_label_font (ui_ISP_WindowHandle, isp_domain_label);

    ui_misc_set_title_font (ui_ISP_WindowHandle, isp_title);
  }

  /* Finished window */
  else if (strcmp (created_event->template_name, "Finished")==0)
  {
    /* Define handle for Finished window */
    ui_Finished_WindowHandle = id_block->self_id;

    /* Setup fonts for window components */
    ui_misc_set_title_font (ui_Finished_WindowHandle, finished_title);
    ui_misc_set_label_font (ui_Finished_WindowHandle, finished_text);

    /* Register button handler */
    event_register_toolbox_handler (ui_Finished_WindowHandle, reboot_event,
                                    ui_main_reboot_handler, NULL);
  }

  /* Dialling options window */
  else if (strcmp (created_event->template_name, "Dialling")==0)
  {
    /* Define handle for Dialling options window */
    ui_Dialling_WindowHandle = id_block->self_id;

    /*  Setup colours for window components */
    ui_misc_set_writable_colours (ui_Dialling_WindowHandle, dialling_code);
    ui_misc_set_writable_colours (ui_Dialling_WindowHandle, dialling_line);
    ui_misc_set_writable_colours (ui_Dialling_WindowHandle, dialling_waiting);

    /* Setup fonts for window components */
    ui_misc_set_label_font (ui_Dialling_WindowHandle, dialling_code_label);
    ui_misc_set_label_font (ui_Dialling_WindowHandle, dialling_line_label);
    ui_misc_set_label_font (ui_Dialling_WindowHandle, dialling_tone_label);
    ui_misc_set_label_font (ui_Dialling_WindowHandle, dialling_waiting_label);

    ui_misc_set_radio_colours (ui_Dialling_WindowHandle, dialling_line_radio_no);
    ui_misc_set_radio_colours (ui_Dialling_WindowHandle, dialling_line_radio_yes);
    ui_misc_set_radio_colours (ui_Dialling_WindowHandle, dialling_tone_radio_no);
    ui_misc_set_radio_colours (ui_Dialling_WindowHandle, dialling_tone_radio_yes);
    ui_misc_set_radio_colours (ui_Dialling_WindowHandle, dialling_waiting_radio_no);
    ui_misc_set_radio_colours (ui_Dialling_WindowHandle, dialling_waiting_radio_yes);

    ui_misc_set_title_font (ui_Dialling_WindowHandle, dialling_title);
  }

  /* Welcome window */
  else if (strcmp (created_event->template_name, "Welcome")==0)
  {
    /* Define handle for Welcome window */
    ui_Welcome_WindowHandle = id_block->self_id;

    /* Setup fonts for window components */
    ui_misc_set_label_font (ui_Welcome_WindowHandle, welcome_text);

    /* Register button handler */
    er = event_register_toolbox_handler (ui_Welcome_WindowHandle, reboot_event,
                                         ui_main_reboot_handler, NULL);

    /* Show the welcome screen */
    ui_main_show_welcome ();
  }

  /* FTP options window */
  else if (strcmp (created_event->template_name, "FTP")==0)
  {
    /* Define handle for FTP Options window */
    ui_FTP_WindowHandle = id_block->self_id;

    /* Setup colours for window components */
    ui_misc_set_writable_colours (ui_FTP_WindowHandle, ftp_url);
    ui_misc_set_writable_colours (ui_FTP_WindowHandle, ftp_username);
    ui_misc_set_writable_colours (ui_FTP_WindowHandle, ftp_password);

    /* Setup fonts for window components */
    ui_misc_set_label_font (ui_FTP_WindowHandle, ftp_url_label);
    ui_misc_set_label_font (ui_FTP_WindowHandle, ftp_username_label);
    ui_misc_set_label_font (ui_FTP_WindowHandle, ftp_password_label);

    ui_misc_set_title_font (ui_FTP_WindowHandle, ftp_title);
  }

  /* Done window */
  else if (strcmp (created_event->template_name, "Done")==0)
  {
    /* Define handle for Done window */
    ui_Done_WindowHandle = id_block->self_id;

    /* Setup fonts for window components */
    ui_misc_set_label_font (ui_Done_WindowHandle, done_message1);
    ui_misc_set_label_font (ui_Done_WindowHandle, done_message2);
    ui_misc_set_label_font (ui_Done_WindowHandle, done_message3);

    ui_misc_set_title_font (ui_Done_WindowHandle, done_title);
  }

  /* Upgrade window */
  else if (strcmp (created_event->template_name, "Upgrade")==0)
  {
    /* Define handle for Upgrade window */
    ui_Upgrade_WindowHandle = id_block->self_id;

    /* Setup fonts for window components */
    ui_misc_set_label_font (ui_Upgrade_WindowHandle, upgrade_status);
    ui_misc_set_label_font (ui_Upgrade_WindowHandle, upgrade_downloadtime);
    ui_misc_set_label_font (ui_Upgrade_WindowHandle, upgrade_percent);

    ui_misc_set_title_font (ui_Upgrade_WindowHandle, upgrade_title);
  }

  /* Error pop-up */
  else if (strcmp (created_event->template_name, "Error")==0)
  {
    /* Define handle for Error pop-up */
    ui_Error_WindowHandle = id_block->self_id;

    /* Setup fonts for pop-up components */
    ui_misc_set_label_font (ui_Error_WindowHandle, error_text);
    ui_misc_set_label_font (ui_Error_WindowHandle, error_text2);

    ui_misc_set_title_font (ui_Error_WindowHandle, error_title);

    /* Register the button press handlers */
    event_register_toolbox_handler (ui_Error_WindowHandle, error_button1_event,
                                    ui_main_error_buttons_handler, NULL);
    event_register_toolbox_handler (ui_Error_WindowHandle, error_button2_event,
                                    ui_main_error_buttons_handler, NULL);
    event_register_toolbox_handler (ui_Error_WindowHandle, error_button3_event,
                                    ui_main_error_buttons_handler, NULL);
  }

  /* Error pop-up */
  else if (strcmp (created_event->template_name, "Error2")==0)
  {
    /* Define handle for Error pop-up */
    ui_Error2_WindowHandle = id_block->self_id;

    /* Setup fonts for pop-up components */
    ui_misc_set_label_font (ui_Error2_WindowHandle, error2_text);

    ui_misc_set_title_font (ui_Error2_WindowHandle, error2_title);

    /* Register the button press handlers */
    event_register_toolbox_handler (ui_Error2_WindowHandle, error2_button_event,
                                    ui_main_error2_button_handler, NULL);
  }

  /* Abort pop-up */
  else if (strcmp (created_event->template_name, "Abort")==0)
  {
    /* Define handle for Abort pop-up */
    ui_Abort_WindowHandle = id_block->self_id;

    /* Setup fonts for pop-up components */
    ui_misc_set_label_font (ui_Abort_WindowHandle, abort_text);

    /* ui_misc_set_title_font (ui_Abort_WindowHandle, abort_title); */

    /* Register the button press handlers */
    event_register_toolbox_handler (ui_Abort_WindowHandle, abort_button1_event,
                                    ui_main_abort_buttons_handler, NULL);
    event_register_toolbox_handler (ui_Abort_WindowHandle, abort_button2_event,
                                    ui_main_abort_buttons_handler, NULL);
  }

  /* Validate pop-up */
  else if (strcmp (created_event->template_name, "Validate")==0)
  {
    /* Define handle for Validate pop-up */
    ui_Validate_WindowHandle = id_block->self_id;

    /* Setup fonts for pop-up components */
    ui_misc_set_label_font (ui_Validate_WindowHandle, validate_text);

    /* Register the button press handler */
    event_register_toolbox_handler (ui_Validate_WindowHandle, validate_button_event,
                                    ui_main_validate_button_handler, NULL);
  }

  else if (strcmp (created_event->template_name, "Keys")==0)
  {
    event_register_wimp_handler (-1/*id_block->self_id*/, Wimp_EKeyPressed,
                                 ui_main_default_key_handler, NULL);
  }

  /* MENUS */

  /* Iconbar menu */
  else if (strcmp (created_event->template_name, "ibar_menu")==0)
  {
    /* Define handle for Iconbar menu */
    ui_Ibar_MenuHandle = id_block->self_id;

    /* Register the Quit menu entry handler */
    er = event_register_toolbox_handler (id_block->self_id, menu_quit_event,
                                         ui_menu_quit_program, NULL);
  }

  /* Iconbar icon */
  else if (strcmp (created_event->template_name, "Iconbar")==0)
  {
    /* Define handle for Iconbar */
    ui_Icon_BarHandle = id_block->self_id;
  }

  /* ProgInfo box */
  else if (strcmp (created_event->template_name, "ProgInfo")==0)
  {
#ifdef DEBUG
    char *version;

    /* Define handle for Proginfo box */
    ui_ProgInfo_WindowHandle = id_block->self_id;

    version = malloc (strlen (Module_MajorVersion) + strlen (Module_MinorVersion) +
                      strlen (Module_Date) + 5);

    if (version != NULL)
    {
      if (strlen (Module_MinorVersion == 0))
        sprintf (version, "%s (%s)", Module_MajorVersion, Module_Date);
      else
        sprintf (version, "%s %s (%s)", Module_MajorVersion, Module_MinorVersion, Module_Date);

      /* Set the version string */
      proginfo_set_version (0, ui_ProgInfo_WindowHandle, version);

      free (version);
    }
#endif
  }

  return 1;
}


/************************************************************************/
/* ui_main_navigation_handler                                           */
/*                                                                      */
/* Inputs:   Toolbox event handler inputs                               */
/* Outputs:  none                                                       */
/* Returns:  1                                                          */
/* Action:   Function handles button presses for user procession        */
/*           through the setup screens, acting accordingly to allow     */
/*           this progression                                           */
/*                                                                      */
/************************************************************************/
static int ui_main_navigation_handler (int event_code, ToolboxEvent *event, IdBlock *id_block,
                                       void *handle)
{
  _kernel_oserror *er = NULL;
  int valid = 1;

  IGNORE (event); IGNORE (id_block); IGNORE (handle);

  /* If we've got an error or abort pop-up on screen, disregard button presses */
  if (ui_main_encountered_abort != 0 || ui_main_encountered_error != 0 ||
      ui_main_encountered_validate != 0)
  {
    dprintf (("", "abort = %d, error = %d, validiate = %d\n", ui_main_encountered_abort,
              ui_main_encountered_error, ui_main_encountered_validate));
    return 1;
  }

  switch (event_code)
  {
    /* Button press that brings user to Dialling Options screen */
    case show_dialling_event:

      if (ui_current_window == ui_Welcome_WindowHandle)
      {
        /* If we're entering Dialling from Welcome, call the engine callback to
           inform that engine that we're starting */
        if (engine_callbacks.setup_started != NULL)
          er = engine_callbacks.setup_started (0u);
      }

      /* If we've new setup details from the engine ... */
      if (new_setup_details)
      {
        /* .. read them and reset the flag */
        ui_main_reset_setup ();
        new_setup_details = 0;
      }

      /* Open the Dialling Options window */
      ui_current_window = ui_Dialling_WindowHandle;
      toolbox_show_object (0u, ui_Dialling_WindowHandle,
                           Toolbox_ShowObject_Centre, NULL, NULL, NULL);
      toolbox_hide_object (0u, ui_ISP_WindowHandle);
      toolbox_hide_object (0u, ui_Welcome_WindowHandle);

      break;

    /* Button press that brings user to ISP Options screen */
    case show_isp_event:

      /* If we're progressing from Dialling Options to ISP options, first make
         sure all the options are valid.  If they're not, don't progress */
      if (ui_current_window == ui_Dialling_WindowHandle)
      {
        ui_main_validate_dialling(&valid);
        if (valid != 1)
          break;
      }

      /* Open the ISP Options window */
      ui_current_window = ui_ISP_WindowHandle;
      toolbox_show_object (0u, ui_ISP_WindowHandle,
                           Toolbox_ShowObject_Centre, NULL, NULL, NULL);
      toolbox_hide_object (0u, ui_FTP_WindowHandle);
      toolbox_hide_object (0u, ui_Dialling_WindowHandle);
      break;

    /* Button press than brings user to FTP Options screen */
    case show_ftp_event:

      /* If we're progressing from ISP Options to FP options, first make
         sure all the options are valid.  If they're not, don't progress */
      if (ui_current_window == ui_ISP_WindowHandle)
      {
        ui_main_validate_isp(&valid);
        if (valid != 1)
          break;
      }

      /* Open the FTP Options window */
      ui_current_window = ui_FTP_WindowHandle;
      toolbox_show_object (0u, ui_FTP_WindowHandle,
                           Toolbox_ShowObject_Centre, NULL, NULL, NULL);
      toolbox_hide_object (0u, ui_ISP_WindowHandle);
      toolbox_hide_object (0u, ui_Done_WindowHandle);
      break;

    /* Button press than brings user to done screen */
    case show_done_event:

      /* If we're progressing from FP Options to the done screen, first make
         sure all the options are valid.  If they're not, don't progress */
      if (ui_current_window == ui_FTP_WindowHandle)
      {
        ui_main_validate_ftp(&valid);
        if (valid != 1)
          break;
      }

      /* Open the done window */
      ui_current_window = ui_Done_WindowHandle;
      toolbox_show_object (0u, ui_Done_WindowHandle,
                           Toolbox_ShowObject_Centre, NULL, NULL, NULL);
      toolbox_hide_object (0u, ui_FTP_WindowHandle);
      break;

    /* Upgrade button pressed in done window */
    case start_upgrade_event:
      ui_current_window = ui_Upgrade_WindowHandle;

      /* Intialise the upgrade screen */
      ui_set_progress_percent (0u, 0);
      ui_set_estimated_download_time (0u, -1, 0); /* Clear the time field */

      /* Open the upgrade screen */
      toolbox_show_object (0u, ui_Upgrade_WindowHandle,
                           Toolbox_ShowObject_Centre, NULL, NULL, NULL);
      toolbox_hide_object (0u, ui_Done_WindowHandle);

      /* Send the engine the setup details */
      ui_main_send_engine_setup ();

      ui_set_progress_message (0u, ISP_Dial_Stage);
      break;
  }

  return 1;
}


/************************************************************************/
/* ui_main_message_control                                              */
/*                                                                      */
/* Inputs:   WimpMessage parameters.                                    */
/* Outputs:  none                                                       */
/* Returns:  1                                                          */
/* Action:   On receiving a wimp quit message, setthe quit flag to 1   */
/*                                                                      */
/************************************************************************/
static int ui_main_message_control (WimpMessage *message, void *handle)
{
  IGNORE (handle);

  switch(message->hdr.action_code)
  {
    case Wimp_MQuit:
      quit = 1;
      break;

  }
  return 1;
}


/************************************************************************/
/* ui_main_set_percent_chunk                                            */
/*                                                                      */
/* Inputs:   percent - Percent chunk to set                             */
/*           on - if 1, set chunk on, else set chunk off                */
/* Outputs:  none                                                       */
/* Returns:  Pointer to an error block, or NULL if no error             */
/* Action:   Sets chunk of progress bar on or off                       */
/*                                                                      */
/************************************************************************/
static _kernel_oserror *ui_main_set_percent_chunk (int percent, int on)
{
  ComponentId button;
  int colour;

  dprintf (("", "percent chunk: %d (%s)\n", percent, (on == 1) ? "on" : "off"));

  /* Select button component Id based on "percent" */
  switch (percent)
  {
    case 100:
      button = upgrade_percent_100;
      break;
    case 95:
      button = upgrade_percent_95;
      break;
    case 90:
      button = upgrade_percent_90;
      break;
    case 85:
      button = upgrade_percent_85;
      break;
    case 80:
      button = upgrade_percent_80;
      break;
    case 75:
      button = upgrade_percent_75;
      break;
    case 70:
      button = upgrade_percent_70;
      break;
    case 65:
      button = upgrade_percent_65;
      break;
    case 60:
      button = upgrade_percent_60;
      break;
    case 55:
      button = upgrade_percent_55;
      break;
    case 50:
      button = upgrade_percent_50;
      break;
    case 45:
      button = upgrade_percent_45;
      break;
    case 40:
      button = upgrade_percent_40;
      break;
    case 35:
      button = upgrade_percent_35;
      break;
    case 30:
      button = upgrade_percent_30;
      break;
    case 25:
      button = upgrade_percent_25;
      break;
    case 20:
      button = upgrade_percent_20;
      break;
    case 15:
      button = upgrade_percent_15;
      break;
    case 10:
      button = upgrade_percent_10;
      break;
    default:
    case 5:
      button = upgrade_percent_05;
  }

  /* Set button colour based on "on" */
  if (on == 1)
  {
    /* bright green */
    colour = 10;
  }
  else
  {
    /* black */
    colour = 7;
  }

  /* Set the button's colour */
  return button_set_colour (2u, ui_Upgrade_WindowHandle, button, 0, colour);
}


/****************************/
/* Exported (API) Functions */


/************************************************************************/
/* ui_reset_stop_button                                                 */
/*                                                                      */
/* Inputs:   flags - For future expansion/flexibility                   */
/* Outputs:  none                                                       */
/* Returns:  Pointer to an error block, or NULL if no error             */
/* Action:   The engine calls this to tell the UI that it it will now   */
/*           allow a user abort in the upgrade screen.  The stop button */
/*           is unfaded.                                                */
/*                                                                      */
/************************************************************************/
_kernel_oserror *ui_reset_stop_button (unsigned int flags)
{
  IGNORE (flags);

  /* Set the upgrade screen stop button back to "active" */

  toolaction_set_ident (toolaction_SET_IDENT_OFF, ui_Upgrade_WindowHandle, upgrade_stop,
                        "stop,stop_sel");
  ui_main_engine_busy = 0;

  return NULL;
}


/************************************************************************/
/* ui_finished_upgrade                                                  */
/*                                                                      */
/* Inputs:   flags - For future expansion/flexibility                   */
/* Outputs:  none                                                       */
/* Returns:  Pointer to an error block, or NULL if no error             */
/* Action:   Displays the "finished upgrade screen"                     */
/*                                                                      */
/************************************************************************/
_kernel_oserror *ui_finished_upgrade (unsigned int flags)
{
  _kernel_oserror *er;

  IGNORE (flags);

  er = toolbox_show_object (0u, ui_Finished_WindowHandle,
                            Toolbox_ShowObject_Centre, NULL, NULL, NULL);
  if (er)
    return er;
  er = toolbox_hide_object (0u, ui_current_window);
  if (er)
    return er;

  ui_current_window = ui_Finished_WindowHandle;

  return NULL;
}


/************************************************************************/
/* ui_show_error                                                        */
/*                                                                      */
/* Inputs:   flags - Bit 0, if set only give user ability to choose     */
/*           "OK", else if unset allow "Try Again","Options","Cancel".  */
/*           Remaining bits for future expansion/flexibility.           */
/*           error - Error number                                       */
/* Outputs:  none                                                       */
/* Returns:  Pointer to an error block, or NULL if no error             */
/* Action:   Displays an error message appropriate to the error code in */
/*           an error pop-up box, and gives the user a choice of        */
/*           appropriate actions to take                                */
/*                                                                      */
/************************************************************************/
_kernel_oserror *ui_show_error (unsigned int flags, error_t error)
{
  char *tag;
  _kernel_oserror *er = NULL;

  if (ui_current_window == ui_Upgrade_WindowHandle)
  {
    toolaction_set_ident (toolaction_SET_IDENT_OFF, ui_Upgrade_WindowHandle, upgrade_stop,
                          "stop_faded,stop_faded");
    ui_main_engine_busy = 1;
  }

  /* Select an error tag based on the error number */
  switch (error)
  {
    case Connection_Failure:
      tag = "Error_Connection_Failure";
      break;

    case ISP_Authentication_Failure:
      tag = "Error_ISP_Authentication_Failure";
      break;

    case FTP_Authentication_Failure:
      tag = "Error_FTP_Authentication_Failure";
      break;

    case ImageFault_Failure:
      tag = "Error_ImageFault_Failure";
      break;

    case NotFound_Failure:
      tag = "Error_NotFound_Failure";
      break;

    case Download_Failure:
      tag = "Error_Download_Failure";
      break;

    case Programming_Failure:
      tag = "Error_Programming_Failure";
      break;

    default:
      tag = "Error_Unexpected";
  }

  if (flags & 1)
  {
    /* Set the error pop-up's text */
    er = button_set_value (0, ui_Error2_WindowHandle, error2_text,
                           lookup_message_token (&ui_message_block, tag));

    if (er)
      return er;
    else
      dprintf (("", "Button set OK\n"));

    /* Display the error popup */
    er = toolbox_show_object (0, ui_Error2_WindowHandle,
                              Toolbox_ShowObject_Centre, NULL, NULL, NULL);


  }
  else
  {
    /* Set the error pop-up's text */
    er = button_set_value (0, ui_Error_WindowHandle, error_text,
                           lookup_message_token (&ui_message_block, tag));

    if (er)
      return er;
    else
      dprintf (("", "Button set OK\n"));

    /* Display the error popup */
    er = toolbox_show_object (0, ui_Error_WindowHandle,
                              Toolbox_ShowObject_Centre, NULL, NULL, NULL);
  }
  if (er)
    return er;
  else
    dprintf (("", "Show OK\n"));

  /* And set a flag so that we know the pop-up is active */
  ui_main_encountered_error = 1;

  return NULL;
}


/************************************************************************/
/* ui_show_welcome                                                      */
/*                                                                      */
/* Inputs:   flags - For future expansion/flexibility                   */
/* Outputs:  none                                                       */
/* Returns:  Pointer to an error block, or NULL if no error             */
/* Action:   Displays the "welcome" screen                              */
/*                                                                      */
/************************************************************************/
_kernel_oserror *ui_show_welcome (unsigned int flags)
{
  IGNORE (flags);

  ui_current_window = ui_Welcome_WindowHandle;

  return toolbox_show_object (0, ui_Welcome_WindowHandle,
                              Toolbox_ShowObject_Centre, NULL, NULL, NULL);
}


/************************************************************************/
/* ui_show_setup                                                        */
/*                                                                      */
/* Inputs:   flags - For future expansion/flexibility                   */
/* Outputs:  none                                                       */
/* Returns:  Pointer to an error block, or NULL if no error             */
/* Action:   Displays the first options screen, "dialling".             */
/*                                                                      */
/************************************************************************/
_kernel_oserror *ui_show_setup (unsigned int flags)
{
  IGNORE (flags);

  ui_current_window = ui_Dialling_WindowHandle;

  return toolbox_show_object (0, ui_Dialling_WindowHandle,
                              Toolbox_ShowObject_Centre, NULL, NULL, NULL);
}


/************************************************************************/
/* ui_set_progess_message                                               */
/*                                                                      */
/* Inputs:   flags - For future expansion/flexibility                   */
/*           stage - Download stage to display                          */
/* Outputs:  none                                                       */
/* Returns:  Pointer to an error block, or NULL if no error             */
/* Action:   Sets Upgrade screen stage of progress to the appropriate   */
/*           representation for the stage indicated  by "stage"         */
/*                                                                      */
/************************************************************************/
_kernel_oserror *ui_set_progress_message (unsigned int flags, progress_stage_t stage)
{
  char *tag;
  _kernel_oserror *er = NULL;

  /* If bit 1 of the flags word is set, just clear the status line */
  if (flags & 1)
  {
    er = button_set_value (0, ui_Upgrade_WindowHandle, upgrade_status, "");
    if (er)
      return er;
  }
  else
  {
    /* else display the value of a tag selected by the progress stage */

    switch (stage)
    {
      case ISP_Dial_Stage:
        tag = "Stage_ISP_Dial";
        break;

      case ISP_Connect_Stage:
        tag = "Stage_ISP_Connect";
        break;

      case FTP_Connect_Stage:
        tag = "Stage_FTP_Connect";
        break;

      case FTP_Fetch_Stage:
        tag = "Stage_FTP_Fetch";
        break;

      case FTP_Disconnect_Stage:
        tag = "Stage_FTP_Disconnect";
        break;

      case ISP_Disconnect_Stage:
        tag = "Stage_ISP_Disconnect";
        break;

      default:
        tag = "Stage_Unknown";
    }

    er = button_set_value (0, ui_Upgrade_WindowHandle, upgrade_status,
                           lookup_message_token (&ui_message_block, tag));
    if (er)
      return er;
  }

  return NULL;
}


/************************************************************************/
/* ui_set_estimated_download_time                                       */
/*                                                                      */
/* Inputs:   flags - For future expansion/flexibility                   */
/*           mins - Number of minutes to display in estimated download  */
/*                  time field                                          */
/*           seconds - Number of seconds to display in estimated        */
/*                     download time field                              */
/* Outputs:  none                                                       */
/* Returns:  Pointer to an error block, or NULL if no error             */
/* Action:   Sets Upgrade screen estimated download time field to       */
/*           "mins" minutes, "seconds" seconds                          */
/*                                                                      */
/************************************************************************/
_kernel_oserror * ui_set_estimated_download_time (unsigned int flags, int mins, int seconds)
{
  char *message;
  char num[20], num2[20], *mins_nomins, *secs_nosecs;
  int nbytes;
  _kernel_oserror *er = NULL;

  IGNORE (flags);

  /* If mins is -1 just clear the field */
  if (mins == -1)
  {
    er = button_set_value (0u, ui_Upgrade_WindowHandle, upgrade_downloadtime, "");
    if (er)
      return er;
  }
  else
  {
    /* Else display the field based on mins, seconds and a messages token */

    if (mins == 1)
      mins_nomins = "";
    else
      mins_nomins = "s";

    if (seconds == 1)
      secs_nosecs = "";
    else
      secs_nosecs = "s";

    sprintf (num, "%d", mins);
    sprintf (num2, "%d", seconds);

    lookup_message_token_params (&ui_message_block, "DownloadTime", num, mins_nomins, num2,
                                 secs_nosecs, 0, 0, &nbytes);
    message = malloc (nbytes);

    if (message != NULL)
    {
      lookup_message_token_params (&ui_message_block, "DownloadTime", num, mins_nomins, num2,
                                   secs_nosecs, message, nbytes, &nbytes);
      er = button_set_value (0u, ui_Upgrade_WindowHandle, upgrade_downloadtime, message);

      free (message);
      if (er)
        return er;
    }
    else
    {
      /* malloc failed, return an error */
      er = (_kernel_oserror *)"    Out of Memory";
    }
  }

  return er;
}


/************************************************************************/
/* ui_set_progess_percent                                               */
/*                                                                      */
/* Inputs:   flags - For future expansion/flexibility                   */
/*           percent - Percentage upgrade prpgress                      */
/* Outputs:  none                                                       */
/* Returns:  Pointer to an error block, or NULL if no error             */
/* Action:   Sets Upgrade screen progess bar and textual percentage     */
/*           representation to "percent" %                              */
/*                                                                      */
/************************************************************************/
_kernel_oserror *ui_set_progress_percent (unsigned int flags, int percent)
{
  char num[10];
  int num2;
  _kernel_oserror *er = NULL;

  IGNORE (flags);

  /* Set the progress bat chunks according to "percent" */

  if (percent == 100)
    er = ui_main_set_percent_chunk (100, 1);
  else
    er = ui_main_set_percent_chunk (100, 0);
  if (er)
    return er;

  for (num2 = 95; num2 >= 5; num2 -=5)
  {
    if (percent >= num2)
      er = ui_main_set_percent_chunk (num2, 1);
    else
      er = ui_main_set_percent_chunk (num2, 0);
    if (er)
      return er;
  };

  /* Set the textual progress percent */
  sprintf (num, "%d%%", percent);
  er = button_set_value (0, ui_Upgrade_WindowHandle, upgrade_percent, num);

  return er;
}


/************************************************************************/
/* ui_set_defaults                                                      */
/*                                                                      */
/* Inputs:   flags - For future expansion/flexibility                   */
/*           details - Pointer to a structure containing server access  */
/*                     details                                          */
/* Outputs:  none                                                       */
/* Returns:  Pointer to an error block, or NULL if no error             */
/* Action:   Read server access details from "details" and store them   */
/*           in a local structure                                       */
/*                                                                      */
/************************************************************************/
_kernel_oserror *ui_set_defaults (unsigned int flags, setup_details_t *details)
{
  IGNORE (flags);

  /* If we've got a pointer to setup details ...*/
  if (details != NULL)
  {
    /* ... copy them to a local structure */
    if (setup_details.phone.outside_line_prefix != NULL)
      free (setup_details.phone.outside_line_prefix);
    setup_details.phone.outside_line_prefix = strdup (details->phone.outside_line_prefix);

    if (setup_details.phone.call_waiting_prefix != NULL)
      free (setup_details.phone.call_waiting_prefix);
    setup_details.phone.call_waiting_prefix = strdup (details->phone.call_waiting_prefix);

    setup_details.phone.wait_for_dialtone_flag = details->phone.wait_for_dialtone_flag;
    setup_details.phone.country_code = details->phone.country_code;

    if (setup_details.isp.phone_number != NULL)
      free (setup_details.isp.phone_number);
    setup_details.isp.phone_number = strdup (details->isp.phone_number);

    if (setup_details.isp.username != NULL)
      free (setup_details.isp.username);
    setup_details.isp.username = strdup (details->isp.username);

    if (setup_details.isp.password != NULL)
      free (setup_details.isp.password);
    setup_details.isp.password = strdup (details->isp.password);

    if (setup_details.isp.dns != NULL)
      free (setup_details.isp.dns);
    setup_details.isp.dns = strdup (details->isp.dns);

    if (setup_details.isp.modem_script != NULL)
      free (setup_details.isp.modem_script);
    setup_details.isp.modem_script = strdup (details->isp.modem_script);

    if (setup_details.ftp.url != NULL)
      free (setup_details.ftp.url);
    setup_details.ftp.url = strdup (details->ftp.url);

    if (setup_details.ftp.username != NULL)
      free (setup_details.ftp.username);
    setup_details.ftp.username = strdup (details->ftp.username);

    if (setup_details.ftp.password != NULL)
      free (setup_details.ftp.password);
    setup_details.ftp.password = strdup (details->ftp.password);

    new_setup_details = 1;
  }
  /* else return an error */
  else
    return (_kernel_oserror *)"    No setup provided";

  return NULL;
}


/************************************************************************/
/* ui_initialise                                                        */
/*                                                                      */
/* Inputs:   flags - For future expansion/flexibility                   */
/*           callbacks - Pointer to a structure containing engine       */
/*                       callback function pointers                     */
/* Outputs:  none                                                       */
/* Returns:  Pointer to an error block, or NULL if no error             */
/* Action:   Initialise the UI component, set up internal state,        */
/*           display the Welcome screen.  Copy the function pointers    */
/*           into a local structure                                     */
/*                                                                      */
/************************************************************************/
_kernel_oserror *ui_initialise (unsigned int flags, engine_callbacks_t *callbacks)
{
  _kernel_oserror *er = NULL;

  if (flags & 1)
    ui_corruption_forced_upgrade = 1;
  else
    ui_corruption_forced_upgrade = 0;

  /* Initialise the UI component's local copy of the setup details */
  setup_details.isp.phone_number = setup_details.isp.username = setup_details.isp.password =
  setup_details.isp.dns = setup_details.isp.modem_script = setup_details.ftp.url =
  setup_details.ftp.username = setup_details.ftp.password =
  setup_details.phone.outside_line_prefix = setup_details.phone.call_waiting_prefix = NULL;

  /* If we have the callbacks block, copy them to the local structure */
  if (callbacks != NULL)
  {
    engine_callbacks.start_upgrade = callbacks->start_upgrade;
    engine_callbacks.user_abort = callbacks->user_abort;
    engine_callbacks.return_to_main_os = callbacks->return_to_main_os;
    engine_callbacks.encountered_error = callbacks->encountered_error;
    engine_callbacks.pause = callbacks->pause;
    engine_callbacks.resume = callbacks->resume;
    engine_callbacks.setup_started = callbacks->setup_started;
    engine_callbacks.error_action = callbacks->error_action;
  }
  else
  {
    /* Else return an error */
    return (_kernel_oserror *)"    No callback pointers provided";
  }

  /* Initialise ourselves with the event library. */
  er = event_initialise (&ui_event_id_block);
  if (er)
    return er;

  /* As we have set the object flags on our iconbar object to be auto-create and auto_show,
   * we are initially only interested in an auto create event when we receive this we can then
   * attach handlers for our window and menu.
   */
  er = event_register_toolbox_handler (-1, Toolbox_ObjectAutoCreated, ui_main_attach_handlers,
                                       NULL);
  if (er)
    return er;

  /* Register a default key handler
  er = event_register_wimp_handler (-1, Wimp_EKeyPressed, ui_main_default_key_handler, NULL);
  if (er)
    return er; */

  /* Register the button press handlers */
  er = event_register_toolbox_handler (-1, show_dialling_event, ui_main_navigation_handler,
                                       NULL);
  if (er)
    return er;
  er = event_register_toolbox_handler (-1, show_isp_event, ui_main_navigation_handler, NULL);
  if (er)
    return er;
  er = event_register_toolbox_handler (-1, show_ftp_event, ui_main_navigation_handler, NULL);
  if (er)
    return er;
  er = event_register_toolbox_handler (-1, show_done_event, ui_main_navigation_handler, NULL);
  if (er)
    return er;
  er = event_register_toolbox_handler (-1, start_upgrade_event, ui_main_navigation_handler,
                                       NULL);
  if (er)
    return er;

  /* Register the abort button press handler */
  er = event_register_toolbox_handler (-1, abort_event, ui_main_abort_handler, NULL);
  if (er)
    return er;

  /* We must register our Message handler for the Quit message. In this way we can be told to
   * quit by the task manager
   */
  er = event_register_message_handler (Wimp_MQuit, ui_main_message_control, NULL);
  if (er)
    return er;

  er = event_register_message_handler (Message_NCKeyboard_Closed,
                                       ui_main_keyboard_closed_handler, NULL);
  if (er)
    return er;

  /* Initialise the toolbox */
  er = toolbox_initialise (0, Wimp_Version, ui_wimp_messages, ui_toolbox_events,
                           ui_our_directory, &ui_message_block, &ui_event_id_block,
                           &ui_current_wimp, &ui_task_id, NULL);

   ui_main_keyboard (1u);

  return er;
}
