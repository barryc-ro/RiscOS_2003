//config.c
//reads the config file info into a struct
// created 3/10/00  nicke

#include "config.h"
#include <string.h>
#include <stdio.h>
#include <stdlib.h>


//find a config string via its token
//if token is found copy the corresponding string to 'copy'
char *find_string(char *buff,char *token,char *copy)
{
  char *pos;

  pos=strstr(buff,token); //find the token

  //if we got it
  if(pos)
  {
    //move to the end of the token
    pos+=strlen(token);
    //search through the white space for the start of the string
    while((*pos == ' ') | (*pos =='\t')) pos++;
    strcpy(copy,pos);
    strcpy(strpbrk(copy,"\n\r"),"\0");
    printf("%-15s %s\n",token,copy);
   }

  return pos;
}

//find a config word via its token
//and copy it to the relevent field
char *find_word(char *buff,char *token,int *copy)
{
  char *pos;

  pos=strstr(buff,token); //find the token

  //if we got it
  if(pos)
  {
    //move to the end of the token
    pos+=strlen(token);
    //search through the white space for the start of the string
    while((*pos == ' ') | (*pos =='\t')) pos++;
    *copy=atoi(pos);
    printf("%-15s %s",token,pos);
   }

  return pos;
}


int read_config_file(struct config *setup,char *path)
{
  FILE *fin;
  char buff[80];

  //open the config file
  fin = fopen(path,"r");

  if (fin==NULL)
   {
     printf("Cannot open the config file\n");
     return 1;
   }

   do
   {
     fgets(buff,80,fin);

     find_string(buff,"display:",setup->display_string);
     find_string(buff,"build:",setup->build);
     find_string(buff,"locale:",setup->locale);
     find_word(buff,"size:",&(setup->size));
     find_word(buff,"type:",&(setup->type));
     find_string(buff,"imagedir:",setup->image_dir);
     find_string(buff,"imagename:",setup->image_name);
     find_string(buff,"outdir:",setup->out_dir);
     find_string(buff,"outname:",setup->out_name);
     find_word(buff,"bank:",&(setup->bank));

   }
   while(!feof(fin));

   fclose(fin);

   return 0;
}
