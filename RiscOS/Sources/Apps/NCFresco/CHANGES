Fresco changes file. Please ensure your name and date are present for
each entry, and that a clear separator exists - I use 77 hyphens. The
most recent entries are at the HEAD of the file.

-----------------------------------------------------------------------------

16th December 1997: Simon

Last few months changes...

Fresco changes: brought configgui.c upto date with my changes. Added
two plugin messages to the message list. Added
frontend_view_ensure_visable_full().

Lots of NCFresco changes...

A bunch of changes to start implementing an SSL UI (for querying
unverified certificates etc.). Conditionally compiled on SSL_UI, not
used currently as it's not really complete or tested. Would work on
the same plans as the current password callbacks.

Added 'clever' URL guessing. Adds www/ftp prefix and tries suffixes
from Messages file. Made the auto-redial stuff cope with an error
occurring in redialling.

Made NAME code in form submission go through the usual URL escpaing
channels.

Removed most of the old encoding handling code (all new stuff on
different branch - coming later).

Took out a call to frontend_view_margins() in be_set_dimensions()
which is responsible for the strange business with graphics at the top
of some pages, eg microsoft.com.

Added a new 'imh' method to return OBJECT handle (which can either be
an image or plugin handle). This allows proper handling of resizing
OBJECTs.

Added a load of different default values in config.c for
NCFresco. Added new config types, string and number lists. Also a hook
function so that outside code can take special actions when reading
config files. NCFresco uses this so that repeated 'key:' lines add
keys to its mapping database.

Fiddled with images.c in various ways to try and tighten it up. New 
image_strdup() that doesn't allow image_memory_panic() to be called.
Removed the WEBIMAGE != 2 code.

Various plugin position related bugs fixed.

More remote debugging commands and help added. 

Some more (hopefully final) fixes to the ongoing <A NAME> fix. It has
to not leave me->aref set otherwise whole sections of documents get
linked. Solution was that the /A on an A NAME is *always* ignored and
a null word is pushed to hold the anchor. This changes the meaning
slightly but has no effect on its real behaviour within Fresco as only
the start point was ever looked at (I think).


HTTP: Some involved fixes to make SSL, proxies, unsized images and
servers that support Range but not keep-alive all work at the same
time. Basically the second connection didn't reauthenticate so no data
was ever received.

Took out an unexplained (pdh:bodge) as it caused server-push pages to go
bang.

Added nasty proxy-redirection code. Compiled out usually.

Added code to extend the input buffer to cope with headers > 256
bytes. Not extensively tested.

MEMLIB: Took out RISCOSLib dependencies by changing veneer calls to
_swix(). Split off some header stuff so that it could be included by
NCFresco.

WEBFTP: Various memory leak fixes..

-----------------------------------------------------------------------------

21st October 1997: Simon

Fixed bug in images.c. When fetching an image from the cache when
image_completed is called it calls fetch_next(). This could cause a
call to the formatter, which is bad because we are already in the
formatter. Fixed bya semaphore to stop fetch_next being called whilst
still in image_find.  Will monitor for side-effects. Note this never
affected Fresco because progressive rendering was disabled whilst
loading from cache.

-----------------------------------------------------------------------------

2nd October 1997: Simon

Fixed bug in objects_set_position. It wasn't checking
config_sound_background as it should have been.

-----------------------------------------------------------------------------

1st October 1997: Simon

Made badparam do the same as param.

(Tried these iodeas but they don't get through the tests...
Changed colspan_column_init_from_leftmost() so that it actually initialises
from the lower of the widths calculated from leftmost and rightmost. This
appears to fix the problem where the lower cells in the following table
wouldn't get evenly spread. All the space ended up in the last cell.

<TABLE><TR><TD COLSPAN=4>text<TR><TD>1<TD>2<TD>3<TD>4</TABLE>

Also changed normalise_percentages() so that if there are non-percent columns
and the percentage adds up to 100% it doesn't take any corrective action.)

-----------------------------------------------------------------------------

30th September 1997: Simon

Removed the bit that allows &32; as a character entity. It's wrong and
Netscape doesn't allow it. I don't know why I did it in the first place!

Moved drawing of table backgrounds into antweb_render_background. Now 
triggered by another object_redraw type. This stops animated gifs in colored
table cells from flickering.

Changed the comparison in the SI1_PCT code. It appeared to compare OS units
width pixels and column widths with table widths.

-----------------------------------------------------------------------------

26th September 1997: Simon

Change A defn in attrconf to remove the 'dont force close'. This prevents 
strange formatting screwups when missing /A in lists and table cells.

Made TOPMARGIN and LEFTMARGIN affect bottom and right as well.

-----------------------------------------------------------------------------

21st August 1997: Borris

Merged with Si's diffs. Maybe some confusion over the first line of
stdalone/Makefile.

-----------------------------------------------------------------------------

21st August 1997: Simon

Removed the code I put in to strip new lines after tags starts as it
message up some pages that use tags within PRE blocks. They are in the wrong
(I think) but under the circumstances it's easier to remove the code.

-----------------------------------------------------------------------------

19th August 1997: Simon

Added pdriver_command veneer to printing.c

-----------------------------------------------------------------------------

19th August 1997: Borris

More diffs from Si to make some configgui bits consistent. Sorted out
some ^Ms in some files.

-----------------------------------------------------------------------------

19th August 1997: Simon

Removed loads of entries from !Fresco/configgui.c for items that have
been conditionally compiled into config.c. Removed duplicate entries
from this file. Added new access function to get the file type on a
given access_handle so that backend can report a better error
message. That code really needs sorting out.... Made config_read_int
allow negative values. Added new config entries for a couple of
highlight things.  with corresponding updates in oinput/highlight.
New strlwr function in portutil.c. Fixed bug in stream_iterate_box().
Made url_parse() cope with '-url ' at the front to allow for bad NCFresco
setups. Had to strip various ^M's which probably cause some problems.

-----------------------------------------------------------------------------

14th August 1997: Borris

First merge with Si's code in a while. It is also back on the main
branch. The diff set was formed from DAF_970813 and Si manually
updating this tree from his version of the MBP1 branch, yielding diffs
to apply to DAF_970813 to yield this version, namely DAF_970819.

---------------------------------------------------------------------------

13th Aug 1997: Simon

Changes from a couple of months...

access.c: 

Added file locking (conditionally compiled) over the bits where the
file gets closed and opened. Made headers get freed immediately after
being used.  Changed the returning of errors for files that can't be
handled. Fix bug that meant last_modified time of file was overwritten
by cached file time.  Added open flag that means file must be found
(gives error if 404 or similar returned).

auth.c:   

Added function to optimise memory.

backend.c:

New flags for NCFresco special input types. Support for new textarea
code.  Put back code to send 'on' when no value given for RADIO. Fixed
problem in doc_image_change (shudder) with pages where there was
justone floating item (eg table). Support for file locking. Added
threaded flag use in backend_open_url(). Stops some possible bad
memory accesses on still-born documents.

cache3.c:

Support for locking files. Conditionalised filewatch support, new optimise 
function, not this requires new memlib.

config.c:

Relayed out the table. Reorganised the functions to take out some
duplication of code. Added new list items. Added support for a filter
so that the frontend can take actions when particular entries are
called. This allows NCFresco to use a duplicated config entry to
configure key maps and toolbars. STBWEB conditionalised loads of
items so Fresco won't save them and confuse people.

cookie.c: 

Added freeing cookie and optimising cookie functions.

format.c:

Added call to antweb_uncache_image_info() in autofit stuff so that
backgrounds get rescaled correctly and changed increment value.

highlight.c:

Beginnings of new highlight redraw code. Compiled out currently.

images.c: 

Changed fetching count to use a flag so that the count is always
correct, otherwise it could end up going negative. Changed a couple of
positions where the error flag was being set to call
oimage_set_error. Changed thread data transfer buffer from malloced to
being static. Fix server push and page reloading for osplotted JPEGs.
Tried to stop deferred/error icons from being scaled or used as
backdrops (not convinced I've caught all cases).

keyhl.c:

Support for new highlitgh redraw mechanism, and general pissing about
with the algorithm.

layout.c:

Support for configurable plinth colours.

loformat.c:

Fixed problem with half-width HR's. It was because of the scaffold
item at the start of table cells. Now skip this in the
align_adjustments function.

memwatch.c:

More fiddling with iterative panic stuff.

oimage.c:

Uses file leaf name as ALT text if nothing better around.

oinput.c:

Put in some missing ensure_fonts (on the ALT text) and new alt text
code. New configurable plinth code.

oobject.c:

Uses file leaf name and mime type as ALT text if nothing better around.

otext.c:

LABEL's now get highlight box if they are disconnected.

otextarea:

Complete rewrite (conditionally compiled though) to use a memzone for
storage and handle hard and soft wrapping.

plugin.c:

Some changes to the way that helpers are counted. More error checking.

portutil.c:

Handled items quoted with single quotes.

printing.c:

Changed debugging. Made it reformat if autofit had been in use.

rdebug.c:

Loads of useful remote functions for NC use.

render.c:

New rendering function for configurable plinths.

rid.c:

New textarea support. Separate out function to add a scaffold item.

stream.c:

New stream_iterate_box function tries to cut down on the time it takes
to get the bounding boxes of a numebr of connected items. Probably
could be made more efficient by someone who actually understands how
floating images and margins actually work...

url.c:

Counted versions of the escaping functions for handling non-null
terminated strings (for new textarea code).

util.c:

New function to get the file type name out of the mime map file. New
functions to optimise a block of memory and get free memory size.

webfonts.c: 

Fixed double leading problem. Unknown font lookup now returns -1.

builders.c:

New textarea support.

deliver.c:

New textarea support. defined out the SELECT handling code as it is
never called. Took out all the previously defined out code for tab
expansion. Stopped EOL and EOS from being delivered in STR mode with a
TEXTAREA as that meant lines of text in the textarea caused lines
outside it on the page.

forms.c:

Support for more nasty NCFressco attributes. Strip control characters
and newlines properly from OPTION text.

head.c:

Strip control characters from TITLE text.

lists.c:   

Fixed bug where we looked at UL rather than LI attributes and LI TYPE
didn't work.

objparse.c:

EMBED HIDDEN attribute forces zero size (later forced upto 1).

special.c: 

Only use first occurence of each BODY attribute. Make 'A' clear any
FONT COLOUR set. Push scaffold after NOBR to stop the next item
sticking to it. Removed BADWBR.


enities.c: 

Added new option to sgml_translation to convert control chars to
spaces, now used in OPTION and TITLE code.

http.c:

CSFS changes for using POST.

chopper.c:

Removed Peter's change that translated tab to space as I think it's
handled better by the new option to sgml_translate.

elements.c

New option to sgml_translate to convert control characters to spaces. Code to
set the strip_initial newline flags.

support.c:

Moved tab_expanded_string into here. Extended push_inhand to not push
a newline and carriage return immedately after an start tag. This is
apparently correct SGML. We should also strip any newline immediately
before end tag but can't work out where to set and clear this flag.

-----------------------------------------------------------------------------

13 Aug 1997: Borris

Minor #ifndef BUILDERS in backend.c

-----------------------------------------------------------------------------

23th July 1997: Peter

Send referer on adjust-click. Add ^S = view source. 1.63 to Dean.

-----------------------------------------------------------------------------

18th July 1997: Borris

Implemented NOWRAP in table cells again!

-----------------------------------------------------------------------------

18th July 1997: Peter

Make web publishing able to use a separate file for its data. This is
known as "not a Sun bugfix" (see 10th July). New PNG DLL from Nick. Add,
with relief, Si's fix for server push problems. Add Page->View source.
Add Display->Stop animations. 1.62 to Dean.

-----------------------------------------------------------------------------

17th July 1997: Peter

Bodge unbreakable_sequence_fits horribly so that DL COMPACT works
again.

-----------------------------------------------------------------------------

15th July 1997: Peter

Reverse a modification to the excess_margin_due_to_floaters stuff
which was getting it wrong with <blockquote><img align=right>foo
foo foo</blockquote> -- as seen on CNN. Made Fresco better at
adding trailing slashes to, e.g. http://www.ant.co.uk (makes Web
publishing more sensible).

New build variant FRESCO_FILEONLY (ffo) with its own objects
directory and symlink to ../fresco/Makefile.

-----------------------------------------------------------------------------

14th July 1997: Peter

Increased version to 1.62. Allow different web publishing domains
to have different index pages. Fix httpmod to allow
"content-type: thing; charset=foo".

-----------------------------------------------------------------------------

11th July 1997: Peter

Translate tabs to spaces in STR mode (affects OPTION and TITLE). Fix
(in sgml_translate) bug whereby the trailing ; was being left on &#163;'s
in TITLEs. 1.61 beta to Dean, became external beta.

-----------------------------------------------------------------------------

10th July 1997: Borris

Tracked down bug exhibited by tabtests/misc59.html, whereby <DL> got
closed later in the <TD> list than other <TD>s, leading to the TD rule
not being applied if DL was also open. Fixed this by getting the TD/TH
rules in the correct order. Generated tabtests/misc60.html, which
illustrates a far more difficult version of the same problem. Made
ensure_pre_requisites iterate over the ruleset until none of the rules
are applied to fix this. Tried hard (twice!) to ensure that this
iteration cannot be indefinite. No examples that show this spinning,
but put a more certain scheme in place as well.

Improved table contradiction splatting to cover <COL> and <COLGROUP>
splatting - the lack of this was leading to some contradiction
assertion failures.

Bit of tinkering to get plotcheck to be useful when not compiled as a
development version.

-----------------------------------------------------------------------------

8th July 1997: Borris

Changed way heights work with table cells to make them more useful
(see tabtests/misc_valign2.html for example that triggered this).

-----------------------------------------------------------------------------

10th July 1997: Peter

New sprite DLL (and webimage stubs) from Nick fixes type-2-ing with
New Sprites on Old Machines. Allowed config lines to be 512 bytes, not
256, 'cos Dean's config_publishing was too long (this is what's known
as "a Sun bugfix"). Disabled print button for framesets.

Fix to <img align=top> stuff. Web publishing UI. F1 for online help
(just the release notes so far). Shove colours into display dbox. New
"Network settings" dbox.

-----------------------------------------------------------------------------

8th July 1997: Peter

Give error properly if save file fails to open (bug had always been
there AFAICS). Fix problem whereby Fresco would occasionally give up
displaying an image and display its filetype icon instead (overzealous
test for error condition in image_stream_end). Fold in new PNG DLL
from Nick and new webimage stubs with Cv5 stack extension symbols.

Make "No images" have immediate effect (no new fetches are started, it
doesn't abort existing ones) via new backend_defer_images() and
image_defer() routines.

Sort out <img align=top>. Complete set of new DLLs from Nick all
compiled with Cv5 now.

-----------------------------------------------------------------------------

7th July 1997: Peter

Fix bug with actionless forms. Aborting of framed documents was a bit
wrecked too. Saveas box didn't accept Return, Escape.

-----------------------------------------------------------------------------

4th July 1997: Peter

Separate transfer dbox things into transfer.c. Add transfer dboxes to
OLE operations. Add config_image_blacklist. Make __ASSERT raise a
signal in production builds if in a "guarded" situation.

Ponderable: should we be compiling asserts out of production code
altogether, as is done for NCFresco?

-----------------------------------------------------------------------------

3rd July 1997: Peter

Fix non-square pixel sprites again (I'd broken it when fixing
kortinkised GIFs). Fix image_thread_end to cope with NULL argument
(caused type-5's in low memory situations). Version 1.59 to Dean.

Put code in backend.c to catch type-5's and convert them to
errors. Under these situations, memfatal raises SIGUSR1 rather than
calling exit(). This code is not compiled into NCFresco as when an
error occurs it leaks memory (file handles, window handles, whatever)
very freely. (It's meant for desktop blokeys to be able to do
something to save their URLs before restarting Fresco). It's only
compiled into PRODUCTION builds, too. Version 1.60 to Dean. Full
punter release -- scary!

Inc version to 1.61.

-----------------------------------------------------------------------------

1st July 1997: Borris

Fixed NULL bugs in Peter's undocumented conditional tables code :-(
Fixed problem illustrated by tabtests/misc_sport.html (subset in
tabtests/misc56.html). Fixed problem illustrated by tabtests/misc57.html.

-----------------------------------------------------------------------------

1st July 1997: Peter

Sort out very nasty savedoc.c bug. Built release notes
!Fresco.Docs.news/html. 1.57 beta to Dean. Sort out kortinkised
GIFs once and for all (required small Gif DLL modification).
Netscape (and now Fresco) behave differently for GIF87 and GIF89!
Trapdoor so pre-1.57s have display.frames and broken.formpost
switched on automatically. Bump version to 1.58.

Some new build targets FRESCO_REL (frel) and FRESCO_MC (fmc) with
their own object directories (getting tired of recompiling).
These directories have symlinks to ../fresco/Makefile, so changes
will happen to all of them.

-----------------------------------------------------------------------------

30th June 1997: Peter

Link->Add to hotlist. fe_gui_OPEN_PARENT. Fix OLE-ing so it runs
servers properly.

-----------------------------------------------------------------------------

26th June 1997: Peter

Margin fix in loformat.c for when stream starts with scaffs and
floaters. Fix WebFTP to return status_FAIL_PASSWORD when it's
needed. "Link->" menu in desktop Fresco.

-----------------------------------------------------------------------------

24th June 1997: Peter

Way groovy Web publishing in desktop Fresco. New access_UPLOAD
flag to access_url(), but this won't affect NCFresco if it
doesn't use it.

Wimp messages! The &4AF80 block belongs to ANT, and &4AF84
(message_NCFRESCO) was notionally being used by HotList. However
it wasn't actually being sent by anything, so the resolution has
been to change HotList to use &4AF87. In future it seems best to
standardise that Dean is the Keeper of the Block.

-----------------------------------------------------------------------------

30th June 1997: Borris

Start of profiling support.

Merger of main branch and MBP1. I wonder whether merging actually
works across branches, given some of the conflicts that occurred on
some !NCFresco bits. Such places made #if conditional with a suitable
comment for now.

CAUTION: There is a lurking bug somewhere - plotcheck without any
debugging options whatsoever on tabtests/colspan*.html goes boom on
colspan15.html. NOT ADDRESSED FOR NOW. Maybe someone wants to play
with heap libraries?

-----------------------------------------------------------------------------

27th June 1997: Borris

attrconf edit: Introduced artificial tag ARTBODY to provide a
reference point for rules - ie what BODY was originally meant to do.
BODY is now just doing the attribute side of the original BODY
behaviour. This fixes tabtests/missing9.html. 970628: Gave <BODY> flag
text, although ideally it should not need it. "X<html>X<html>" wants
it though! Went back and finished the implication chasing :-(

Width of an item only has 15 bits available to it - introduce
constraint nuking to deal with hitting 0x7fff. More applicable to the
testing code than real life (hopefully!) as the HTML generators have
no idea what common sense is. Also fixed some damned subtle bugs in
ABSMAX calculation.

Not passes the entire contents of tabtest/* without a complaint detected!

-----------------------------------------------------------------------------

26th June 1997: Borris

Grungy hack to make http://www.zylab.com/ display when there are not
sufficient pixels available, as per 24th June notes below. Solves the
particular page, but breaks many otthers, eg CNN.

Made <A> not a nesting element if there is no HREF attribute present.

Fixed bug whereby a table with percentages that had minwidth > fwidth
tended not to get the expected values. This might be the behaviour
that Si reported as being broken a couple of weeks ago. Condtional in
the end of colspan.c.

GBF_SI1_PCT: Triggered by comparing the width a cell expects to be
when considering its minwidth, versus the width the cell expects to be
if we used fwidth (actually, hardwired as SI1_PCT_WIDTH at
present). If the minwidth value is larger, the percentage constraint
on that column is removed. Likewise, any non-percent columns are
compared, using their summed minwidths and 100 - SUM(percentages). If
the minwidth distance exceeds the magic distance, then all percentage
constraints are removed.

The reasoning behind having the fixed width is to avoid excessive
overheads. Normally, sizes are observed in one recursion pass and then
allocated in a precise, definitive fashion on another recursion
pass. Unfortunately, it is only after this second pass that we can
start choosing a real fwidth value (true - it could be done during the
downward recursion, but some other complexities need analysing before
that can happen safely). If we trigger the removal of a percentage, we
really need to start again. This repeating triggered from recursion is
what leads to excessive overheads.

Thus, this will get the wrong answer more and more as the depth of
table nesting increases. A compromise might be to lower the magic
value to about 80% or 90% of the top level fwidth.

-----------------------------------------------------------------------------

24th June 1997: Borris

Some more test files.

Merge between main branch and MBP1.

COMMENT: The quantity of #ifndef STBWEB and #ifndef FRESCO is rapdily
giving us two quite different programs. Can we try and distinguish
between behaviour that really is only appropriate for one version or
the other, versus experimental changes that might well be applicable
to both versions please.

Fixed minor BUILDERS build problem, as per Si's email.

Create GBF_MINWIDTH_A and GBF_MINWIDTH_B. _B is what Fresco used to
do, and is the behaviour retained by Fresco. _A is complex:

1) Maintain max(LM), max(CW), max(RM), with width being these summed
at the end of the pass. The bumps widest greater than fwidth for Si's
typical problem page.

2) When deciding whether an unbreakable sequence (ie non-floating
item) will fit, ignore the floaters - that is, if there is no
non-floating item yet, the ubs will always fit, whether floaters or
not. This handles <IMG ALIGN=LEFT><TABLE OR IMG> cases - ie floater
and non-floater. It will make some lines longer than might be
desirable for fwidth versus widest restraining, but probably not too
unpleasantly as the really wide objects tend to be images anyway, and
these tend to be designed for menu panels.

3) Almost independent of the other changes, when widest is bigger than
fwidth, and we are dealing with positioning floating items, we use
widest as the limit, not fwidth. This does <IMG ALIGN=LEFT><IMG
ALIGN=LEFT> for Si's typical problem page.

This is highly experimental! It might actually look quite nice though!

-----------------------------------------------------------------------------

23rd June 1997: Peter

New version of the wimp_MCACHEDURL protocol. Fixed mailto: bug.
More fiddling with webtool saves. Different status messages for
"Receiving data" and "Loading file". This affects NCFresco:
there's a new reason code for frontend_view_status().

-----------------------------------------------------------------------------

20th June 1997: Peter

Added support for wimp_MCACHEDURL (see gi/~peter/info/Cache.txt).
Different messages for loading vs fetching pages. Beta release
1.53 to Dean. Fix all save boxes so they use DragASprite. Webtool
saves.

-----------------------------------------------------------------------------

20th June 1997: Borris

Merged MBP1 branch into main branch, so main branch has changes from Si.

Same again with most recent diffs from Si. Fixes the <BR> problem
Peter had encountered.

Made any cell with a percentage width > 99 behave as if no width
specified.

Bumped version to 1.53

-----------------------------------------------------------------------------

20th June 1997: Borris

Merged changes with Si. Still on MBP1 branch.

-----------------------------------------------------------------------------

19th June 1997: Simon

Changed WBR handling. It's now half right - it works within NOBR but
not outside. If we ever get newlines/spaces fully sorted I'm sure we
can make it all work at the same time.

Changed two uses of stream to curstream in break pushing in builders.c. This
accounted for why P didn't work with UNEXPECTED_TABLES enabled.

Fixed a couple of ALT text bugs. CNN doesn't say dot now!

Made guessing code try a distance of 1 before 2 to get a better match. I'm
not sure whether we are spending too much time trying to match now.

-----------------------------------------------------------------------------

18th June 1997: Borris

CVS branch split to seperate NCFresco stablish version from main
development branch. This change is being entered at the start of the
new MBP1 (Major Branch Point number 1).

And now merged in some diffs from Si as well.

Pulled over the new gbf.[ch] stuff from the main branch.

-----------------------------------------------------------------------------

24th June 1997: Borris

Merge diffs from Si into MBP1 branch.

-----------------------------------------------------------------------------

19th June 1997: Borris

Merged changes from Si. Still not balanced against main branch at this
point.

-----------------------------------------------------------------------------

18th June 1997: Simon

Made TEXTAREA's sensitive the scale_value. Moved resetting of scale value
to various places in backend.c to stop it continually forcing a screen redraw
for every partial format.

Split off the parse and format bit of antweb_doc_progress and call around
the parse closedown. This should fix pages not displaying due to
GBF_UNEXPECTED_TABLES, comment backtracking and the missing last words of
some screens.

Small change to comment handling, STBWEB only at the moment, whitespace after
the <! means it is treated as some_sgml_command rather than a comment, so
that it is terminated by a >.

Changed render_plot_icon to use colourtrans as we've got some 256 colour
icons now.

-----------------------------------------------------------------------------

18th June 1997: Borris

CVS branch split to seperate NCFresco stablish version from main
development branch. This change is being entered at the start of the
new MBP1 (Major Branch Point number 1).

And now merged in some diffs from Si as well.

Pulled over the new gbf.[ch] stuff from the main branch.

-----------------------------------------------------------------------------

30th June 1997: Borris

Merged changes from Si without winge. cvs -q update only showed Ms.

-----------------------------------------------------------------------------

27th June 1997: Simon

Added hgap, vgap fields to rid_text_item_image which are scaled border
+ h|vspace in OS units.

Ignore rowspan=0 and colspan=0 (again?) as NS and IE don't seem to
understand them btu people use them.

-----------------------------------------------------------------------------

26th June 1997: Simon

Some small changes to images.c. Always calls image_thread_end() in
image_completed() rather than just when thread is already dead. memory
panicing for ncfresco now marks the image as errored so frontend knows it
actually finished.

Reset scale_value before document formats in printing.c. Dumped in new
format code from Borris. Then disabled it :-( Fiddled a bit with the
framesto tables code in layout.c

-----------------------------------------------------------------------------

24th June 1997: Simon

Fixed problem with printing to postscript in declare fonts.
Stopped LINK from making the whole page an active link.

Made another small change to comment handling to disable the proper
handling of SGML comments (for NCFresco).

New ensure_visable call that takes all four coords. Fixed up !Fresco version
as well (unchecked but it's only called from backend_highlight_link).

-----------------------------------------------------------------------------

23rd June 1997: Simon

Call antweb_image_uncache_info() when doc scale changes so that bg's and
animation caches are handled correctly.

-----------------------------------------------------------------------------

20th June 1997: Simon

Added my special fonts to config. Merged in most of the main branch changes.

Changed expiry check in cache.c to <= rather than <. This makes it pass the
openmarket.com test on an NC when the date isn't set (and I guess makes
it obey the HTTP/1.0 spec as well..

Minor change to antweb_doc_image_change(). backend_doc_image_change() is
called before returning for general case otherwise the code doesn't notice
the fvpr'ing of the last imags and the page doesn't get redrawn.

Embeds now display the name of the file type or mime type if no
standby text is found.

-----------------------------------------------------------------------------

20th June 1997: Borris

Merged MBP1 branch into main branch, so main branch has changes from Si.

-----------------------------------------------------------------------------

19th June 1997: Dave

Problem with FORM as a container inhibiting the close of items across
it has been fixed by giving FORM the flag FLAG_FULL_UNWIND which is
now respected by open_within_container.

I have also reversed Si's mods of 20/5/97 which I believe are
misguided. The bug that induced this change has been fixed by giving
CENTER the flag FLAG_DONT_FORCE_CLOSE which properly prevents the item
being closed by the implied close.

-----------------------------------------------------------------------------

18th June 1997: borris

<td colspan=0 rowspan=0> causes rowspan and colspan on that cell to be
ignored. This is a strange degenerate case with very poorly defined
behaviour - indeed, it is very debtable whether a cell can ever be
added anywhere within a table after such a infinite spanning
specification. IF this gives problems, we can backtrack and think
further.

Fixed curstream preservation. Mainly due to lack of preservation in
caption closure. Now passes ALL the tests under bin/ordered

Tidied up gbf.[ch] a bit - compile time optimisations happen only for
Fresco during a PRODUCTION build.

-----------------------------------------------------------------------------

17th June 1997: Peter

Fiddle with share_raw_abs_pct (colspan.c) to make colspans with
wide contents affect sharing properly. Some unused functions
removed. Make gbf_active a compile-time constant (on desktop
Fresco only). Sort out fe_gui_* stuff in desktop Fresco.

-----------------------------------------------------------------------------

19th June 1997: Borris

Merged changes from Si. Still not balanced against main branch at this
point.

-----------------------------------------------------------------------------

18th June 1997: Simon

Made TEXTAREA's sensitive the scale_value. Moved resetting of scale value
to various places in backend.c to stop it continually forcing a screen redraw
for every partial format.

Split off the parse and format bit of antweb_doc_progress and call around
the parse closedown. This should fix pages not displaying due to
GBF_UNEXPECTED_TABLES, comment backtracking and the missing last words of
some screens.

Small change to comment handling, STBWEB only at the moment, whitespace after
the <! means it is treated as some_sgml_command rather than a comment, so
that it is terminated by a >.

Changed render_plot_icon to use colourtrans as we've got some 256 colour
icons now.

-----------------------------------------------------------------------------

18th June 1997: Borris

CVS branch split to seperate NCFresco stablish version from main
development branch. This change is being entered at the start of the
new MBP1 (Major Branch Point number 1).

And now merged in some diffs from Si as well.

Pulled over the new gbf.[ch] stuff from the main branch.

-----------------------------------------------------------------------------

17th June 1997: Borris

Looked at widest > fwidth again.

Grungy hack in tables percentage code, based upon rid_tf_SI1_PCT being
set. Basically, The problem is that the combination of minwidth and a
percentage constraint together can imply a very large table. As a real
hack, the implied cell size using minwidth is compared against the
implied cell size when ignoring minwidth but considering some hardware
window width (600 pixels for NCFresco for example). If the minwidth
based value is larger, then rid_cf_NOCONS is applied to the constraint
and the cell forced to always format to minwidth. This is a
non-scaling artifact and will probably be wrong for some example
tables. GBF_SI1_PCT controls this hack. It is probably not wanted for
standard Fresco - pending completion.

Investigated Si's comment problem. The delivery of the inhand,
uncertain comment happens after the formatting of the document takes
place. This is wrong. Due to lack of pipeline handling between
antweb_doc_progress() and antweb_doc_complete(). Still pending fix.

Dodgy colspan>1 width distribution problem - pending completion.

<TABLE><TR><TABLE> problems. Fixed 18/8/97.

-----------------------------------------------------------------------------

16th June 1997: Simon

Fixed FONT COLOR which I'd broken totally.

-----------------------------------------------------------------------------

12th June 1997: Peter

OLE support in desktop Fresco (press Ctrl-E). NCFresco not affected.

-----------------------------------------------------------------------------

11th June 1997: Peter

Fix width="700 pixels" (was giving it 700 picas). Small frob in
frontend.c so non-debug version compiles.

-----------------------------------------------------------------------------

11th June 1997: Simon

Check config_sound_background before starting zero-size plugins. Made
cookies work correctly again by allowing multiple set-cookie headers.

Conditional HTTP feature which handles POST like Netscape (always add
on a CRLF but have the content-length not reflect this). Not enabled
as it didn't fix the problem I was seeing.

Changed mailto proxy stuff to be able to use system variable.

-----------------------------------------------------------------------------

10th June 1997: Simon

Work around for OS JPEG bug. Rendering 1x4 image with full dithering
(flags=3) crashes.

-----------------------------------------------------------------------------

11th June 1997: Borris

Altered close_down_current_line in loformat.c so that it frees the pos
items "behind it" to minimise the transient memory overheads,
especially for when performing the minwidth sizing. NULLed the line
pointers in rid_pos_items has rid_scanfr() was tripping up over
non-NULL but freed pointer values during the sizing passes - the
formatting pass that alwatys follows the sizing passe ensures that
sanity reigns in the long run.

-----------------------------------------------------------------------------

10th June 1997: Peter

Small frob in backend.c stops type-5 when image_change occurs on
a stream containing only floaters.

-----------------------------------------------------------------------------

10th June 1997: Borris

Merged changes from Si. Spotted place where scaling was not being
applied correctly and fixed. fwidth < widest changes. TD/TH close any
active list, at Peter's request. Percentage bug fix.

-----------------------------------------------------------------------------

9th June 1997: Simon

Added check on pending_close to loop in sgml_pre_word_chopper(). Might sort
out those whopping text documents.
Removed windowtarget stuff from access.c - now ends up in the META tags.
attrconf change. FORM items and LABEL now close any open A (and vice versa
for A and LABEL).

-----------------------------------------------------------------------------

9th June 1997: Simon

Tiled backgrounds were being scaled twice, when cached and plotted which made
a real mess of their pages (backgrounds not being redrawn at all).
Put mmfopen() to work after Borris spotted the problem.
Stopped scaled tile image dimensions becoming < 1 pixel.

Added code to hparse.c and sgmlparser.h to allow the parser close
action to be called from within the parser data action and thus to abort
a parse mid-way. Untested as yet...

-----------------------------------------------------------------------------

9th June 1997: Peter

Sort out valign. This was going wrong because cell->stream.height
was being set to the size of the cell; I've stopped this, the
value is always available in cell->size.y if anything needs to
use it. Fix memory leak in colspan.c.

-----------------------------------------------------------------------------

9th June 1997: Borris

Merged changes from Si. Crude hack on the mmfopen stuff. Crap error
handling (ie lack of) when the Messages file is not there. Bit more on
autofit. Upped version to 1.51

-----------------------------------------------------------------------------

6th June 1997: Simon

Moved low memory deferring of images out of images.c and into oimage and
backend (and got sense right way around). Added a postmortem facility to
Fresco. Added frontend_memory_panic(). Added fopen wrappers in util.c (not
in use yet as there seemed to be a problem).

-----------------------------------------------------------------------------

8th June 1997: Borris

Much work with the test cases. Apart from the missing HTML examples,
which demonstrate parser problems, all test cases now
pass. tabtest/boom1027.html has been moved to tabtests/bigmem1.html as
it requires a large amount (117MB) of memory for the final stages -
this example is NOT a plausible example, but is one that has
previously tripped up the tables code. Committing to retain this
working state.

-----------------------------------------------------------------------------

6th June 1997: Peter

Made allocate_table_width work with current text_item margins
(i.e. margins due to blockquotes and stuff, ignoring floaters)
rather than total stream width. misc_traffic.html works now.

-----------------------------------------------------------------------------

5th June 1997: Simon

Upped HTTP module version number to bring it in line with NC build.
Yet more auto snuffing. otextarea_size(), access_url() [in many places],
fe_open_info(). Fixed bug in strtrim(). Another array removed in dir2html().

New define ITERATIVE_PANIC. Tries to free memory bit by bit rather than
dumping it all in one go. Also has a stash of emergency memory. Also new
gbf for when in low memory situation. No new images will be fetched when in
low memory.

Made auth_read_allow_file() close its file (v. longstanding bug I think!)

-----------------------------------------------------------------------------

5th June 1997: Peter

<br clear=left|right|both>; better floater formatting; fix
redrawing of floaters after the first; fix floater/indent
interaction. New files event2.[ch] not used by NCFresco.

-----------------------------------------------------------------------------

4th June 1997: Peter

Drag on background (Fresco) scrolls in right direction. format.c
forces redraw if scale factor changes. httpmod gets it right if
server-push includes content-lengths, even if there're spaces at
the beginnings of headers <grrrr>

-----------------------------------------------------------------------------

5th June 1997: Borris

Merged changes from Si. Added rdebug.o to PLOTCHECK_OBJECTS.

-----------------------------------------------------------------------------

4th June 1997: Simon

Remove more auto arrays from pseudo_html(), pparse_gopher_out_line(),
parse_some_file(), access_copy_data(), url_join(), url_path_trans(),
url_escape_chars(), be_pparse_doc(), dir2html().

-----------------------------------------------------------------------------

4th June 1997: Borris

Guess what - merged changes from Si!

-----------------------------------------------------------------------------

3rd June 1997: Simon

Split off deferred images in frontend_view_status() call. Fixed up
statusbar.c to give the same values as before. Fixed couple of
problems when running out of memory getting animations. Converted some
large auto arrays in images.c into mm_malloc's.

-----------------------------------------------------------------------------

3rd June 1997: Borris

Merged changes from Si (BTW, my changes not yet stable so not folded
back in yet).

-----------------------------------------------------------------------------

2nd June 1997: Borris

Merged changes from Si

-----------------------------------------------------------------------------

30th May 1997: Borris

Merged changes from Si

-----------------------------------------------------------------------------

29th May 1997: Simon

Changed debug.c to be able to use the remote debugging library.

-----------------------------------------------------------------------------

29th May 1997: Peter

Fix in images.c to use logical screen descriptor for GIFs. Change
colspan.c to clip user table widths if GBF_AUTOFIT is active. (It
only happened automatically for user cell widths.)

-----------------------------------------------------------------------------

28th May 1997: Peter

Fix http module not to give "host already being accessed" so
much. GBF_AUTOFIT for image sizes. Also <pre>. (GBF_AUTOFIT for
table sizes seems to happen automatically with the New Tables
Code.) Change attribute and enumeration guessing to go for edit
distance <= 2 (much less OOC).

-----------------------------------------------------------------------------

28th May 1997: Borris

Merged changes from Si.

-----------------------------------------------------------------------------

27th May 1997: Simon.

Fixed bug with greyXX in colours.c. Put flag block back on CENTER in
attrconf. Put extra bit in image_find() so that the number of images being
fetched is still limited (roughly) by images.max. This prevents totally
excessive transient memory usage from opening all the images at once.

-----------------------------------------------------------------------------

27th May 1997: Borris

Merged changes from si. Bugfix for tabtests/boom12.html.

-----------------------------------------------------------------------------

23rd May 1997: Simon

Altered parse_then_perform_element_open() slightly. find_attribute()
now returns whether it had to guess the attribute. A record of all
guessed names is kept and so if we guess an attribute then get the
real one we will use the real one and discard the guess.

Fixed case where text in inputs and txetareas takes on foreground colour
of page rather than black.

Changed CENTER from block element to close out of order element (ie
like I,B etc.). Although HTML3.2 suggests treating CENTER the same as
DIV, in practise it tends to be badly nested and mixed up like the rest of
the style things.

-----------------------------------------------------------------------------

23rd May 1997: Borris

Merged (very small) changes from Si.

-----------------------------------------------------------------------------

23rd May 1997: Peter

Change stream.c to cope with >1 floater per side. Fix
scaffold_check in loformat.c. Fix some more wibbly floater bugs.
Check out www/~peter/test/ for a fairly thorough collection of
cases.

-----------------------------------------------------------------------------

21st May 1997: Peter

Plug some memory leaks in new formatter.

-----------------------------------------------------------------------------

23rd May 1997: Simon

Added the authentication status codes to the checks in
http_fetch_alarm. This stops parts of authentication pages appearing
in main pages.

-----------------------------------------------------------------------------

22nd May 1997: Borris

Merged changes from Si. Fixed bug whereby stream->widest was not
overriding stream->fwidth at the top level. Merged a second batch of
changes to get a tag point to submit diffs against for this bug fix.
Fixed a bug in this. Tweaked rectplot.c to get tests correct on right
floating table that didn't require all of fwidth. Fixed a table width
bug. Fixed bug in right aligned text.

-----------------------------------------------------------------------------

20th May 1997: Peter

Fix %ages bug in layout.c. Fix (?) httpmod bug with apache 1.2b7.

-----------------------------------------------------------------------------

19th May 1997: Peter

Rewrite !Fresco/savedoc.c so as not to use dbox_fillin. Now works
even when the main window's work area button type is click/drag
(sigh).

-----------------------------------------------------------------------------

16th May 1997: Peter

Font stuff; now doesn't hold 72 font handles open all the time!
You can also now set a different font for headings as opposed to
body text. Any fonts not found are still reported on startup or
when clicking OK in the choices dbox. We assume that if you can
find a font in one size you can find it in any. **May need some
looking at for Far East fonts.

-----------------------------------------------------------------------------

21st May 1997: Borris

Merged changes from Si.

-----------------------------------------------------------------------------

19th May 1997: Borris

Floating items can have breaks forced if they are a table or a %age
specified item. stdunit parsing clips at 100% now - see
parser/attrparse.c if you want to change. The only reason you might
want to do this is so that a table or image at the outermost level can
have a width greater than 100%. Either the clipping goes in parsing
stdunits or each individual place that uses them.

-----------------------------------------------------------------------------

18th May 1997: Borris

Lots of minor floating item bug fixes.

-----------------------------------------------------------------------------

20th May 1997: Borris

Merged changes from Si.

-----------------------------------------------------------------------------

16th May 1997: Peter

Frames fixes. Now gets it right in "cols=1000,2000" type cases,
for instance www.durex.com, which Dean was having size problems
with. Clicked links now turn visited-colour immediately. Changes
in stream.c to allow for the fact that pos->left_margin includes
the left floater width now. Right margins in loformat.c; also
stopped left margins counting twice in some calculations.

-----------------------------------------------------------------------------

14th May 1997: Peter

Small bugfix in resolve.c which is too embarrassing to mention;
suffice it to say that Fresco is much happier with IP addresses
with 8's in now.

-----------------------------------------------------------------------------

12th May 1997: Peter

Fix RiscOSLib misdesign: make event_menu_proc's deal with MENU_HIT_TYPE
so we can #define that to int (which it should have been) rather than
char. This fixes selects with >256 entries, like those at SNCF.

Frames fixes.

-----------------------------------------------------------------------------

12th May 1997: Peter

More frames stuff in desktop Fresco incl. resizing. Some routines
moved from NCFresco/stbfe.c into commonsrc/frameutils.c and
renamed to match e.g. fe_find_top -> frameutils_find_top. I've
checked NCFresco still compiles, and nothing it calls should have
changed.

-----------------------------------------------------------------------------

8th May 1997: Peter

fvpr bugfixes especially in the floating images case. Added some
more test cases in tabtests for Borris to fix :-)

-----------------------------------------------------------------------------

9th May 1997: Borris

Merged changes from Si. Fixed bug in bug fix in colspan code for RL
pass (off by one!). PCP's comment: honour is satisfied!

-----------------------------------------------------------------------------

7th May 1997: Borris

Merged changes from Si. More tweaking on MAXINT. Improved sizing code
a bit - should be doing a lot less work now (there was multiple, and
hence redundant, sizing calls being made). Fixed all the existing test
cases. Generated more tests cases and fixed them. Generated some
random tables: 2 cause assertion failure and 2 spin forever. Fixed
some of them - and came across yet more nasty cases! Commiting at a
vaguely stable point.

-----------------------------------------------------------------------------

7th May 1997: Peter

Change FVPR so that images with explicit width and height don't stop it.

Frames support in desktop Fresco (compiles with -DFRAMES=1 or -DFRAMES=0,
NCFresco should be compiled with -DFRAMES=1). Not quite all there yet
(doesn't let you resize frames).

<img src=internal-gopher-xxx>. Small fix for <input type=image> with no
name.

-----------------------------------------------------------------------------

1st May 1997: Borris

Vote today!

Made images never smaller than 1x1. Floating item formatter. Couple of
bug fixes.

-----------------------------------------------------------------------------

29th April 1997: Borris

Start of floating image changes. More robust code. Various bugs
fixed. More example pages.

Merged diffs from Si in. Including %age sizing for images, objects, etc.

-----------------------------------------------------------------------------

28th April 1997: Borris


Tables more robust. Various other lesser changes. tabtests/width4.html
demonstrates a real bastard colspan case.

-----------------------------------------------------------------------------

27th April 1997: Borris

Changes for tables and formatting and floating images. More test
pages, of course. And, of course, they easily demonstrate bugs in
Netscape!

<TABLE HEIGHT=N>

-----------------------------------------------------------------------------

26th April 1997: Peter

Put FVPR stuff back to work again.

-----------------------------------------------------------------------------

25th April 1997: Peter

Fix in access.c for displaying Redirect: pages. HTTP fixes: image flag
wasn't getting set often enough; head fetches went wrong if kept-alive;
servers with broken byte-range code (www.pathfinder.com) worked around.

-----------------------------------------------------------------------------

25th April 1997: Borris

Merged yet more diffs from Si.

-----------------------------------------------------------------------------

24th April 1997: Borris

Merged changes from Si. Made a few bits compile again.

Altered the way in which ROWSPAN/COLSPAN cells are grown. Another word
has been added to the cell structure - optimising this at some stage
would be nice. The new approach seperates the x/y parts to simplify
things. It also always maintains correct span information (ie what is
now, not what want it to be at table end) which makes progressive
rendering more robust.

Lots of small integer and division problems in tables formatting! Core
dump type problems now fixed enough that my random tables generator
has not found a problem table with the new code yet! Checking in again
while the goings good!

Fixed lots of table bugs. More examples, etc.

-----------------------------------------------------------------------------

23rd April 1997: Simon

Added grey and greyXX support to colours.c

-----------------------------------------------------------------------------

21st April 1997: Simon

Spotted the return of debugging in resolve.c that can't be turned off
by compilation flags. Very bad. Changed to use ACCDBG. If this is felt
necessary at least use the DEBUG flag to enable it and/or the usrtrc()
function.

-----------------------------------------------------------------------------

24th April 1997: Borris

Lots of new table stuff. Tracked down one bug and came to an SJM
comment. Then tracked down the bug this was obscuring and came across
another SJM comment :-( Fixing it properly is liable to break
something, so checking in at semi-stable point for exchanging diffs
with Si.

-----------------------------------------------------------------------------

23rd April 1997: Peter

Fix problem with crashing on memory exhaustion. Fix save as draw.
Fix "3lib.ukonline.co.uk". Changes in images.c to panic harder in
low-memory situations. Fix dataload/dataopen behaviour. Fix black
backgrounds if background image not found. Released 1.44, then 1.46
to Dean.

-----------------------------------------------------------------------------

-----------------------------------------------------------------------------

5th May 1997: Simon

Fixed bug in INPUT caret positioning code I introduced some while ago.
Moved darkgreen colour into correct position. Added free(aref->title).

-----------------------------------------------------------------------------

11th May 1997: Simon

Fixed pre_deliver_word() to do tab expansion in TEXTAREA and OPTION and to
fix some memory leaks.

Added SELECT checking to fvpr and fiddled with the IMG checking a little.
Added FINISHED flag to SELECT. Changed some debugging in stream.c.

Corrected bizarre decision to pretend VALUE was set to 'on' if a RADIO
button had a null VALUE.

For STBWEB only ensure frame BORDER is 0 or >= the minimum size (so there is
room to draw links).

-----------------------------------------------------------------------------

20th May 1997: Simon.

Had a dig in parser/elements.c. The code to handle OUT_OF_ORDER_CLOSE in
perform_element_close() also needs to be present in the CLOSE_ANY_OPEN case
of ensure_pre_requisites. So I copied it there. It appears to work so as well
as <A><CENTER>Hi</A>There</CENTER> having both words centered we also get
<A><CENTER>Hi<A>There</CENTER></A> with both parts centered. Hopefully this
will cure a number of cases where the new parser didn't seem to be doing its
job.

Changed definition of VALUE attribute in attrconf to parse string void.
Changed valuestringdup() to return strdup("") for value_void items. This
means now we can tell the difference between VALUE="" and no VALUE attribute
set. This is vitally important in OPTION and probably in other things also.
I have checked other users of 'value' (PARAM, INPUT) and they should be able
to cope with the change.

-----------------------------------------------------------------------------

21st May 1997: Simon

Made closing elements with attributes still actually do the close rather than
being ignored.

Changed render_text_link_colour() so that FONT COLOUR can affect links as
well as normal text. Little bit of juggling ttto stop images picking up the
font colour also.

-----------------------------------------------------------------------------

25th April 1997: Simon

Fixed regrettable mess I'd made of http.

Fiddled with highlighting stuff some more. New file highlight.c. Be alert for
any changes in Fresco's behaviour with highlight activation.

-----------------------------------------------------------------------------

21st April 1997: Borris

Merged new formatter into main tree.

----------------------------------------------------------------------------

3rd April 1997: Borris

New formatter in new files format.[ch]. Updated Makefile. Added
GBF_NEW_FORMATTER to control this dynamically to help prototype and
test. backend_check_meta() now not STBWEB conditional due to changes
in the handling of HTTP-EQUIV.

-----------------------------------------------------------------------------

21st April 1997: Borris

Merged changes from Si.

-----------------------------------------------------------------------------

17th April 1997: Simon

New parse type colour. Understands the full X11 colour set.
Various fiddling with frames to handle 3D borders and stuff.

-----------------------------------------------------------------------------

11th April 1997: Simon

New access_MAX_PRIORITY flag to further tweak priority handling in
file/cache accesses. Added frame function to draw bevelled
borders. Some fiddling with render/redraw functions to support RCA
desired look. Shouldn't noticeably affect Fresco.

Added new parse type bool.

Fiddled with auth.c file loading a bit and removed unused prev ptrs.

-----------------------------------------------------------------------------

17th April 1997: Peter

Some changes in keyhl.c so it doesn't leave the caret all over
the place (#ifndef STBWEB, 'cos it involved changing bits of
behaviour). Anti-alias to table background colour now works in all
cases due to lovably filthy hack in otable.c.

Version now 1.44. Internal release to Dean/Nick.

-----------------------------------------------------------------------------

8th April 1997: Peter

Change access.c to make it pass the filetype to the doc_progress
fn even if rc != 200 (Fresco was failing to display all but a
small suffix of long 404 pages, eg. www.infoseek.com)

Internationalised help starting.

Fixed toolbar buttons so they indent properly. Other fixes to get
MemCheck version off the ground.

-----------------------------------------------------------------------------

7th April 1997: Borris

Merged changes from Si into SI_970403.

-----------------------------------------------------------------------------

3rd April 1997: Simon

Changed files.c open/error handling a bit. Fixed bug in access.c not
noticing errors in access_new_file() correctly. Changed render
functions to remove rid_header references so they can be used from
frontend properly.

Did a load more fiddling around with highlights and carets in backend.c
and keyhl.c. Rationalised the various exported functions I'd created down
to a few. Haven't checked the exact impact on Fresco yet...

-----------------------------------------------------------------------------

3rd April 1997: Borris

Merged changes from Si into SI_970326. Bumped version number to 1.43.
Fix some merge bugs.

-----------------------------------------------------------------------------

3rd April 1997: Peter

Improve performance of coalesce.c. Persistent history. Some little bugfixes.

-----------------------------------------------------------------------------

26th March 1997: Borris

Merged changes from Si.

-----------------------------------------------------------------------------

25th March 1997: Peter

New icons in proxy config dbox for SSL proxying (as per BT CampusWorld)

-----------------------------------------------------------------------------

24th March 1997: Peter

Support for HTTPS tunnelling proxies. Change coalesce.c so it can be used
in earlier stages of formatting (not fully done yet 'cos it's too much of
a performance hit). Stuck some code back in webgopher that had been eaten
by CVS. Reduce compiler warnings on C++ issues (eg "class" in rid.h). Fix
links to images which are also inlined on the linking page. Stopped cache
data from fragmenting memory (it's in its own flex block). Coincidentally
fully-justified paragraph in CHANGES file.

-----------------------------------------------------------------------------

25th March 1997: Borris

Merged changes from Si. This is just after the Friday release. Also
fixed a couple of minor clashes between changes made at both sites
simultaneously.

-----------------------------------------------------------------------------

21st March 1997: Simon

Added blank frontend_set_pointer_position() to !Fresco/frontend.c to
avoid #define in keyhl.c (sorry). Needs filling in if it is ever used
(it isn't currently).

-----------------------------------------------------------------------------

21st March 1997: Borris

Merged patches from Si. Heading for a major release today. Fixed minor
colspan=0 bug when cols=N in table. Minor #ifdef STBWEB in keyhl.c to
fix missing linktime symbol. This needs proper attention still!
Lessening of some assertion failures to let things hobble along for
now - backed out of these a bit! Version number increased to 1.41.

-----------------------------------------------------------------------------

20th March 1997: Simon

config_read_int will also accept BOOL settings to ease moving conifig
entries from BOOL type to INT type. Added ID attribute to LABEL. Did a
bit more colour sortig out on SELECT and TEXTAREA.

Moved the key_map from portutil.c into frontend.c/stbfe.c May want to be
moved out of the way. It is pretty easy to find at the moment.

-----------------------------------------------------------------------------

20th March 1997: Borris

Merged changes from Si. Made all the element/attribute/enumeration
guessing dependent upon gbf stuff. Element guessing is now globally
disabled as it is too dangerous. Better form debugging. Tweaks from
Dave to the parser to handle Si's example form problem. Ditto for
Peter's <A> problem.

-----------------------------------------------------------------------------

19th March 1997: Simon

Fiddled around with carets and selections again. Have almost unified the
two bits of code (one caret or selection only). Not quite finished so caret
movement might be a bit dodgy still.
Added more targets in the makefile for ROM building. Add a target to
build the dependencies for NCFresco.

-----------------------------------------------------------------------------

19th March 1997: Borris

Merged changes from Si. Updated html/regtests with newdirs to hold
some new regression tests and started doing some entries for the new
snazzy element swapping stuff. Spruced up dump.c to handle ROStyle
better - ie a lot more information is presented in a textual
fashion. This will merge well with regression diffs. Added bin
directory to collect together the utility programs (esp. python
programs) that go with Fresco. Added mkrandtable.py, which generates a
random, possibly nested, tables.

Prototype tables column code in plotcheck/rectplot.c, but commented out.

Tweaking parser so <Table>wibble is treated as wibble<Table>, not
<Table><td>wibble. Controlled by GBF_TABLES_UNEXPECTED. Removed the
flag no text from attrconf for table. New gbf.[ch] files for global
behaviour flags - not quite the same as user configuration, as we
might not want the user to be able to change them, but it permits
major bevahiour changes to be entered (source-wise) in a controlled
fashion and changed via a small single object file - very useful for
testing. As a guideline to implementing with gbf.c, you should be able
to choose any gbf behaviour from a command line, at least for testing
purposes. Made FVPR behaviour dependent upon GBF_FVPR, so Si can turn
it off when it doesn't work. FVPR should be less sensitive to lack of
pos tree.

-----------------------------------------------------------------------------

18th March 1997: Simon

Split off some of backend.c into keyhl.c to handle the keyboard highlight
moving routines. Extended greatly to handle positional movement rather than
just on the rid_text chains.
New file highlight.c to prepare for some bettwe highlight drawing routines.
Added NO_STREAM flag to access.h, allows a progress function to say it is
no longer interested in being fed data. Only has affect in file: currently
and is only used by the plugin code.

-----------------------------------------------------------------------------

18th March 1997: Borris

Unknown attribute names are matched against common stems in the
attribute list. An unknown attribute starting with a letter that no
attributes start with will be ignored - this is within the set of
attributes for a single element, not the entire possible set.  Similar
scheme for unknown elements as well. And attribute
enumerations. Compilation of this extra behaviour can be prevented
with PREVENT_ELEMENT_GUESSING, PREVENT_ATTRIBUTE_GUESSING and
PREVENT_ENUMERATION_GUESSING.

So, <bo bg=wh> is the same as <body bgcolor=white>.

-----------------------------------------------------------------------------

16th March 1997: Borris

Fixed many rowspan and colspan bugs. Created HTML samples that provoke
many of them so that the chequers harness can perform regression
checks on these fixes.

-----------------------------------------------------------------------------

14th March 1997: Borris

New plotcheck directory for rectangle overlap checking plotter. The
mere act of trying to debug this uncovered a number of colspan=0 bugs.

-----------------------------------------------------------------------------

18th March 1997: Peter

Change build stamping to use __DATE__ (in buildtime.c)

Make history lists use their own flex block.

-----------------------------------------------------------------------------

10th March 1997: Peter

Change line spacing in webfonts.c to depend only on point size,
not on font bounding box. Fix in HTTP module for servers sending
multipart/x-byteranges. Fix be_item_info (was losing IMAGE flag).

-----------------------------------------------------------------------------

17th MArch 1997: Borris

Merged patches from Si.

-----------------------------------------------------------------------------

17th March 1997: Borris

Merged comment handling patches from Dave.

-----------------------------------------------------------------------------

13th March 1997: Borris

Merged diffs from Si. Removed some dollar logs that had crept back in.

-----------------------------------------------------------------------------

12th March 1997: Borris

Merged diffs from Si.

-----------------------------------------------------------------------------

10th March 1997: Simon.

Delivery of SI_970310 diffs.

-----------------------------------------------------------------------------

11th March 1997: Borris

Fixed debugging bug in backend.c (fl/fr mismatch). Made
webfont_font_width always present as oinput.c has an unconditional use
of it now.

-----------------------------------------------------------------------------

10th March 1997. Dave

Merged in with main branch on gi.ant from DL_970213

-----------------------------------------------------------------------------

6th March 1997.  Dave

The behaviour of bad markup has been reviewed and strategy (mostly)
decided.  FLAG_DONT_STACK has been abolished and replaced with
FLAG_DONT_FORCE_CLOSE which will keep an element live on the stack
instead of forcing it closed.  So elements such as FORM and TABLE will
only be closed by the matching markup.  FLAG_FIX_CLOSE_ORDER has been
renamed to FLAG_OUT_OF_ORDER_CLOSE (which was unused, but my first
choice). Such elements will not close any other elements if they are
closed too soon.  Substantial streamlining of perform_element_close as
a result.

Prerequisite INVENT_ONLY_WITHIN has been introduced to suppress
inventing dummy elements to enclose others. In such a case the element
is replaced by the element specified in the REPLACE_WITH
prerequisite. Such an element must be distinct and have the
REPLACES_BAD flag referencing the original element. E.g., LI -> BADLI.
For simplicity in the close case, the REPLACES_BAD must be the first
requisite.

See atrrconf.notes for details of flags and which have changed.  The
new 'bad' handlers can be found in fresparse/special.c.

All uses of PACK have now been replaced by SET_EFFECTS allowing, e.g.,
size and colour to be closed independently. It is not perfect as it
merely restores the effect to before the element, and any inner styles
will override it.  Where webfont size is set, a finer mask is now used
(STYLE_WF_SIZE defined in webfonts.h) to allow fonts to be undone
independently of other webfont effects.

The comment state machine has been changed to correctly handle SGML
comments - the description claimed this to be the case but it wasn't
so I may have reversed some attempt to handle bad comments better by
mistake.

-----------------------------------------------------------------------------

Ist March 1997.  Dave

To handle bad comments, the state machine has been extended to drop an
anchor at the first ">" while waiting for a closing - or --. If the
end of stream is reached and we are still in such a state, we
backtrack and feed the characters from the anchor onwards as if in the
context of just before the comment.  We always start one character
after the anchor so it is guaranteed to terminate, but a pathological
source file will take a *long* time.  This required changes to
SGMLCTX, sgml_stream_finished as well as the state machine itself.

-----------------------------------------------------------------------------

20th February 1997.  Dave

For GROUP_NONE items, out of order closes now pull the matching close
to the top of the stack rather than closing all until the matching
close.  Flag FIX_CLOSE_ORDER introduced to give this behaviour
(without, the old phantom behaviour is still obtained). This is
currently set for all the style tags: B, I, ..., EM, ..., FONT.
Routines find_element_in_stack and pull_stack_item_to_top introduced
to support.c
Some uses of UNPACK/PACK have been replaced with SET_EFFECTS_FLAG and
SET_EFFECTS_WF_FLAG (with corresponding routines set_effects_flag_fn
and set_effects_wf_flag_fn in support.c).  STACK_ITEM has a new field
effects_applied which is to be used by SET_EFFECTS_FLAG to allow out
of order undoing of the effects of an element. effects_applied is
zeroed in clear_stack_item and on *every* push_item.

Rule: take the effects_active from an arbitrary point on the stack and
apply all subsequent effects_applied and you should get to the
effects_active at TOS. In the long term this principle should be
applied to *all* the effects.

Introduced OUT to replace wanton use of stderr with checkers. Only a
few substitutions so far. dump.c now switches on the CHECKER flag and
won't print pointers in dumps. (I have used #ifndef as CHECKER => a
subset.)  check_all et al., now dump the html tags and report to a log
file for later comparison. This will spot some changed behaviour
without being sensitive to addresses.

-----------------------------------------------------------------------------

10th March 1997: Borris

Merged diffs from Si into SI_970228 point.

-----------------------------------------------------------------------------

7th March 1997: Simon

Some more work on form elements. New LABEL element implemented from
W3C working draft. Means changes throughout to handling of aref items.
They now have an extra bit to say whether they are a URL anchor or a
label anchor.

Extensions to backend_item_info for plugins and labels.

Extension to backend_check_meta() to pull out expires and last modified
from cache (after abortive attempt to add real http headers to meta
list - would be useful but can wait).

OBJECTs now get formatted even if the apporpriate plugin can't be found.
image support for OBJECTs completed including SHAPES and USEMAP. Not very
tested though.

New backend function for locating an ID on a page. New document flag
to cause the NC highlight box to be drawn as a coloured background.

-----------------------------------------------------------------------------

7th March 1997: Peter

Fix RiscOSLib so it builds under Unix. "make riscoslib" does the
business. "make realclean" removes it and its objects. The
library file itself probably shouldn't be in the repository now.
Similarly for memlib.
    Coalescing of rid_text_item_text's when they've all got the
same style anyway (big memory win). <DL COMPACT> and
<BLOCKQUOTE>. <DL> now formats in Fresco the same way it does in
Netscape and NCFresco (changes appearance of some pages).
    Frobbed with FVPR so it never causes blank pages :-( ...
still some work needed to make it DTRT unfortunately.

-----------------------------------------------------------------------------

28th February 1997: Borris

Fixed Makefile so lack of abs directory doesn't delete all the top
level files. Tag SI_970228 is what Si's latest diffs are against.

-----------------------------------------------------------------------------

27th February 1997: Borris

Adjusted mklinks for RISC_OSLib to make it work. Improvements to FVPR
algorithm - actually seems to do something useful now! Changed some
debugging routines from BLAH to BLAHN to improve the performance of
the code when debugging is present. There are many pieces of debugging
present that could be removed RSN!

-----------------------------------------------------------------------------

26th February 1997: Borris

First stab at final value progressive rendering implementation.

-----------------------------------------------------------------------------

25th February 1997: Borris

Moved lookup_key_action from util.c to portutil.c (debatable where it
belongs, as it invokes no OS specific code). Other changes to make
builders build again.

-----------------------------------------------------------------------------

28th February 1997: Borris

Merged Si's changes in to SI_970227.

-----------------------------------------------------------------------------

27th February 1997: Simon

Added more new attributes to form elements. Moved push_input from builders.c
into forms.c. Lots of work in oimage.c and oinput.c to support new
attributes. Moved to sharing image code so now INPUTs can have width and
height and alt text.
Some new plugin features supported. Added plugin info to backend_item_info().
Fixed said function to return image flag and handle when an image object is
interrogated (didn't appear to happen before!).

-----------------------------------------------------------------------------

27th February 1997: Borris

Merged full tree from Si into SI_970224. Sorted out MemCheck.h
clash. Renamed stdalone/makefile,fe1 for safety reasons. Removed a few
dollar IDs from header files.

-----------------------------------------------------------------------------

24th February 1997: Simon

Tried to move NCFresco to memlib. Fiddled with various MEMLIB bits around
the place to get a clean build. Fixed some leftovers from Borris's last
changes.

-----------------------------------------------------------------------------

24th February 1997: Borris

Fixed #else #else problem - Si's diffs will probably also fix this!

-----------------------------------------------------------------------------

24th February 1997: Borris

Merged diffs from Si to BORRIS_970218 version. Expanded seperately
packaged binary of !NCFResco/Resources/UK directory, added couple of
Sprites3 files.

-----------------------------------------------------------------------------

19th February 1997: Simon

Added ID to various elements. and some new attributes to the form
elements.  Set be_item_info_ISMAP bit over an INPUT TYPE=IMAGE unless
the new NOCURSOR bit is set. if htmlriscos_colour() hasn't got a valid
value_type it sets the colour to -1.

-----------------------------------------------------------------------------

24th February 1997: Borris

Ran sortout.py --eol on webftp, webgopher and commonsrc to remove all
the ^M carriage returns.  The result of Acorn using CVS is all the
dollar ID strings are modified, including in directories Si has not
altered but which have ^M convention. Sending the diffs through the
email loses the ^M information, and patch has a hard time as a result.
As of now, the policy is to remove ^M as soon as possible.

-----------------------------------------------------------------------------

20th February 1997: Peter

Fixed "play forever" animations. Fixed images going wrong on mode change.

-----------------------------------------------------------------------------

20th February 1997: Borris

Bumped version to 1.38. Fixed some minor things that gcc warned about when
asked to compile with virtually every warning it knows about.

-----------------------------------------------------------------------------

19th February 1997: Peter

Fix "refresh=ondispose" problem. Fix <style> stopping text display.

-----------------------------------------------------------------------------

19th February 1997: Borris

Ensure the following were correct and up to date by getting a rerelease
from Nick Smith:

M webimage/test,ff8
M webimage/webimage

Bumped version to 1.37 after doing a production build of 1.36 for Dean to
release for internal testing to see what we've improved/broken during the
recent merge.

<font colour> accepted same as <font color>. Couple of minor
uninitialised variables now initialised.

!Fresco/RelNotes,faf created.

-----------------------------------------------------------------------------

18th February 1997: Borris

Finally resolved the issue of where objparse.c lives. I had placed it
in commonsrc, and Si had placed it in fresparse. This was not a
problem until the two source trees where bought directly
together. From now on, objparse.c lives in the fresparse directory
(and the commonsrc version has disappeard to the attic).

Created cvs-checks.py - a python program to scan the source tree and
flag potential problems. At present, it looks for the blah and
blah,ffd type clashes, as these all need resolving. cvs-checks is a
wrapper that means things don't barf when python is not availabe (eg
ANT's riscix box). Makefile altered so that one CANNOT complete a
compilation if the sanity checks fail. PLEASE fix the sanity checks or
the checker instead of just trying to bypass this.

Symbolic links: see the README file. Always do a ./makelinks after
receiving an update.

-----------------------------------------------------------------------------

17th February 1997: Borris

Merged various source trees. Getting to build again.

-----------------------------------------------------------------------------

14th February 1997. Borris

Added ssleay/roheaders to top level makelinks, so a cross compilation of
http works correctly.

-----------------------------------------------------------------------------

13th February 1997. Borris

Merged Dave's initial changes (dave-970213-a) in to the tree.

-----------------------------------------------------------------------------

13th February 1997. Peter

HTTP module: keep-alive, image prefix fetching. Common sources:
font colour, anti-alias to table backgrounds. Fresco: stop button
does complete stop, bogus Referer lines eliminated.

-----------------------------------------------------------------------------

7th February 1997. Borris

Fudge for minc/maxc in tablesize.c for when get minimum size larger than
maximum size.

-----------------------------------------------------------------------------

7th February 1997. Peter

Fix year wrapping bug in webftp. Couple of minor alt.typography.pedant
fixes.

-----------------------------------------------------------------------------

29th January 1997. Borris

Minor tweak in rid.h to make it compile. Few other small tweaks. About
to export version to Dave Lloyd.

-----------------------------------------------------------------------------

13th January 1997. Borris

Moved repository over to gi.ant.co.uk. Minor tweaks for bu compilation.
Played with CVS repository access permissions a bit.

-----------------------------------------------------------------------------

17th October 1996. Borris

Started commonsrc/coretypes.h for those basic types (like BOOL and intxy).
Please migrate appropriate definitions there as you find them.

Started basic rectangle overlap consistency checker.

-----------------------------------------------------------------------------

10th December 1996. Borris

Hack in rid_text_item_connect for NULL streams. Must be properly fixed
someday!

-----------------------------------------------------------------------------

9th December 1996. Borris

Updated makelinks to do plingcbresco - you might need to rerun this.

-----------------------------------------------------------------------------

19th November 1996. Borris

Upped version to 1.34 so properly merged version from Si is distinguishable.

-----------------------------------------------------------------------------

31st October 1996. Borris

Made \t, \r and \n as acceptable as space for comma seperated lists.

-----------------------------------------------------------------------------

9th December 1996. Peter

Added CBFresco directory and sources, copied from NCFresco but
then diverged. Some changes in commonsrc for CBFresco as well
(#ifdef CBPROJECT).

Added !Fresco support for forms with action=mailto:xxx and
method=post (by swiping the code from NCFresco).

-----------------------------------------------------------------------------

13th November 1996. Borris

Merged SI_961112

-----------------------------------------------------------------------------

8th October 1996. Simon

Use draw module for underlining/strikethrough for printing to get round
offset problems with bitmap printers. Except I didn't cos it still doesn't
work.

-----------------------------------------------------------------------------

7th October 1996. Simon

Added 4 bytes to sprite area allocated in images.c. This is to fix an
apparent spriteextend bug causing it to read one word bwyond the end of
a sprite area.

Moved changing display_scale/margins in print start job to before the
document format and added call to antweb_document_sizeitems().

-----------------------------------------------------------------------------

6th October 1996. Simon

Added bit in access_http_fetch_alarm to check and see if the file coming in
was a server-push. If it is in then the access is aborted. This is
conditionally compiled for NC only at the moment.
Send Host: header. Without this some sites go wrong these days.

-----------------------------------------------------------------------------

4th October 1996. Simon

URL escapes now match Netscape. A-F in upper case. unescaped *-.@_

Fixed serious memory leak in http module - the headers to be sent were
copied into the RMA but then never freed. Also noted leak in SSL specific
code where strings used to construct SSL headers are strdup'd twice.

-----------------------------------------------------------------------------

30th October 1996. Simon

Post freeze changes!

image_thread_end() now loops until the thread dies. This stops a nasty leak
of memory when you abort an image fetch.

cookie default path is / rather than the document URL.

new flag in frontend_open_url to say that document was loaded as part of a
frameset.

Fixed problem with new hacky error scheme on access failures not always
getting an error message.

-----------------------------------------------------------------------------

7th November 1996. Dean

Updated version number in !Help file to 1.32.

-----------------------------------------------------------------------------

28th October 1996. Borris

Merged SI_961028

----------------------------------------------------------------------------

28th October 1996. Simon

Changed cache flushing to work (wipe contents of each directory not the
top directory!). And explicitly remove details.

-----------------------------------------------------------------------------

25th October 1996. Simon

Took table_deliver installation out of finishtd/th/tr. Any unexpected chars
gets added into previous cell rather than creating new cells. This fixes a
lot of table formatting problems.

In otext_size an empty text item now has no descender. This fixes the problem
of <IMG><BR><IMG> getting a black line between the two images at the expense
of the <BR><BR> difference being slightly smaller.

In http_fetch_alarm() if HTTP_SetFileType file types something as data then
call suffix_to_file_type. Fixes a problem with sites that send
application/octet-stream rather than the correct type.

When a password was entered the code to save cookies and passwords
autmoatically was bypassed because of the redirection. Fixed this.

Made auth_lookup_string malloc the string it returns as otherwise you can't
proxy and normal authenticate at once.

-----------------------------------------------------------------------------

25th October 1996. borris

Merged SI_961024

-----------------------------------------------------------------------------

24th October 1996. Simon

Silly bug with checking file types on ftp/gopher meant couldn't load anything
except plugins. Wouldn't have affected Fresco though.

Changed cache images to use palettes when <= 8bpp. This seems to stop a crash
problem.

Made AREA and MAP nostack items.

-----------------------------------------------------------------------------

21st October 1996. Borris

MAde malloc into mm_malloc in strdup_gstrans.

-----------------------------------------------------------------------------

24th October 1996. Borris

Merged SI_961023

-----------------------------------------------------------------------------

23rd October 1996. Simon

Tried to catch more out of memory problems. Added antweb_abort_doc_all() to
backend.c which is called from mm_can_we_recover(). Added call to recover
to memzone_alloc().
Rewrote HTParseTime completely to cope with yet another dumb format from
Oracle. Should cope with just about anything now.

Changed most occurences of time_t as for some reason it is now coming out
as 'long' rather than 'unsigned int' (dumb inet headers) and cookies
are all failing.

Made my fix to finisha only occur when not at the top level stream. It has
a problem in that the zero-size item can still cause a line to split after
it.

Changed the way that overlaps work to (maybe) be the same way as Netscape.
The new cell stomps on the old cell, rather than the other way around.

-----------------------------------------------------------------------------

22nd October 1996. Simon

Fixed leak in gstrans_not_null(). Added loads of MemCheck calls to aid
memory leak tracking. Really fixed the huge box that appears if you had
<IMG WIDTH=xx ALT=XX> (got pixels and font units mixed up).
Made Proxy authorization work.

-----------------------------------------------------------------------------

21st October 1996. Simon

Fixed backend_item_pos_info() again - if you have a client-side imagemap then
you never want to return the ISMAP link.

Fixed malloc not mm_malloc bug in strdup_gstrans().

Added MemCheck support. Found NULL deref in config_check_vars()
and rid_scan(). Possible string overwrite in url_canonicalise_path
(not tracked down yet).

----------------------------------------------------------------------------

18th October 1996. Simon

Fiddled with STBWEB redial stuff in access.c. Changed the user file load code
to check for file existence rather than system variable not null.

If finisha finds that nothing has been given the aref and text_last is NULL then
it pushes an empty text item. This fixes the case of <TD><A NAME="fred"></A>

-----------------------------------------------------------------------------

18th October 1996. Peter

Some cosmetic stuff for Fresco (NCFresco not affected): icons aligned
to 4 OS units vertically in templates file (so they indent properly in
rectangle modes); DragASprite calls added to savedoc.c (stops us looking
quite so RiscOS 2-ish).

-----------------------------------------------------------------------------

18th October 1996. Borris

Merged SI_961017

-----------------------------------------------------------------------------

17th October 1996. Simon.

Slightly cleaned up the way file type checking works for http. Added it to
gopher and ftp methods. Added missing error checking on HTTP SWIs (in case
the module is killed mid-transit).

-----------------------------------------------------------------------------

16th October 1996. Simon.

my.yahoo.com showed up two tables problems which I have hacked fixes to
(look for SJM).
  scanback() doesn't seem to get out of tables. So if the ->prev ptr is null
  it now falls back to the old method.
  new_sizer() was getting a divide by zero.

backend_doc_image_change() was still not right with floating images. The
entire stream is now searched. Inefficient, but will work.

More printing fixes. Disable font blending. Disable the new margins. Disable
the scaled up fonts.

-----------------------------------------------------------------------------

15th October 1996. Borris

New GIF DLL from Nick.

-----------------------------------------------------------------------------

16th October 1996. Borris

Merged SI_961015

-----------------------------------------------------------------------------

15th October 1996. Simon

Fixes to animations. Basically a few more cases than originally expected
may end up showing through to the background and so require plotting
via masks. Also the animation needs to be reset (mask cleared) at the start.

NO_PICS was ignored in oimage.c so pictures couldn't be turned off in
printing.

Added Proxy-authentication code to access.c
Added checks for null pathnames after gstransing in auth, cookie, pluginfile.

-----------------------------------------------------------------------------

14th October 1996. Borris

Merged SI_961014

-----------------------------------------------------------------------------

14th October 1996. Simon

More margin problems. Images weren't being updated correctly when they
reformatted. (frontend_view_block_move didn't take margins into account).
goto_fragment was compensating twice.

Removed once-only restriction from HTML tag. This stops the following going
wrong. Dunno what else it may affect though.
<HTML>
<FRAMESET>
<NOFRAMES>
<HTML><BODY></BODY></HTML>
</NOFRAMES>
</FRAMESET>
</HTML>

Altered LOCATION handling code slightly so that all other headers (eg
cookies) are handled before the new URL is fetched.

-----------------------------------------------------------------------------

14th October 1996. Borris

Now choose between Nicko's height sharing and the old height sharing
code based upon how many rows there are in the table - Nicko's code
does better but has much higher overheads. Fixed minor bug in old
height sharing code.

In sheer desperation, added some code that stomps all width
specifications for an entire nestet table tree if the minwidth of it
formats larger than the width we're going to format it in.

-----------------------------------------------------------------------------

13th October 1996. Borris

Fixed some odd ANTI_TWITTER and USE_MARGINS bugs.

Made tables suppress their left/right floating flag setting until the
/TABLE as a cheap hack to get around problems when a table gets
formatter multiply. This needs sorting out properly someday!

Went back to old share_span_evenly height method for tables as
otherwise a 3000 line table effectively kills us (certainly with NC
type memory quantities).

-----------------------------------------------------------------------------

13th October 1996. Borris

Merged SI_961011.

-----------------------------------------------------------------------------

11th October 1996. Simon

More on FORM. Changed table_deliver() to pass on FORM open and close without
side-effects. Removed flag_block from FORM in attrconf.

Made some more changes to margins. Small change to Fresco/frontend.c to
support it.

Changed #ifdef DEBUG to #if DEBUG in myassert.h and debug.h and changed
#ifdef NDEBUG to #if !DEBUG. We don't want assertion failures in production
code do we? Then fixed the bugs in the tables.c asserts that didn't show up
before.

Added returning error message for status_FAIL_DNS as well as the FAIL_CONNECT
done yesterday.

-----------------------------------------------------------------------------

13th October 1996. Borris

Added prev fields for images and tables so rid_scanb can work without
having to rely upon the rid_pos_item pointer, as this pointer is not
always directly suitable when the item is floating, and I can't quite
work out a perfect solution that wanders the list (eg very last item
is floating). Something better might happen if we restructure how
floating items are performed. This doesn't handle <BR>
considerations. Shout if you notice this.

-----------------------------------------------------------------------------

11th October 1996. Borris

Fixed table backgrounds. Update webgopher makefile to by a unix
one. Update makelinks program to do *zm links as well - you'll need to
run this (./makelinks) before you'll be able to build webgopher.

-----------------------------------------------------------------------------

10th October 1996. Borris

Temporary fix for webgopher and inet5. Minor bug fix for http module doing
same thing. Needs checks on docn. to do properly.

-----------------------------------------------------------------------------

10th October 1996. Borris

Merged SI_961010.

-----------------------------------------------------------------------------

10th October 1996. Simon

Made the memset that clears the image background in images.c not do
anything if there are 0 bytes to clear. It may have bearing on some strange
crashing.

Applied cunning hack to enable badly nested FORMs (ie most of them) to still
work. There is a new flag in attrconf FLAG_DONT_STACK which currently is only
set on FORM. In parse_element_open() everything happens as normal except
  push_stack() doesn't happen
  instead of setting the bit in context->tos->elements_open it sets a bit in
  context->dont_stack_elements_open

In parse_element_close() a third case is added to the check for a normal
close - if the element is DONT_STACK and the bit set above is set. In which
case all happens as normal except the pop isn't done.

The last change is that (almost) wherever any code checked for a bit set in
context->tos->elements_open it now calls a function which checks this bit
and the equivalent bit in dont_stack_elements_open. This allows all the
form elements to carry on working exactly as before.

rid_table_place_cols() was writing to one of its arrays without checking
that there was anything there (ie >= 1 cells). This took some while to find.

-----------------------------------------------------------------------------

9th October 1996. Borris

Merged SI_961009. MEMLIB tweaks.

-----------------------------------------------------------------------------

9th October 1996. Simon

Changed antweb_doc_complete so that it checks the file size first. If the
file size is 0 it treats it as a failed download attempt.

Put MENU and DIR back to having bullets.

-----------------------------------------------------------------------------

8th October 1996. Simon

Fixed long-standing problem in cache. File 00 was never being read at
startup.

Got frames to work with pages that don't use NOFRAMES at all. It inserts the
noframes sequence after the last /FRAMESET. Had to change sgml_unwind_deliver
to make this work - I think there was a big there...

Found problem with images in tables sometimes not being updated even though
the data is obviously loaded. the loop in the redraw section of
doc_image_change stopped when the line top went below the bottom of the page.
However in tables the next line top could be back on screen again. So I
removed the check for the end. This is inefficient but will work.

-----------------------------------------------------------------------------

4th October 1996. Simon

Push null item after table toget round scanning problems. Fiddled with new
mem stuff a bit to get a clean build for STBWEB without it.
Added left and top margin attribute parsing to BODY and rid_header.
Fixed a couple of margin related left-overs in otextarea.c and printing.c

-----------------------------------------------------------------------------

9th October 1996. Borris

Fixed bug in stream_find_item_location that was uncovered by correctly
initialising the parent pointer for the top level stream. Stopped
infinite spinning due to new_sizer stupidity I made. Si likewise fixed
this I think.

-----------------------------------------------------------------------------

8th October 1996. Borris

Initalised root stream to have parent field correct! Made
rid_size_stream take a rid_text_item to indicate where it should start
formating from. This fixes the problem where <TABLE WIDTH=N> forced
the table to be stretched wider and rid_size_items got called multiply
but rid_table_share_width only got called once. Made non-production
heap allocators do the correct checking and report an error if they
fail, rather than just driving me mad ten functions later.

-----------------------------------------------------------------------------

5th October 1996. Borris

If a table supplies a width and its cells supply widths that add up to
greater than the tables supplied width, all cell-based width
specifications are removed and formatting happens again. This is not
the same as Netvirus, which will preserve relative column sizes, buts
it's a lot easier.

-----------------------------------------------------------------------------

4th October 1996. Borris

Merged SI_961003. Tidied things up a bit.

-----------------------------------------------------------------------------

03 October 1996. Simon

Fixed object CODEBASE (was being written out as NAME).

-----------------------------------------------------------------------------

02 October 1996. Simon

finishselect(). Made it select exactly one option if non-multiple menu.

Finally got offsets right for background in animatied gifs.

Added save area usage to one of the sprite output switches to handle the
fact that it might get switched twice (if building a tile).

Added CENTER/CENTRE to IMG ALIGN (appears to mean the same as MIDDLE, often
used by clueless authors and accepted by Netscape).

Made one function to decode the img align type, called by object, img and
input. Previously input wouldn't understand align left and right.

Fix to parse_colour_tuple. The *16 was happening on separator characters as
well as digits.

Finally tracked down crash when reloading a page with an INPUT TYPE=image on
it - code in doc_image_change assumed that an image was always contained in
a rid_text_item_image. Very bad...

Added some hacky bits to access_*_dns_alarm functions and the complete
functions so that the frontend can get hold of the actual errors that
occurred when trying to connect. Some nasty reusing of parameters but
it seems safe enough.

-----------------------------------------------------------------------------

4th October 1996. Borris

Fixed bug where last few words of a document might not get sized as
they got "presented" when the stream got closed and flushed, which was
occuring after the sizing operation.

-----------------------------------------------------------------------------

3rd October 1996. Peter

Plenty of work on memory routines: mm_malloc/mm_free now call a
version which keeps the arena in a dynamic area (if possible);
new header "flexwrap.h" allows flex to be in a DA too. Added new
directory "memlib" containing the new routines (and a Unix
makefile for them). Fix a couple of memory leaks in savedoc.c and
frontend.c

-----------------------------------------------------------------------------

30th September 1996. Borris.

Altered calculation of table cell vertical positioning (esp when
VALIGN=MIDDLE etc) to take cellspacing and cellborder values in to
account.

-----------------------------------------------------------------------------

27th September 1996. Borris

Extended BGCOLOR to be a table cell property inherited like HALIGN
(same order, etc).

-----------------------------------------------------------------------------

26 September 1996. Borris

Caught a few places where DEBUG and not SGML_REPORTING would do stupid
things and fixed them. Made copying of the RELEASE directory use -p to
preserve time stamp information. MAde distribution building create a
tar file of !Fresco for easier distribution.

-----------------------------------------------------------------------------

27th September 1996. Borris

Merged SI_960926.

-----------------------------------------------------------------------------

26 September 1996. Simon

Changed a few files more over to new style error reporting.
Fixed the NULL link being written out when over NOHREF regions.

Leak in starttable - caption was allocated then never used.
Leak in sgml_reporting. Bizarre way in which linked list was created meant
that it didn't get freed whn traversing via next so used prev instead.
Leak in cookie_dispose_all (domain names).

Changed config loading. Fresco code is now back to the way it originally was.
Functions to load by file name are now exported for NCFresco to use.

bcakend_goto_fragment now only gives error if the document has finished
downloading.

Made center nestable which is what ns does.

-----------------------------------------------------------------------------

26 September 1996. Borris

Merged SI_960925.

-----------------------------------------------------------------------------

25th September 1996. Simon

HTParseTime now accepts an abreviated date form that netscape accepts and
oracle use. This doesn't affect any of the other forms it accepts.

-----------------------------------------------------------------------------

24th September 1996. Borris

Production code now uses MEMWATCH of 0. Debugging code still needs to
be updated, as it appears to be lacking the memory recovery code. Why
this is so, I haven't the foggiest. It shouldn't be. It does explain
why fresco has been bad about memory recovery for a while!

-----------------------------------------------------------------------------

24th September 1996. Borris

Changed some uses of stream to curstream in deliver.c This explains
why table nesting changed behaviour - the decisions where being made
against a different stream! This sorts out Nicko's interesting <LI>
set of examples.

-----------------------------------------------------------------------------

24th September 1996. Peter

Fixed background tiling in rectangle-pixel modes

-----------------------------------------------------------------------------

23rd September 1996. Borris

Tracked down yet another bug whereby table maximum width was coming
out less than the minimum width. This time, it was due to unfortunate
formatting causing minwidth calculations to place a PBREAK item at the
start of a line, but for maxwidth formatting the PBREAK got added to
the previous line, adding it's width of -1. So maxwidth was minwidth -
1. Solved this by not adding negative widths to the ongoing width
value during formatting.

Uses of fprintf(stderr, ...) for production code replaced with calls
to usrtrc(), which depends upon Fresco$Trace being set in the
environment before it prints anything.

Made adding a word where LINE_BREAK and NO_BREAK are both set clear
the NO_BREAK flag. I don't think this is ideal, but <LI> handling is
getting a real mess now, as Si's changes broke some cases as well as
fixing others :-(

http://www.microsoft.com/corpinfo/ fails due to formatting get
maxwidth < minwidth when lots of align=left and align=right
items. Ahhh, 4 hours and it's yet another bug of someone elses.

HEY FOLKS - TAKE YOUR DEBUGGING OUT ONCE YOU'RE DONE WITH IT. PLEASE!!!

-----------------------------------------------------------------------------

23rd September 1996. Borris

Minor tweaks to remove debugging and SGML reporting to generate 1.30
version.  -Fn enables function name embedding within the objects
produced (the revese meaning of the flag as I had previously
understood it). This should be removed manually when producing a
production version. It must be enabled to produce debugging versions
as the heap uses caller() which examines these embbeded names. I can't
figure out how to do this automatically.

Minor tweaks to remove debugging and SGML reporting to generate 1.30 version.

PRODUCTION, no SGML_REPORTING:		365484
ditto and no function names:		342736
DEVELOPMENT=2, no SGML_REPORTING:	425372

-----------------------------------------------------------------------------

22nd September 1996. Borris

Finally tracked down and fixed a bug in slack width sharing. Phew! I
don't want to do this again. This permits the code to handle a table's
width forcing the table to grow beyond maxwidth of all the cells to
work correctly. Fixed another table width bug.

-----------------------------------------------------------------------------

20th September 1996. Borris

Merged SI_960919

-----------------------------------------------------------------------------

20th September 1996. Simon

Fiddled with line breaks.
text_item_ensure_break() only works if it is not following a BULLET object.

text_item_push_break() sets a flag to say that BR was used and only does
something if previous word didn't have a LINE_BREAK or did have an
EXPLICIT_BREAK. This stops <LI>Line 1<BR><LI>Line 2 having a double
space between lines.

removed ensure_break from pre_open_markup unless block level element.

Made url_escape_cat/to_file not escape a few safe characters.

Added new status type for redialling.

Added new flag to tables in attrconf flag manual break. This disables any
break entering that may be done in deliver.c and leaves it up to the
start/finish code to handle it.

Added a bit to backend_doc_complete to stop page scrolling down to first
text item.

Made image default to BOTTOM.

-----------------------------------------------------------------------------

19th September 1996. Simon

Fiddled a bit more with otext.c selection box handling. Change
backend_update_link to only cause redraw when selected flag actually changes.
Fixed printing error handling, added a missing check and a call to abortjob().
Added some missing frees to table stuff in rid.c

-----------------------------------------------------------------------------

19th September 1996. Borris

Serious attack on captions - fixed numerous inconsistencies and
finally decided upon how the border/spacing/padding values are spread
around to keep things easy and consistent.

-----------------------------------------------------------------------------

18th September 1996. Borris

Shuffling code for TFOOT working. Correct setting of group border
flags.  Use these group border flags in cell border drawing code. Also
do 3D shaded cell borders iff no image background or colour.

-----------------------------------------------------------------------------

17th September 1996. Borris

Merged SI_960917.

-----------------------------------------------------------------------------

17th September 1996. Borris

Resulting merged fresco goes boom early during execution.

Moved top line of cell border down one pixel. TFOOT handling.

-----------------------------------------------------------------------------

16th September 1996. Borris

Merged SI_960916. Note triggers a second tag for the day!

-----------------------------------------------------------------------------

16th September 1996. Simon

Fixed bug in new comments code, didn't handle ---> properly.
Made parse_integer return integer (0) rather than none with bad input and
parse_colour_tuple accepts comma separated values.

-----------------------------------------------------------------------------

16th September 1996. Borris

Made change so that FLAG_FULL_UNWIND on an element overrides the
normal close behaviour of stopping at a container. Intended for frames
use, but might be applicable elsewhere.

-----------------------------------------------------------------------------

16th September 1996. Borris

Merged SI_960913.

-----------------------------------------------------------------------------
13th September 1996. Simon

Added disposal routines for auth, cache, pluginfile.

Fixed bug in animations (not settting build mask bits when an intermediate
frame doesn't have a mask). And in plotting 16 into 32bpp, didn't realise
it needed to do plot scaled still. And in plotting to rectangle pixel modes.

Added bit to dir2html to swap / to . if the UNIXY define is set.

Added code to fmt_deliver_space() to ignore space if the previous word in
the stream had a space at the end. This fixes the situation where lots of
markup separated by spaces will get lots of spaces rather than just one,
eg <B> <A HREF= > Text </B> </A> .

Changed makeerror to copy the formed error into a messagetrans block to
avoid error overwriting.

-----------------------------------------------------------------------------
12th September 1996. Simon

Enabled the new comments code. Fixed flexmem imbalance in new animation code.

-----------------------------------------------------------------------------

13th September 1996. Nicko

**** Warning: Incompatable changes in interface.h ****

I have changed a couple of things in interface.h.  Firstly, the
frontend_view_status() call has been modified to pass information in a
more efficient manner and also to pass the information in more of a
'raw' form.  In general the information not converted into a string
and passed but is instead sent in its original form and the frontend
now converts it into something readable.  The call is now better
documented in the header file.  The other major change is that
backend_item_pos_info() now takes the co-ordinates of the pointer
position in variables that are passed by reference.  The contents of
these variables are converted into 'map' co-ordinated when the
call returns.  This lets the frontend tell the user what value
will be sent to a map program if the user clicks.

-----------------------------------------------------------------------------

12th Sepember 1996. Borris

Merged SI_960911.

-----------------------------------------------------------------------------

11th September 1996. Simon

Fixed couple of bugs in imagemaps. DEFAULT wasn't recognised without a COORDS
attribute and it was being checked only after all other areas, which is
probably not what people expect.
Altered caching code to not return the file name of a file that couldn't
be deleted.(eg after a crash).
Added checking for set-cookie headers into the bit with the Location: header.

Changed comment sections of state machine to handle legal comments and
not illegal one (rather than the other way around as they are at present)
however this is defined out at the moment.

-----------------------------------------------------------------------------

11th September 1996. Borris

Improved clipping code for table cell borders. Fixed <COL
ALIGN=CENTER> bug. Fixed timing of table border adjust in formatting
code. Sorted out table cell divisions better: <TABLE FRAME=...> fully
done and <TABLE RULES=...> done except =GROUPS.

-----------------------------------------------------------------------------

11th September 1996. Borris

Merged SI_960910.

-----------------------------------------------------------------------------

10th September 1996. Simon

New animation code working. Then tweaked to get stuff going properly.
Made LISTING do same as PRE.

-----------------------------------------------------------------------------

9th September 1996. Borris

Merged SI_960909.

-----------------------------------------------------------------------------

9th September 1996. Simon

Changed state_bad_markup in statemach.c to skip to whitespace, dumping bad
characters, then continue. Old function is now state_really_bad_markup used
in unrecoverable situations (currently bad element name).

-----------------------------------------------------------------------------

8th September 1996. Simon

Made value_body aharacters in parser/support.c accept almost anything.
Tried a hack in perform_element_close to make NOFRAMES work properly.
New function coords_union in portutil.c
Changed image_callback_fn to pass a wimp_box as well for more efficient
updating (initially for animation).
Added flag (to images.h and interface.h) to say it's an animation.

-----------------------------------------------------------------------------

September 9th 1996. Borris

Tracked down the stupid rid_getprop() bug. Due to realloc() and not
updating previously calculated pointers. Reworked all the relevant
code.

-----------------------------------------------------------------------------

8th September 1996. Borris

Merged SI_960906.

-----------------------------------------------------------------------------

6th September 1996. Simon

Fixed parse_http_header to accept 'NAME=;' as a valid element.

Fixed cookie bugs: apparently time() retuns DST not GMT so correct for
that. Cokies weren't being checked for expiry before being sent out.
Made HTParseTime cope with next century dates. Fixed loads of sillies with
domain name matching.

Added a unique message for NCFresco to the list in urlopen.h

Added file_lock() to util.c

Added a new view_status call that is done when doc_complete finishes.

Added OS version to user-agent header. Code is in licence.c if it proves
objectionable. Tricky situation of how to deal with the space in RISC OS...

-----------------------------------------------------------------------------

6th September 1996. Borris

Merged SI_960905 and two tar files. Made minor casting improvements to
rid_getprop and added TASSERT to starthtml, but don't I think the
rid_getprop() boom has gone yet!

-----------------------------------------------------------------------------

5th September 1996. Simon

Some more plugins work. Added two configure entries (to configgui.c also)
for plugin config file and whether to keep it up to date or not.
Extra valuetype to ensure that non OBJECT attributes for APPLET and EMBED are
marked properly in the parameter file.

-----------------------------------------------------------------------------

September 5th 1996. Borris

If a table row has over 100% width specified or has 100% specified
with other items on the row, we totally remove the %age specifications
for this line. This isn't ideal, but that's users for you!

-----------------------------------------------------------------------------

5th September 1996. Borris.

New defintions for border, cellspacing and cellpadding now adding up
correctly. Change attrribute used for <TABLE BORDER> in
attrconf. Fixed bug in parsing integer/void attributes. <LI> is the
only pre-break element that is not also a block-level element - this
mean the pre-break flag got lost if there was no word/space to push to
carry the break. Fix applied.

-----------------------------------------------------------------------------

2nd September 1996. Borris

See commonsrc/TABLENOTES for decisions on table border, cellpadding
and cellspacing implementation.

-----------------------------------------------------------------------------

4th September 1996. Borris

Merged SI-960904 and SI_960904_TAR.

-----------------------------------------------------------------------------

4th September Simon

extended expiry code to handle images. image_find_flag_CHECK_EXPIRE works
analogously to be_ flag. Some minor changes to ensure flags are passed
through at correct time. access_test_cache now returns whether file is
expired or not. Expiry checks current time and Date: header of file.

-----------------------------------------------------------------------------

30th August Simon

Support for document expiry.

access.c now parses date, last-modified and expires headers and passes them
to the caching code. cache3.c now writes out a format header to the cache
dump file. Format 2 now includes the header info from access.c. There is
a new flag in each of frontend_open_url, backend_open_url and access_url
to specify whether the expiry date should be checked before retrieving
something from the cache.

Brought !Fresco/frontend.c into line with these changes (look for SJM
markers).

-----------------------------------------------------------------------------

29th August 1996. Borris

Made justification of table cells not do last when get end of stream
without a line break indicator.

-----------------------------------------------------------------------------

29th August 1996. Nicko

Statusbar code altered to smooth the rate at which the world turns.

Statusbar code changed to have a 'floating' ANT logo on the right hand
side of the button bar.  Sprites file and templates file changed to
allow this.

Frontend code changed so that views can inherit the flags and history
list from the parent view when they are made using a 'right button'
click.

Backend code change to fix the redraw bug that occured when a
background image shared by two views we flushed from on of the views.

Fixed the bug in tablesize that made tables come out wider than they
needed to be.  It seems Borris fixed this too.

-----------------------------------------------------------------------------

29th August 1996. Borris

Fixed tables being too wide. Nicko coincidentally also fixed this -
dunno which version survives!

-----------------------------------------------------------------------------

29th August 1996. Borris

Fixed bug with <COL> and <COLGROUP> not being considered as table
elements and hence triggering insertion of <TD> when they should not.

-----------------------------------------------------------------------------

29th August 1996. Borris

Merged SI_960828

-----------------------------------------------------------------------------

28th August 1996. Simon

Lots of changes in images.c. Split off various bits of code into their own
routines for clarity and code sharing. Added rendering into a cached sprite
for animations. Gave tile code the ability to plot direct from the uncached
sprite again.

-----------------------------------------------------------------------------

27th August 1996. Borris

Merged SI_960827

-----------------------------------------------------------------------------

22nd August 1996. Simon

New flag to rid_scan(). When used with FILTER it starts the search at what
you pass in rather than the next item. Fixes APPLET at start of file problem.
More on object/applet_deliver to ensure only the correct PARAM's and A's are
delivered.
Filled in the shaped anchor code for OBJECT.

-----------------------------------------------------------------------------

27th August 1996. Borris

Improved handling of unexpected elements between <TABLE> and <TD>.

-----------------------------------------------------------------------------

23rd August 1996. Borris

Improved unexpected text handling. See fresparse/delivery.c for details.

-----------------------------------------------------------------------------

22nd August 1996. Borris

Further improved <OBJECT>, <APPLET> etc. Added code to free associated
string data from diverted deliveries.

Merged SI_960822 from BORRIS_960821 into head version.

-----------------------------------------------------------------------------

21st August 1996. Simon

Nasty bit in elements.c for </P> handling

-----------------------------------------------------------------------------

22nd August 1996. Borris

Further improved <OBJECT>, <APPLET> etc.

-----------------------------------------------------------------------------

21st August 1996. Borris

Merged some changes on the 20th (giving BORRIS_960820) and then a
couple of further changes for objparse etc (giving BORRIS_960821).

Improved sgml_install_deliver() etc handling with context->force_deliver
override flag.

-----------------------------------------------------------------------------

19th August 1996. Borris

Moved <NOFRAMES> into frames.c and had a stab at putting in the
behaviour that Si wanted. Ditto <APPLET>. Made mechanism more
generic. Started looking at <OBJECT> requirements. Still need to do
string freeing. Notes: nesting and emptiness of elements:

applet: yes
object: yes
frame: empty
frameset: yes
noframes: yes
embed: empty
noembed: yes
param: empty

-----------------------------------------------------------------------------

20th August 1996. Nicko

More changes to table sizing. Getting better.

-----------------------------------------------------------------------------

19th August 1996. Borris

Changes to license string to make it work again. Made colour tuple
parsing accept and ignore whitespace characters within the
string. This had been done once before but seemed to have gone
missing. Hacked new magic string into license.c so that development
versions work.

-----------------------------------------------------------------------------

16th August 1996. Borris

Merged SI_960816. Fixed some resulting silly bugs.

-----------------------------------------------------------------------------

15th August 1996. Borris

Put versions of suffix_to_file_type() and mime_to_file_type() into
basic1.c for builders so it can link. Removed email headers
accidentally left in at head of objparse.c and ooobject.c

-----------------------------------------------------------------------------

14th August 1996. Simon

Lots more OBJECT stuff.

-----------------------------------------------------------------------------

15th August 1996. Borris

Altered <BR> and <P> behaviour. <TABLE><TABLE> now gives
<TABLE>..<TD><TABLE>. <INPUT MAXLENGTH=N> fixed to actually allow N
characters (rather than N-1)). Made the formatter core take note of
rid_flag_NO_BREAK: clearing or floating override this flag, which
might not be what we want. Made entity munging robust to zero length
strings - these should never be supplied, but it seems someone
(incorectly!) is. MAde default number of columns spanned for
<COLGROUP> to be 1, rather than 0. Adding colhdr after colgroupsection
when there isn't a colgroup now creates one. By the time tidy_table()
is called, all colhdrs *must* have a oolgroup associated - I think
this is actually true now. Did some checking on <BR> and <P>
behaviour. Stripped leading/trailing spaces from A HREF strings.

-----------------------------------------------------------------------------

13th August 1996. Borris

Removed some old "#if 0 .. #endif" code from hparse.c

-----------------------------------------------------------------------------

12th August 1996. Borris

Made unexpected text when last stacked item is a table content item
auto-insert <td> and retry the text.

-----------------------------------------------------------------------------

15th August 1996. Nicko

Changed access.c so that pages fetched by http{s} with the
access_NOCACHE flag are requested with a 'Pragma: no-cache' header
line to avoid caching on proxy servers.

Altered the frontend.c code so that when a window's work area is reset
it is never made shorter then the visable length of the window.  This
means that if you have a long window open and then you fetch another
long document that comes in slowly you will still be left with a tall
window.

The function backend_item_pos_info has been changed in two ways.
Firstly it now returns a NULL link if a map has no link for a given
position (as opposed to a link that is an empty string).  Secondly the
function now sets the link flag when over a link in a local image map
even if the image itself has not got an anchor.

Fixed the form creation code so that the default method is to GET
rather than to POST.  This got changed with the new parser.

-----------------------------------------------------------------------------

13th August 1996. Simon

Started OBJECT/APPLET/EMBED implementation.

-----------------------------------------------------------------------------

8th August 1996. Simon

Made otextarea_redraw and oinput_redraw limit to graphics window correctly.
oinput_ was failing if there was nothing to plot (x1 < x0 or y1 < y0) and
otextarea was missing a setup call to gwindow.
New function in util.c for finding box intersections to help out.
Rewrite parse_http_header to cope with quotes around header elements and
generally be a bit safer.
Added CKIDBG for cookie debugging and updated cookie.c and head.c for new
scheme.

-----------------------------------------------------------------------------

7th August 1996. Simon

Changed update region in doc_image_change() to allow correct filtering.
Added STBWEB define to limit deep images in 8bit modes to 8bit.
Moved initial checking for at least one selected OPTION into finishselect()
from oselect.c as it could get it wrong with progressive updates.
Made XMP code call PRE code

-----------------------------------------------------------------------------

6th August 1996. Borris

Made builders compile again, then made it do sizing and formatting
operations again. Changes made by Nicko and I to table
sizing. Currently in a broken state.

-----------------------------------------------------------------------------

5th August 1996. Borris

This current point in the revision history (1.39) is missing a large
number of my changes.  Some have been redone, especially the top level
Makefile for bu. The reason for their absence is unknown. Redoing the
changes will probably just lead to further gyp in the future :-((

-----------------------------------------------------------------------------
5th August 1996 Nicko

A large pile of changes were merged in from Simon by email.

A number of major problems with the tables code were succesfully
papered over.

GIF animation code tweeked a little.

-----------------------------------------------------------------------------
2nd August 1996 Simon

Vertical scaling into ALT display.
IMG BORDER changed to display if link or set to > 0.
new rid function to enumerate form elements, used in forms.c to ensure that
exactly one RADIO button is selected.

-----------------------------------------------------------------------------
31st July 1996 Nicko

A number of changes have been made to structure of the debug code (the
debug functions are now built by macros becuase there were so many of
them).  Much more of the debugging is now down through macros rather
than with #if DEBUG and this has cut down the level of noise on
development builds.  More work is needed here.

The pointer info code in !Fresco/frontend.c has been changed to deal
correctly with the pointer being over an local image map.

A number of changes have been made to the statusbar code to make it
flicker less.  I have also changed the backend.c image change code to
reduce flicker too (especially with GIF animations).

The templates have been tweeked to a) remove the lock icon and b) stop
the colour names being clickable.  Also, the hideous cludge that THEY
made me put into the config code for the en-mass increment/decrement
of the font sizes has been fixed.

-----------------------------------------------------------------------------
25th July 1996 Simon

Put back my changes into printing.c that cope with splitting large objects
over pages. Conditional on the off-chance that I've missed something
important.

Altered image_handle method to take a reason code. One reason is return handle
as at present. New reason is to abort transfer of image. This is called from
backend_doc_abort(). This looks rather safer that my last attempt at this. All
we need now is for the partially downloaded image to be kept.

-----------------------------------------------------------------------------
24th July 1996 Simon

Did lots more tweaks on ALT code. Now wraps text properly. And if images are
deferred it ignores all suggested widths and heights and just uses the text.

Put some code in to deal with WIDTH=xx% but it is more complicated than I
thought so they are all ignored for now.

-----------------------------------------------------------------------------
20th July 1996 Simon

Added SGML expansion of attribute literals

-----------------------------------------------------------------------------
19th July 1996 Simon

Made major changes to all the form element handling. All form elements are
now stored in one list and are aliased onto the struct rid_form_element in
the same way as rid_text_item. This now means that all form elements will be
output in the order they appear in the HTML as per HTML 2 spec.

Redid some of the ALT text code to obey any sizes put into the HTML page.
Will now try and wrap the text into the box given if it can. If it doesn't
fit then it just truncates it. Ideally if images are disabled it would abandon
formatting and just use the text as is but it doesn't as yet.

-----------------------------------------------------------------------------

15th July 1996. Borris

Changed the handling of <P>, <BR> and block level elements again. Now,
every block level boundary will have a single PBREAK item - two block
level elements adjacent will no longer cause there to be two PBREAK
items. <BR> is no longer classified as a block level element for these
purposes.  Multiple blank lines cannot be achieved with consecutive
<P> elements, but multiple <BR> elements will give multiple blank
lines. To do this <BR> can't have a the normal BLE processing as it
must always insert a PBREAK and making it BLE would lead to two
PBREAKs.

Changed the way Makefiles handle builddate.h. A single top level
builddate.h is maintained by the top level Makefile for each child
directory. The top level Makefile is responsible for ensuring this
file gets changed - the child Makefiles are responsible for ensuring
this file gets used.

-----------------------------------------------------------------------------

15th July 1996. Borris

Updated Fresco's Makefile to ensure that buildstamp gets used.

-----------------------------------------------------------------------------

15th July 1996. Borris

Merged BORRIS_960711 with Si's diffs of 11th July
1996. stbweb/Makefile is in the main repository tree, but not this
branch (ie yet).

-----------------------------------------------------------------------------

12th July 1996. Borris

Fixed tab characters in <PRE> mode. Few other fixes.

-----------------------------------------------------------------------------

10th July 1996. Borris

Reworked markup delivery to improve in general and get start of
document correct. Fixed span calculation bug in tables. Fixed <STYLE>

-----------------------------------------------------------------------------

10th July 1996. Borris

Merged in Si's changes at SI_960719_BRANCH. Still missing stbweb contents
so patch winges brielfy.

-----------------------------------------------------------------------------

9th July 1996. Borris

Fixed context->state bug in pseudo_html(). Fixed various rowspan=N
and colspan=N bugs.

-----------------------------------------------------------------------------

6th July 1996. Borris

Changes made to the build environment. The different programs that can
be compiled have been enumerated. A program that lies between the
complete application (STBWEB or FRESCO) and the stand alone HTML
checker (HTMLCHECK) has been introduced (BUILDERS). This new target is
the SGML parser and the HTML builders, and allows stand alone testing
of the rid_ structure building. Control of the variant being built has
been tightened up so that a -DDEVELOPMENT=N (N=0,1,2) parameter is
supplied to the program to control all debugging. One of FRESCO,
STBWEB, HTMLCHECK or BUILDERS will be defined to indicate which
program is being built. One of RISCOS or UNIX will be defined to
identify the operating system being compiled for. Not all possible
combinations are supported. A very simple RISC_OSLib compatibility
library has been written.

A number of different programs can be compiled. Two operating systems
are supported. The following identify the variants supported:

FRESCO-RISCOS: fr
	The original, for RISC OS, cross-compiled.

STBWEB-RISCOS: sr
	Set top box, for RISC OS, cross-compiled

HTMLCHECK-RISCOS: hr
	CLI utility to check and correct HTML, for RISC OS, cross compiled.

BUILDERS-RISCOS: br
	CLI utility to test the backend builders (ie a debugging tool)
for RISC OS, cross compiled.

HTMLCHECK-UNIX: hu
	A unix natively built version of HTMLCHECK

BUILDERS-UNIX: bu
	A unix natively built version of BUILDERS

MOST-UNIX: mu
	Compile natively to perform syntax checks, but not attempt to
link any form of executable.

ID	Built-from	Left-in

br	builders	builders
bu	bunix		bunix
fr	fresco		!Fresco
hr	hriscos		hriscos
hu	stdalone	stdalone
mu	unix		N/A
sr	stbweb		!STBWeb

(Sorry for the horrible directories, but we've got some historical
layout and now isn't the time to start monkeying with it.)

Program symbols: FRESCO, STBWEB, HTMLCHECK, BUILDERS, MOST
OS symbols: RISCOS, UNIX

Many table bugs have been removed. Automatic insertion of <TR> to
handle full rows has been added. Recursion doesn't stomp on existing
attributes - a new VALUES is allocated from the stack. This makes
coding easier, less heap traffic and means the state the attributes
are left in doesn't matter (apart from secondary freeing).

-----------------------------------------------------------------------------

5th July 1996. Borris

Made <P> move down an empty line as well as forcing a line break (well
- forces two consecutive line breaks actually). Ensure automatic
insertion of <HTML> by unexpected characters gets cancelled by
<HTML>. Made <STYLE> a "flag no text" element. Changed attrgen.py to
not convert the case of enumerations, so, eg we can have
HTML_LI_OLTYPE_A and HTML_LI_OLTYPE_a defined. attrgen.py will give a
warning when non-upper-case enumerations are encountered during
parsing. More syntax to attrconf - lines starting with a dollar are
magic lines. So far, only $E is defined. This echoes the remainder of
the line to stdout. #if 0'd all the elements no longer being used (ie
those warning of no external declaration).

-----------------------------------------------------------------------------

5th July 1996. Borris

Operating from:

	cvs checkout -D "7/4/96 15:20:00" fresco

as a time, then SI_960704_POINT as a tag on the main trunk and then
SI_960704_POINT_BRANCH as a branch from the trunk. stbweb/Makefile is
missing and Si needs to send me a copy. fresco/Makefile got too
complicated for patch and I need to send Si a new entire
file. fresparse/genproc.c also got too much for patch and I need to
send Si a new entire file.

-----------------------------------------------------------------------------

4th July 1996. Borris

Eventually, branch SI_960704_BRANCH tagged. Needs making into a branch
and getting a checkin so we can work against it. Made a DIST target
to make a distribution release.

-----------------------------------------------------------------------------

3rd July 1996. Borris

Merged in SI_960702_BRANCH branch and Si's patches back into main branch.
Tagged this point as SI_960703_BRANCH, ready for next merge.

-----------------------------------------------------------------------------

3rd July 1996. Borris

Auto open TEXT now works. Nicko's floating image changes and formatting
bug corrections merged. Prior to merging with Si's recent changes.

-----------------------------------------------------------------------------

2nd July 1996. Borris

Auto open HTML now works. Fixed OPTION bug. Tidied up forms a little more.

-----------------------------------------------------------------------------

1st July 1996. Borris

Fixed bug stopping anything working - sgmlctx->report.output needed to
hold a valid FILE* for printing parser information.

-----------------------------------------------------------------------------

30th June 1996. Borris.

Corrected and enabled table alignment setting code. Fixed bug in
<COLGROUP> in attrconf and associated elements.c
code. html/regtests/in/tables1.html now emits the expected
values. Added more regtest entries. Checked them against the
parser. Fixed some bugs as a result. Made printing of attributes in
htmlcheck more regular (%-N to left-align). Moved order preserving
attribute printing from htmlcheck into mainline browser code. Unified
generic_start() and generic_finish(). This might want undoing at some
stage? Added open_within_container() routine to apply as a restrictive
check when implicitly closing elements. Fixes this sort of problem:

Input: <DIV> <TABLE> <DIV> </TABLE>
Buggy: <DIV> <TABLE> </TABLE> </DIV>
Fixed: <DIV> <TABLE> <DIV> </DIV> </TABLE> </DIV>

Generated test cases to catch these. Prototyped auto <BODY> on
unexpected characters in htmlcheck. Seems to behave sensibly with
documents where one would expect it to. Updated some test to use
BGCOLOR attribute instead of BACKGROUND as I was mistakenly using.

Added match_perm_text mode where no markup can ever be
recognised. Used for parsing text files - these now have <BODY><PRE>
at their start implicitly. Made non-whitespace unexpected characters
cause <BODY> to appear - automatic document open, in effect. Assume if
not got markup first, then won't be expecting the <HEAD> section.

-----------------------------------------------------------------------------

28th June 1996. Borris

Merged SI_960625_BRANCH changes back into SI_960625_MERGED2. Lots of minor
changes to various files by various people to improve things.

-----------------------------------------------------------------------------

26th June 1996. Borris

Style tags need a better default - current value of zero clashes with the
first item in each enumeration! Gone back to having enumerations for attributes
 starting at one.

-----------------------------------------------------------------------------

26th June 1996. Borris

Merged in Si's latest changes and did a cvs export to give Si a source
tree to work with. Fixed bug in the reading of table borders. Started
looking and column groups again.  Started doing line gathering for
<TEXTAREA>. Changes rid_textarea_line to use STRING and not
char*. This permits the allocation from the chopper to be the final
allocation. Done <OPTION>. Done <TEXTAREA>. Improved flexibility of
nesting of elements to support "user level not valid" and "internal
level mandatory" closing of elements (eg <OPTION>).

-----------------------------------------------------------------------------

25th June 1996. Borris

Made some printf()s happier about argument types. Changed all C++ comments
into C comments. For reference, the regexps are:

//\(.*\)$
/\*\1\ */

Made the rest of the printf()s happy. Sorted out virtually all external
function references, etc.

Wrote some HTML to test colspan=0 and rowspan=0 after encountering some
such examples on the net. It is important that each of these tests can be
handled - each has the potential to spin.

Added WIDTH and HEIGHT attribute for table cells. The width is returned via
rid_getprop() as normal. There might be some nasty repurcusions of this,
which we'll have to look for. The height of a text stream is increased if
necessary to meet the (minimum) height specified for any <TD HEIGHT=N>
cells.

Changed element named searching to use bsearch() rather than linear
search for performance reasons. Verified with test suite as exists.

-----------------------------------------------------------------------------

24th June 1996. Borris

Merged in Nicko's changes. Finished removing warnings about
int/long/ptr etc.  Added more extern definitions for external
functions. Made lots of files include the header files that define
their externals - otherwise could easily have total disagreement about
parameters and yet think everything is fine. This was obviously an
oversight on someones part (far too many times as well :-(((( YUCH!!).
Updated dump.c to provide a bit more information.

-----------------------------------------------------------------------------

24th June 1996. Borris

Merge of Nicko's merged source tree performed and checked in. Performing the
necessary changes to make compilation succeed. The new meta_info list stuff
has been transplanted. Went through and put extra casts to long into the
source so that gcc on a 64 bit platform doesn't produce loss-of-information
warnings when casting pointers to ints and vice versa. Ideally, all such
numeric types involved would be long as a matter of course, but the
definitions of os_swix et al make this not such a trivial matter.

-----------------------------------------------------------------------------

18th June 1996. Borris

Fixed bug in sgml_free_context() whereby context->tos was not set to NULL
and freed memory got reused - symptom: second page virtually always failed
with an assertion check.

The first attribute of elements after <IMG> was not being recognised. Due
to spuriuos comma in attrconf. Got past attrgen.py because parsing accepted
empty strings when it shouldn't do. Fixed.

Made reconstruction of attributes preserve source ordering. Simplifies the
regression testing. Tried to avoid N**2 (N=20) overheads for every element
reconstructed! Fixed silly bugs in doing this.

Did a cross build with -M to collect dependency information and added
this to fresco/Makefile

-----------------------------------------------------------------------------

17th June 1996. Borris

Prior to parse_enum_void, item zero from attribute and attribute
enerations was reserved to indicate invalid. This is antiquated. Item
zero is now (again) the first attribute and the first enumerated item.
Fixed bug in enumeration parsing. Wrote html/regtests/tests python
program. Starting filling in some test cases.

-----------------------------------------------------------------------------


