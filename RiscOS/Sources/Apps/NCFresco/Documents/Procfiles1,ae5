
import os,string,sys

tempfile="<Wimp$ScrapDir>.ProcFiles"

cfsi_opts = '-nomode -noscale -nosize'
cfsi_mode = '28'
cfsi_name = 'p'+cfsi_mode

def convert_to_sprite(dir, file, do_buttons, output_dir):
	f,e = os.path.splitext(file)
	f = string.upper(f)
	button = 1
	if f[:7] == 'ANIMBLU':
		name = 'animhl0' + f[7:]
	elif f[:6] == 'ANIMBL':
		name = 'animhl' + f[6:]
	elif f[:7] == 'ANIMGRA':
		name = 'animuhl0' + f[7:]
	elif f[:6] == 'ANIMGR':
		name = 'animuhl' + f[6:]
	elif f[-2:] == 'HL':
		name = string.lower(f)
	else:
		name = string.lower(f)
		button = 0

	if output_dir == '':
		output = tempfile
	else:
		output = os.path.join(output_dir, name)

	if (do_buttons and button) or (not do_buttons and not button):
		s = '/<changefsi$dir>.changefsi '+os.path.join(dir, file)+' '+output+' '+cfsi_mode+' '+cfsi_opts
		print s + ' rename to '+name
		os.system(s)
		if os.path.exists(output):
			if output_dir <> '':
				os.system('smerge '+tempfile)
				os.unlink(tempfile)
				os.system('srename '+cfsi_name+' '+name)
		else:
			print file+' couldn\'t be processed'
	else:
		print 'skipping '+f

def process_dir(dir, do_buttons, output_dir):
	files = os.listdir(dir)
	for file in files:
		convert_to_sprite(dir, file, do_buttons, output_dir)

def usage():
    print 'Usage: procfiles1 <dir in> <file out> [buttons]'
    print __doc__
    sys.exit(1)

def main(argv):
    if len(argv) < 3 or len(argv) > 4:
        usage()

    os.system('changedynamicarea -spritesize 2048k')
    os.system('snew')

    if len(argv) == 4 and string.lower(argv[3]) == 'buttons':
	    do_buttons = 1
    else:
	    do_buttons = 0

    if os.path.isdir(argv[2]):
	    process_dir(argv[1], do_buttons, argv[2])
    else:
	    process_dir(argv[1], do_buttons, '')
	    os.system('ssave '+argv[2])
#	    os.system('snew')

#    os.system('changedynamicarea -spritesize 0k')

if __name__ == '__main__':
	main(sys.argv)
