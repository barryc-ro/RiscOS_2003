/*
 *
 * SetupIF.c - Daytona interface to !Setup
 *
 * R C Manby
 *
 * Started 2 October 1997
 */


#include "BuildFlags.h"
#include "SetupIF.h"
#include "functions.h"


#if SETUP_USES_MODULE
/*
 * Configuration read by a module with a SWI interface
 */
#define  SFConfigMan_Read	0x50a40
static int SetupIF_Read_Field(char *tag, char *result_buffer, int size);
#endif


static void show_string(const char *name, const char *value);


unsigned int eeprom_serial_number = 0;	/*>>>must set this up properly*/
unsigned int setup_version_major;
unsigned int setup_version_minor;


/* phone details */
char setup_external_access_code[8];	/* aka outside line prefix */
char setup_international_access_code[8];
char setup_national_access_code[8];
char setup_fax_country_code[12];
char setup_fax_area_code[12];
char setup_fax_number[32];
char setup_voice_country_code[12];
char setup_voice_area_code[12];
char setup_voice_number[32];
int  setup_phone_fax_redial_count = 2;		/* NB MUST be >= 0 */	/*>>>Not yet read from setup*/
int  setup_configured_routing = 0;	/*0=email, 1=phone*/
char setup_configuredNAN[30]  = { "100" };							/*>>> hardwire the NAN string for now */



/* email details */
char setup_ISP_PhoneNumber[30] = { 0 };	/* eg "7108" passed with SQ_RX_DIAL_ISP */
int  setup_ISP_PrimaryRedialCount = 3;								/*>>>Not yet read from setup*/

#if SUPPORT_LAN
int setup_Ether_Lan = 1;    /* will be read from configuration */
#else
int setup_Ether_Lan = 0;	/* NOT read and MUST be zero */
#endif

/* for sendmail */
char setup_from_mailaddress[256] = { 0 };	/* eg "RManby@Acorn.com" passed to MimeIF_create_RFC822_msg & SmtpIF_SendMail */
char setup_contact_name[256] = { 0 };
char setup_company_name[256] = { 0 };

char setup_smtp_server[256] = { 0 };        /* eg "rwarren.acorn.co.uk" passed to SmtpIF_SendMail */
char setup_domainname[256] = { 0 };        /* eg "acorn.co.uk" passed to MimeIF_create_RFC822_msg */

/* for POP3 */
char setup_pop3_server[256] = { 0 };        /* eg "rwarren.acorn.co.uk" passed to Pop3IF_Logon */
char setup_username[64] = { 0 };           /* eg "daytona" passed to Pop3IF_Logon */
char setup_password[64] = { 0 };           /* eg "FenTax" passed to Pop3IF_Logon */

char setup_iap_username[256] = { 0 };


int g_missing_page_threshold = 3;								/*>>>Not yet read from setup*/


#if SETUP_USES_MODULE
static int SetupIF_Read_Field(char *tag, char *result_buffer, int size)
{
  _kernel_oserror	*er;
  _kernel_swi_regs	regs;
  
  /* Load in the relevant tag values and return in the result buffer */
  regs.r[0] = (int)tag;
  regs.r[1] = (int)result_buffer;
  regs.r[2] = size;
  er = _kernel_swi(SFConfigMan_Read, &regs, &regs);

  /* if not reading a word, terminate the string */
  if (size != 0)
  {
    if (regs.r[0] >= 0)
      result_buffer[regs.r[0]] = '\0';
  }
    
  return regs.r[0];
}
#endif


extern void SetupIF_Read_Phone_Config(void)
{
  int error;
  
/* phone details */
#if SETUP_USES_SYSVAR
    readvarval("external_access_code$setup"     , setup_external_access_code     , sizeof(setup_external_access_code));
    readvarval("international_access_code$setup", setup_international_access_code, sizeof(setup_international_access_code));
    readvarval("national_access_code$setup"     , setup_national_access_code     , sizeof(setup_national_access_code));
    readvarval("fax_country_code$setup"         , setup_fax_country_code         , sizeof(setup_fax_country_code));
    readvarval("fax_area_code$setup"            , setup_fax_area_code            , sizeof(setup_fax_area_code));
    readvarval("fax_number$setup"               , setup_fax_number               , sizeof(setup_fax_number));
    readvarval("voice_country_code$setup"         , setup_voice_country_code         , sizeof(setup_voice_country_code));
    readvarval("voice_area_code$setup"            , setup_voice_area_code            , sizeof(setup_voice_area_code));
    readvarval("voice_number$setup"               , setup_voice_number               , sizeof(setup_voice_number));
#endif

#if SETUP_USES_MODULE
  error = SetupIF_Read_Field("OutsideLineCode", setup_external_access_code, sizeof(setup_external_access_code));
  error = SetupIF_Read_Field("InternationalAccessCode", setup_international_access_code, sizeof(setup_international_access_code));
  error = SetupIF_Read_Field("NationalAccessCode", setup_national_access_code, sizeof(setup_national_access_code));
  error = SetupIF_Read_Field("FaxCountryCode", setup_fax_country_code, sizeof(setup_fax_country_code));
  error = SetupIF_Read_Field("FaxAreaCode", setup_fax_area_code, sizeof(setup_fax_area_code));
  error = SetupIF_Read_Field("FaxNumber", setup_fax_number, sizeof(setup_fax_number));
  error = SetupIF_Read_Field("VoiceCountryCode", setup_voice_country_code, sizeof(setup_voice_country_code));
  error = SetupIF_Read_Field("VoiceAreaCode", setup_voice_area_code, sizeof(setup_voice_area_code));
  error = SetupIF_Read_Field("VoiceNumber", setup_voice_number, sizeof(setup_voice_number));
  error = SetupIF_Read_Field("NANtoken", setup_configuredNAN, sizeof(setup_configuredNAN));
#if 1
  error = SetupIF_Read_Field("DefaultRoute", (char *)&setup_configured_routing, 0);
#endif
#endif
}

extern void SetupIF_Read_Email_Config(void)
{
	int  error;
    char buffer[32];

    readvarval("version$major", buffer, sizeof(buffer));
    setup_version_major = atoi(buffer);
    readvarval("version$minor", buffer, sizeof(buffer));
    setup_version_minor = atoi(buffer);

#if SETUP_USES_SYSVAR
    readvarval("contact_name$setup", setup_contact_name, sizeof(setup_contact_name));
    readvarval("company_name$setup", setup_company_name, sizeof(setup_company_name));


    readvarval("primary_phone$setup", setup_ISP_PhoneNumber , sizeof(setup_ISP_PhoneNumber));

	readvarval("pop3_email$setup"   , setup_from_mailaddress, sizeof(setup_from_mailaddress));
	readvarval("smtp_server$setup"  , setup_smtp_server      , sizeof(setup_smtp_server));
    readvarval("Inet$LocalDomain"   , setup_domainname      , sizeof(setup_domainname));

	readvarval("pop3_server$setup"  , setup_pop3_server      , sizeof(setup_pop3_server));
    readvarval("pop3_username$setup"      , setup_username        , sizeof(setup_username));
    readvarval("pop3_password$setup"      , setup_password        , sizeof(setup_password));

    readvarval("isp_username$setup" , setup_iap_username     , sizeof(setup_iap_username));
#endif

#if SETUP_USES_MODULE
    error = SetupIF_Read_Field("ContactName", setup_contact_name, sizeof(setup_contact_name));
    error = SetupIF_Read_Field("CompanyName", setup_company_name, sizeof(setup_company_name));
    
    error = SetupIF_Read_Field("PrimaryPhone", setup_ISP_PhoneNumber, sizeof(setup_ISP_PhoneNumber));	/*>>>RCM wonders if reading ints works*/
#if 1
    error = SetupIF_Read_Field("RedialCount", (char *)&setup_ISP_PrimaryRedialCount, 0);                /*>>>we had problems when dedugging ConfiguredNAN reading*/
#if SUPPORT_LAN
     error = SetupIF_Read_Field("EtherLan", (char*)&setup_Ether_Lan, 0);
#endif
#endif
    error = SetupIF_Read_Field("POP3mailbox", setup_from_mailaddress, sizeof(setup_from_mailaddress));
    error = SetupIF_Read_Field("SMTPHost", setup_smtp_server, sizeof(setup_smtp_server));
    error = SetupIF_Read_Field("LocalHost", setup_domainname, sizeof(setup_domainname));
    
    error = SetupIF_Read_Field("POP3Host", setup_pop3_server, sizeof(setup_pop3_server));
    error = SetupIF_Read_Field("POP3UserId", setup_username, sizeof(setup_username));
    error = SetupIF_Read_Field("POP3Password", setup_password, sizeof(setup_password));
    
    error = SetupIF_Read_Field("UserId", setup_iap_username, sizeof(setup_iap_username));
#endif
}


/*
 * Write entire configuration to the LogFile
 */
void SetupIF_Log_Configuration()
{
   show_string("OutsideLineCode", setup_external_access_code);
   show_string("InternationalAccessCode", setup_international_access_code);
   show_string("NationalAccessCode", setup_national_access_code);
   show_string("FaxCountryCode", setup_fax_country_code);
   show_string("FaxAreaCode", setup_fax_area_code);
   show_string("FaxNumber", setup_fax_number);
   show_string("VoiceCountryCode", setup_voice_country_code);
   show_string("VoiceAreaCode", setup_voice_area_code);
   show_string("VoiceNumber", setup_voice_number);
   show_string("NANtoken", setup_configuredNAN);
#if 0
   show_number("DefaultRoute", setup_configured_routing);
#endif

    show_string("ContactName", setup_contact_name);
    show_string("CompanyName", setup_company_name);
    
    show_string("PrimaryPhone", setup_ISP_PhoneNumber);
/*>>>    show_number("RedialCount", setup_ISP_PrimaryRedialCount);*/
    
    show_string("POP3mailbox", setup_from_mailaddress);
    show_string("SMTPHost", setup_smtp_server);
    show_string("LocalHost", setup_domainname);
    
    show_string("POP3Host", setup_pop3_server);
    show_string("POP3UserId", setup_username);
    show_string("POP3Password", setup_password);
    
    show_string("UserId", setup_iap_username);

}


static void show_string(const char *name, const char *value)
{
	char buffer[256];

    sprintf(buffer, "%s is '%s'", name, value);
    LogFileIF_Message(buffer);
}


/* end of SetupIF.c */
