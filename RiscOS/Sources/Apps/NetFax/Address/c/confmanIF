/* confmanIF.c */

#include "include.h"
#include "tbox.h"
#include "strings.h"
#include "addrbookIF.h"
#include "search.h"
#include "confmanIF.h"
#include "globals.h"
#include <time.h>

int confmanIF_message_handler (WimpMessage *message, void *handler)
{
  DayCas_Export *conf_message;
  AddressRecord rec;
  AddressArea *area;

  IGNORE (handler);

  dprintf (("", "Got a message from AdminUpdate\n"));

  conf_message = (DayCas_Export *) message;

  if (memcmp (conf_message->tag, "ADDR", 4) == 0)
  {
    if (memcmp (conf_message->cmd, "WIPE", 4) == 0)
    {
      /* Purge address book */
    }
    else if (memcmp (conf_message->cmd, "SAVE", 4) == 0)
    {
      /* Save address book */
    }
    else if (memcmp (conf_message->cmd, "NEW", 3) == 0)
    {
      /* Add / Update an address book entry */

      dprintf (("", "Message was ADDR-NEW\n"));

      /* Copy the record out of the dynamic area */
      area = (AddressArea *) conf_message->addrdata;

      dprintf (("", "area->creation_date = %p\n", area->creation_date));

#ifdef DEBUGLIB
      {
        int i;
        for (i = 0; i < 8; i++)
          dprintf (("", "area->creation_date[%d] = 0x%x\n", i,
                    area->creation_date[i]));
      }
#endif

      if (strlen (area->creation_date))
        memset (rec.creation_date, 0xFF, sizeof (rec.creation_date));
      else
      {
        char date[9];
        struct tm *t;
        time_t tim;

        tim = time (NULL);
        t = localtime (&tim);

        strftime (date,  9, "%Y%m%d", t);

        dprintf (("", "Date = %s\n", date));

        memcpy (rec.creation_date, date, sizeof (rec.creation_date));
      }

      memcpy (rec.machine_id, area->machine_id,
              sizeof (rec.machine_id));
      strcpy (rec.fax_number, area->fax_number);
      strcpy (rec.voice_number, area->voice_number);
      strcpy (rec.software_revision, area->software_revision);
      rec.device_class = area->device_class;
      rec.encryption_method = area->encryption_method;
      rec.encryption_revision = area->encryption_revision;
      rec.pgp_key_length = area->pgp_key_length;
      rec.company_name = area->company_name;
      rec.contact_name = area->contact_name;
      rec.email_address = area->email_address;
      rec.pgp_key = area->pgp_key;
      rec.routing_override = RoutingOverride_Default;

      /* Start the update search */
      search_update_searchstart (&rec, AddressModify_ActionCode_Update);

      /* Tell SFConfigMan to free its dynamic area */
      _swix (SFConfigMan_Free, _IN(0), area);
    }
  }

  return 1;
}
