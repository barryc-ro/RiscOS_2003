#include "iso10646.h"

#ifndef encoding_H
#define encoding_H

/*
 * An Encoding structure provides a uniform interface to a document
 * encoding (such as ISO 8859/1, Shift-JIS, KSC 5601-1987), with
 * utilities for conversion to and from UTF-8 and UCS-4.
 */
typedef struct Encoding
{
    /*
     * read processes the next part of a stream. s points to the data, which
     * is n bytes long. For each UCS character found, ucs_out() will be called
     * with the character code and the value passed in handle.
     * It will cope correctly with multi-byte codes split across two calls.
     * ucs_out() may return non-zero to indicate that decoding should stop.
     * The function returns the number of bytes read - this will equal n unless
     * ucs_out() signals early termination.
     */
    unsigned int (*read)(struct Encoding *e,
                         int (*ucs_out)(void *, UCS4),
                         const char *s,
                         unsigned int n,
                         void *handle);

    /*
     * reset_decoder() resets the decoder to its default state. Some encodings
     * have state (eg ISO 2022's character set and UCS-2's byte ordering) - this
     * will reset to allow a stream to be rescanned or a new stream to be
     * decoded.
     */
    void (*reset_decoder)(struct Encoding *);

    /*
     * The following are for internal use only.
     */
    int ws_size;
    void (*delete)(struct Encoding *);
    void (*enable_iso2022)(struct Encoding *);

} Encoding;

/*
 * To obtain a new decoder session, use the following calls.
 *
 * new_encoding takes an encoding number. These numbers are Internet MIB numbers.
 */
Encoding *new_encoding(int n);

/*
 * When a decoding session has finished, call delete_encoding to free up the Encoding
 * structure and other associated workspace.
 */
void delete_encoding(Encoding *e);

/*
 * Given a MIME charset name (terminated by a character not valid in a MIME
 * charset name, so a direct pointer into the Content-Type header field will do),
 * this returns the encoding number (the Internet MIB coded value if assigned).
 * This number can be passed to new_encoding(). If the name is unknown or
 * unsupported, 0 is returned.
 */
int encoding_number_from_name(const char *name);

/*
 * Load a named map file into a malloc block, or return a pointer to it if in
 * ResourceFS.
 */
void *encoding_load_map_file(const char *fname);
#endif
