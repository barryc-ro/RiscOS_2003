/* misc.c */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "kernel.h"
#include "swis.h"

#include "include.h"
#include "misc.h"


/* Duplicates a string.  Returns a pointer to a malloced copy of the
   string passed as the parameter. renamed to debug_strdup to
   stop conflicts with code that also implements strdup */
char *debug_strdup (const char *to_copy)
{
  char *copy = NULL;

  if (to_copy == NULL)
    return NULL;

  copy = malloc (strlen (to_copy) + 1);
  if (!copy)
    return NULL;

  strcpy (copy, to_copy);

  return copy;
}


void misc_getenv (const char *variable, char *buffer, int buffer_size,
                  int *nbytes)
{
  if (buffer == NULL)
  {
    _kernel_swi_regs r;

     r.r[0] = (int)variable;
     r.r[1] = NULL;
     r.r[2] = -1;
     r.r[3] = 0;
     r.r[4] = 0;

     _kernel_swi (OS_ReadVarVal, &r, &r);

     if (nbytes != NULL)
     {
       if (r.r[2] == 0)
         *nbytes = 0;
       else
       {
         *nbytes = ~r.r[2] + 1;
         internal_dprintf (("", "buf=NULL, nbytes=%d\n", *nbytes));
       }
     }
  }
  else
  {
    int len;

    _swix (OS_ReadVarVal, _INR(0,4) | _OUT(2),
           variable, buffer, buffer_size, 0, 0,
           &len);

    buffer[len] = '\0';

    if (nbytes != NULL)
    {
      *nbytes = len + 1;
      internal_dprintf (("", "buf!=NULL, nbytes=%d\n", *nbytes));
    }
  }
}


char *misc_getenv_malloc (const char *variable)
{
  char *str;
  int len;

  misc_getenv (variable, NULL, 0, &len);

  if (len == 0)
    return NULL;
  else
  {
    str = malloc (len);
    misc_getenv (variable, str, len, &len);

    return str;
  }
}


/************************************************************************/
/* misc_ensure_module                                                   */
/*                                                                      */
/* Function checks to see if a module is loaded.  Stops debug output    */
/* going to unpredictable places.                                       */
/*                                                                      */
/* Parameters: name - Module name.                                      */
/*                                                                      */
/* Returns:    TRUE or FALSE.                                           */
/*                                                                      */
/************************************************************************/
BOOL misc_ensure_module (const char *name)
{
  _kernel_oserror	*er;
  _kernel_swi_regs	regs;

  /* Check that module is present */
  regs.r[0] = 18;
  regs.r[1] = (int) name;

  er = _kernel_swi (OS_Module, &regs, &regs);

  if (er != NULL)
  {
    /* Module not present */
    return FALSE;
  }
  else
  {
    /* Module present */
    return TRUE;
  }
}
