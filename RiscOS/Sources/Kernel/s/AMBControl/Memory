; > s.Memory

; Small veneer between AMBControl's memory block requirements and OS_Heap,
; using system heap. This is changed since Ursula - used to call OS_Module
; and claim blocks from RMA, which is an anachronism since code is in
; the kernel.

; quantise sizes to reduce heap stress
;
AMBblockQ  * 64


;in:  r3=size
;out: r2 -> block, r0 corrupted
;
AMB_BlockClaim ROUT
        Push    "r1,r3,lr"
        ADD     r3,r3,#AMBblockQ - 1
        BIC     r3,r3,#AMBblockQ - 1 
        BL      ClaimSysHeapNode
        Pull    "r1,r3,pc"

;in:  r2 -> block
;out: r0 corrupted
;
AMB_BlockFree ROUT
        Push    "r1,lr"
        BL      FreeSysHeapNode
        Pull    "r1,pc"

;in:  r2 -> block, r3 = new size
;out: r2 -> new block, r0 corrupted
;
AMB_BlockResize ROUT
        Push    "r1,r3,lr"
        ADD     r3,r3,#AMBblockQ - 1
        BIC     r3,r3,#AMBblockQ - 1 
        LDR     r1,[r2,#-4]                  ;pick up OS_Heap's size word (naughty!)
        SUB     r1,r1,#8                     ;heap size will be 8 more than quantised size 
        SUBS    r3,r3,r1                     ;required size change
        MOVNE   r0, #HeapReason_ExtendBlock
        BLNE    DoSysHeapOpWithExtension
        Pull    "r1,r3,pc"


        END
