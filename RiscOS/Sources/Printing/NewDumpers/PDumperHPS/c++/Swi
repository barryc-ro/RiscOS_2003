
/*****************************************************************************************/
/***                                                                                   ***/
/***  Routines.c                                                                       ***/
/***                                                                                   ***/
/***  Application:   HP Printer Dumper module (using HP SDK)                           ***/
/***                                                                                   ***/
/***                                                                                   ***/
/***  Purpose:       Contains various routines used to implement the printer dumper.   ***/
/***                                                                                   ***/
/*****************************************************************************************/


#include <stdio.h>
#include <stdlib.h>
#include "swis.h"

#include "@.HP_SDK_LIB.HPPrintAPI.h"
#include "PDumper.h"

#include "Defs.h"
#include "Debug.h"
#include "Variables.h"
#include "Swi.h"

extern "C" {
#include "modheader.h"
}


/*****************************************************************************************/
/***                                                                                   ***/
/***  PDumper_CallHandler()                                                            ***/
/***                                                                                   ***/
/***  PDumper calls all pass through this module. The reason code is in r11.           ***/
/***                                                                                   ***/
/***                                                                                   ***/
/***  Return:                                                                          ***/
/***    REASON_CODE_NOT_KNOWN                                                          ***/
/***                                                                                   ***/
/*****************************************************************************************/

_kernel_oserror *PDumper_CallHandler(_kernel_swi_regs *regs, void *pw)
{
    DRIVER_ERROR err = NO_ERROR;

    DEBUG( DebugMessageInt(">>> PDumper_CallHandler(%i)\n",regs->r[11]); )

    switch(regs->r[11])
        {
        case PDUMPER_REASON__SET_DRIVER:
            err = pPD ->PDump_SetDriver(regs);
            break;

        case PDUMPER_REASON__OUTPUT_DUMP:
            err = pPD ->PDump_Output(regs);
            break;

        case PDUMPER_REASON__COLOUR_SET:
            err = pPD ->PDump_SetColour(regs);
            break;

        case PDUMPER_REASON__START_PAGE:
            err = pPD ->PDump_StartPage(regs);
            break;

        case PDUMPER_REASON__END_PAGE:
            err = pPD ->PDump_EndPage(regs);
            break;

        case PDUMPER_REASON__START_JOB:
            err = pPD ->PDump_StartJob(regs);
            break;

        case PDUMPER_REASON__ABORT_JOB:
            err = pPD ->PDump_AbortJob(regs);
            break;

        case PDUMPER_REASON__MISC_OP:
            break;


        default:
            DEBUG( DebugMessageInt("Invalid reason code (&%2X)\n", regs->r[11]); )
            break;
        }

    DEBUG( DebugMessage("<<< PDumper_CallHandler\n"); )

    // clear the handle. There shouldn't be any calls to this module during
    // a print job that don't provide it.
    PrinterHandle = NULL_FILE_HANDLE;
    if( err != NO_ERROR )
    {
      globalError.errnum = 0;
      sprintf( globalError.errmess, "PDumper_CallHandler error %i", err );
      return &globalError;
    }
    return(NULL);
}



