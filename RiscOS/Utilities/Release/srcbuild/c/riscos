/************************************************************************/
/*                  Copyright 1996 Acorn Computers Ltd                  */
/*                                                                      */
/*  This material is the confidential trade secret and proprietary      */
/*  information of Acorn Computers. It may not be reproduced, used      */
/*  sold, or transferred to any third party without the prior written   */
/*  consent of Acorn Computers. All rights reserved.                    */
/*                                                                      */
/************************************************************************/
#include <stdio.h>
#include <string.h>
#include "kernel.h"
#include "swis.h"
#include "srcbuild.h"

/* 
 * contains all non-portable functions
 */

/* 
 * globals
 */
int  spooling=FALSE;

/* 
 * change working directory
 */
int
chdir(char *dir)
{
  _kernel_swi_regs reg;
  
  reg.r[0] = 0;
  reg.r[1] = (int)dir;
  if (_kernel_swi(OS_FSControl,&reg,&reg))
    return (-1);
    
  return (0);
}

/* 
 * make directory
 */
int
mkdir(char *dir, int mode)
{
  _kernel_swi_regs reg;
  
  reg.r[0] = 8;
  reg.r[1] = (int)dir;
  reg.r[4] = 0;
  if (_kernel_swi(OS_File,&reg,&reg))
    return (-1);
    
  return (0);
}

/* 
 * open a spool session
 */
void
spool_open(char *file)
{
  _kernel_swi_regs reg;
  char buffer[BUFFER_LEN];
  
  sprintf(buffer,"spool %s",file);
  reg.r[0] = (int)buffer;
  if (_kernel_swi(OS_CLI,&reg,&reg)==NULL)
    spooling=TRUE;
}

/* 
 * close a spool session
 */
void
spool_close(char *file)
{
  _kernel_swi_regs reg;
  FILE *fh=NULL;
  FILE *fhtmp=NULL;
  char tmp_filename[BUFFER_LEN];
  char c;
  
  if (!spooling)
    return;
  
  reg.r[0] = (int)"spool";
  if (_kernel_swi(OS_CLI,&reg,&reg))
    error(1,"cannot close spool to file '%s'",file);
    
  spooling=FALSE;
  
  reg.r[0] = 18;  	/* settype */
  reg.r[1] = (int)file;
  reg.r[2] = 0xfff;	/* text */
  if (_kernel_swi(OS_File,&reg,&reg))
    error(1,"setting type of log file '%s'.",file);
   
  if ((fh=fopen(file,"r"))==NULL)
    error(1,"cannot open log file '%s'.",file);
    
  strcpy(tmp_filename,tmpnam(NULL));
  if ((fhtmp=fopen(tmp_filename,"w"))==NULL)
    error(1,"cannot open temp log file '%s'.",tmp_filename);
    
  while (!feof(fh))
  {
    c=fgetc(fh);
    if (!feof(fh))
    {
      if (c==0x0d)
      {
        c=fgetc(fh);
        if (c!=0x0a)
          fputc(0x0d,fhtmp);
      }
      else if (c==0x0a)
      {
        c=fgetc(fh);
        if (c!=0x0d)
          fputc(0x0a,fhtmp);
        else
          c=0x0a;
      }
      fputc(c,fhtmp);;
    }
  }
  
  fclose(fh);
  fclose(fhtmp);
  
  remove(file);

  reg.r[0] = 26;		/* copy objects */
  reg.r[1] = (int)tmp_filename;
  reg.r[2] = (int)file;
  reg.r[3] = 0;/* 1<<7; */		/* delete after */
  if (_kernel_swi(OS_FSControl,&reg,&reg))
    error(1,"moving log file '%s'.",file);
}
 
/* 
 * returns 	0 - doesn't exist
 *		1 - file found
 *		2 - directory found
 */
int
file_exists(char *file)
{
  _kernel_swi_regs reg;
  
  reg.r[0] = 23; 	/* no paths */
  reg.r[1] = (int)file;
  _kernel_swi(OS_File,&reg,&reg);
  
  return (reg.r[0]);
}
