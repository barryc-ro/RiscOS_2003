/* -*-c-*- */

#include <stdio.h>
#include <setjmp.h>
#include "kernel.h"

#define FRAME_SCP 0
#define FRAME_LR -1
#define FRAME_SP -2
#define FRAME_FP -3

char *procname(int pc)
{
    unsigned int *i;
    char *name;
    
    pc &= 0x03FFFFFC;
    
    i = (unsigned int*) pc;
    
    while ((pc - ((int) i)) < 10240)
    {
	if (((*i)>>24) == 0xff)
	{
	    name = (char*) i - (*i & 0xffffff);
	    return name;
	}
	i--;
    }

    fprintf(stderr, "Failed to find name for pc=0x%08x\n", pc);

    return "<unknown>";
}


char *caller(int n)
{
    jmp_buf jb;
    int *fp;

    setjmp(jb);
    
    n++;
    
    fp = (int *) jb[6];
    
    while (n && fp)
    {
	fp = (int *) fp[FRAME_FP];
	n--;
    };
    
    if (fp)
	return procname(fp[FRAME_SCP]);
    else
	return 0;
}
