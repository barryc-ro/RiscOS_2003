; -*-As-*-
;
; $Header$
; $Source$
;
; Copyright (c) 1995 Acorn Computers Ltd., Cambridge, UK
;
; makecall.s - based upon code generated by Norcroft RISC OS ARM C
;              vsn 5.06 (Acorn Computers Ltd) [Jun 26 1995]
;
; $Log$
;
; 96/02/01 KBracey: Nasty -zm relocation bug fixed
;
; Revision 1.1  95/08/17  18:42:27  kwelton
; Initial revision
;

	AREA |As$$code|, CODE, READONLY
	IMPORT	_kernel_swi

;
; **********************************************************************
;
; makecall - call the Internet module, and deal with the return value
;
; int _makecall(int swinum, _kernel_swi_regs *in, _kernel_swi_regs *out)
;
	EXPORT	_makecall
_makecall
	MOV	ip, sp
	STMDB	sp!, {v1-v3, fp, ip, lr, pc}
	SUB	fp, ip, #4

;
; make the SWI call, result into v3, setting Z flag in the process
;
	MOV	v1, a3
	BL	_kernel_swi
	MOVS	v3, a1

	LDR	lr, adrerrno
	LDR	ip, [sl, #-536]
	ADD	lr, ip, lr				; -zM manipulation

	MOVEQ	a1, #0
	STREQ	a1, [lr, #0]
	BEQ	OKreturn

;
; SWI call failed - fill in errno, and copy error block into _inet_error
; first step is to read the error number, and decide whether it is a
; properly formatted inet error (inet errorblock should start at 0x20e00,
; but it currently starts at 0 because of all the applications out there
; that expect this to be the case).
;
	LDR	a1, [v3, #0]
	BIC	a2, a1, #&ff
	SUB	a4, a2, #&20c00
	TEQ	a4, #&200
	BNE	noerrblock

;
; using inet error block: offsets 0-7f should be converted to an errno
; style number, other errors should be left alone.
;
	AND	a2, a1, #&ff
	CMP	a2, #&80
	ANDLT	a1, a1, #&7f

noerrblock
	STR	a1, [lr, #0]
	LDR	v2, adr_inet_error
	ADD	v2, ip, v2				; -zM manipulation

;
; copy error block into _inet_error which is 256 bytes long
;
	MOV	ip, #&2

0
	LDMIA	v3!, {a1-a4}
	STMIA	v2!, {a1-a4}
	LDMIA	v3!, {a1-a4}
	STMIA	v2!, {a1-a4}
	LDMIA	v3!, {a1-a4}
	STMIA	v2!, {a1-a4}
	LDMIA	v3!, {a1-a4}
	STMIA	v2!, {a1-a4}
	LDMIA	v3!, {a1-a4}
	STMIA	v2!, {a1-a4}
	LDMIA	v3!, {a1-a4}
	STMIA	v2!, {a1-a4}
	LDMIA	v3!, {a1-a4}
	STMIA	v2!, {a1-a4}
	LDMIA	v3!, {a1-a4}
	STMIA	v2!, {a1-a4}
	SUBS	ip, ip, #1
	BNE	%b0

;
; if( errno > EREMOTE )
;     errno = ESRCH;
;
	CMP	a1, #&47
	MOVGT	a1, #3
	STRGT	a1, [lr, #0]

;
; return error to caller
;
	MVN	a1, #0
	LDMDB	fp, {v1-v3, fp, sp, pc}^

;
; return to caller
;
OKreturn
	LDR	a1, [v1, #0]
	LDMDB	fp, {v1-v3, fp, sp, pc}^

adrerrno
	DCD	errno
adr_inet_error
	DCD	_inet_error

; **********************************************************************

	AREA |As$$data|, DATA

	EXPORT	errno
errno
	DCD	&00000000

	EXPORT	_inet_error
_inet_error
	DCD	&00000000
	%	252

	END

; EOF makecallzm.s
