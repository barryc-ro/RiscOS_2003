<html>
<head><title>srcbuild workpackage</title></head>
<body BGCOLOR="#ffffff">

<center><h1>srcbuild workpackage</h1></center>

<hr>

<center>
<table border="0" width="40%">
<tr><td>Project:	<td>Renaissance
<tr><td COLSPAN=2>$Revision$
<tr><td COLSPAN=2>$Date$
<tr><td>Author(s):	<td><a href="mailto:rbuckley">Rich Buckley</a>
</table>
</center>
<a name="contents"><hr></a>
<TABLE BORDER=0 WIDTH="100%">
<TR><TD WIDTH="8%">1.0	<TD><A HREF="#overview">Overview </A>
<TR><TD>2.0	<TD><A HREF="#outstanding">	Outstanding issues </A>
<TR><TD>3.0	<TD><A HREF="#background">	Background </A>
<TR><TD>4.0	<TD><A HREF="#implementation">	Implementation </A>
<TR><TD>5.0	<TD><A HREF="#timescales">	Timescales </A>
<TR><TD>6.0	<TD><A HREF="#history">		History </A>
</table>
<hr>

<h2> <a name="overview" href="#contents">Overview </a> </h2>
<p>
This workpackage is a result of build nightmares encountered by Neil and
myself during the recent NC projects. Comments and suggestions are welcome,
especially from people who know the build process.

<h2> <a name="outstanding" href="#contents">Outstanding issues </a> </h2>
<p>
Items highlighted <em>like this</em> are subject to discussion and or change.
<p>
srcbuild user instructions.
<p>

<h2> <a name="background" href="#contents">Background </a> </h2>
<p>
The current RISC OS ROM build process relies on the following  :
<ul>
<li> <b>!Env</b> - establish hardware and software targets, image size,
locale and keyboard.
<li> <b>BuildSys</b> - components file, "what goes in the ROM" plus a load of
awk and takobey scripts (eg !MkRom).
<li> <b>Make</b> - the overall build process is run via make.
</ul>
<p> The build process currently follows the pattern given below.
<ol>
<li> Run the appropriate <b>!Env</b> file.
<li> Edit the <b>Components</b> file with your BuildSys directory.
<li> Run <b>!Config</b>, which runs make which runs awk to produce the files
  <ol type="a">
    <li> <b>Makefile</b> - top level ROM makefile
    <li> <b>ROMImage.ForBigSplt</b> - data used by BigSplit to glue a ROM together
    <li> <b>ROMImage.Makefile</b> - makefile for the module link phase
  </ol>
<li> Invoke the appropriate build via a taskobey eg <b>!MkNewRes</b>.
</ol>
<p>
The following observations can be drawn from this process.
<ul>
<li> About 95% of the information contained in the !Env files is common
across all builds (paths, aliases,etc). This has recently been tidied up such
that all core information is sourced from a common file !Common.

<li> Many of the files contained in the BuildSys directories are static and
could be shared across all builds.

<li> The process of generating a log file is not automated or forced.

<li> The process of naming/versioning a final image is not automated.

<li> It is very difficult to pass down flags or options to a module to modify
its behaviour. eg telephone number to put in ROM.

<li> The BigSplit program is written in basic and requires a large DIM to
contain the entire ROM image. This is not practical for 8Mb+ image sizes.
This has recently been fixed by re-writing it in C (BigSplit2).

<li> It is often easy to modify the components file and forget to run
!Config, resulting in an image not reflecting the components file.

<li> A large percentage of information contained in the components file is
duplicated across every build (location of module within the build tree,
location of final module image, module type). If any of this information was
to change, the same change would have to be made in numerous different
places.

<li> awk under RISC OS is not 100% stable with execution aborts often
occuring.

</ul>

<h2> <a name="implementation" href="#contents">Implementation</a></h2>
<p>
<h3> Language </h3>
<p>
It has been decided that make is not flexible enough to act as a top level
build orchestrator. Ideally a replacement would be written in perl but there
is some concern over the reliability of RISC OS perl. The compromise solution
is to write an application in C (written with portability in mind) which will
perform the top level build scheduling required. Such an application should be
able to address many of the points covered above.
<p>
<h3> Log files </h3>
<p>
Log files be will automatically generated and saved for each build. The
filename for these files will be given by an entry in the components file.
This maybe an environment variable that has been assigned a value by another
program/script.
<p>
<h3> Final images </h3>
<p>
The final image will be named using another name specified in the components
file. This may or may not be the same as the log filename. Again, environment
variables will be used, allowing another program/script to generate them. 
<p>
<h3> Components </h3>
<p>
Since much of the information in the components file is common across all
builds, make it common. A single file will therefore be kept in a central
place providing a lookup from module name to path and type (C/Asm). The
following file format will be used :
<p>
<blockquote>
<pre>
# lines starting with the '#' character will be treated as 
# comments and ignored.
&lt;module name&gt;	&lt;module src path&gt;	&lt;output path&gt;	&lt;type&gt;
</pre>
</blockquote>
All <code>&lt;output path&gt;</code> strings will be prefixed with the environment
variable <code>&lt;Build&gt;</code>. Possible options for the type field are <code>
EXP, C, ASM, RES</code>, the same as in the old world. An example may look like this.
<blockquote>
<pre>
# Example entry for the FileCore module.
FileCore	FileSys.FileCore	OS_Core		ASM
</pre>
</blockquote>
<p>
The build specific components file will then consist of a list of modules
along with any options that should be passed down to the build of that
module. This file will be read in directly by the srcbuild application
therefore require no pre-processing before it can be used. 
<p>
The ability to include other component files will be allowed in order for a
core build to be used as a baseline for actual products which can add or
remove modules as requred. This would also allow baseline module options to be
overridden by new options.
<p>
The format of the build specific components file (taking into consideration
the points above) will therefore be as follows :
<p>
<blockquote>
<pre>
# lines starting with the '#' character will be treated as 
# comments and ignored.

# zero or more include lines, each successive include, overiding previous info
include &lt;file to include&gt;

# compulsory log and image filenames (may be environment variables)
log   &lt;log filename&gt;
image &lt;image filename&gt;

# one or more modules to include in the ROM.
&lt;module name&gt; &lt;module options&gt;
</pre>
</blockquote>
<h3> Invoking a build </h3>
<p>
The !Env file sets enough environment variables to be able to deduce the
build target and hence the components file to be used. A number of taskobey
files will exist at the top level which allow the various build phases to be
invoked for the given !Env.
<p>


<h2> <a name="timescales" href="#contents">Timescales</a></h2>
<p>
The timescales for implementing the <em>srcbuild</em> application are approximately 2 days.


<h2> <a name="history" href="#contents"> History </a> </h2>
<p>

<pre>
$Log$
Revision 1.1  1997/08/18 12:32:14  rbuckley
Written and commit before first review.


</pre>
</body>
</html>